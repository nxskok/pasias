<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 17 Tidying data | Problems and Solutions in Applied Statistics</title>
  <meta name="description" content="A set of problems and solutions, in R, on various parts of applied statistics" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 17 Tidying data | Problems and Solutions in Applied Statistics" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://ritsokiguess.site/pasias" />
  
  <meta property="og:description" content="A set of problems and solutions, in R, on various parts of applied statistics" />
  <meta name="github-repo" content="nxskok/pasias" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 17 Tidying data | Problems and Solutions in Applied Statistics" />
  
  <meta name="twitter:description" content="A set of problems and solutions, in R, on various parts of applied statistics" />
  

<meta name="author" content="Ken Butler" />


<meta name="date" content="2021-05-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="a-comparison-of-four-shampoos-in-treating-dandruff.html"/>
<link rel="next" href="simple-regression.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Problems and Solutions in Applied Statistics</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#packages-used-somewhere-in-this-book"><i class="fa fa-check"></i>Packages used somewhere in this book</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="getting-used-to-r-and-r-studio.html"><a href="getting-used-to-r-and-r-studio.html"><i class="fa fa-check"></i><b>1</b> Getting used to R and R Studio</a></li>
<li class="chapter" data-level="2" data-path="reading-in-data.html"><a href="reading-in-data.html"><i class="fa fa-check"></i><b>2</b> Reading in data</a></li>
<li class="chapter" data-level="3" data-path="drawing-graphs.html"><a href="drawing-graphs.html"><i class="fa fa-check"></i><b>3</b> Drawing graphs</a></li>
<li class="chapter" data-level="4" data-path="data-exploration.html"><a href="data-exploration.html"><i class="fa fa-check"></i><b>4</b> Data exploration</a></li>
<li class="chapter" data-level="5" data-path="working-with-dataframes.html"><a href="working-with-dataframes.html"><i class="fa fa-check"></i><b>5</b> Working with dataframes</a></li>
<li class="chapter" data-level="6" data-path="one-sample-inference.html"><a href="one-sample-inference.html"><i class="fa fa-check"></i><b>6</b> One-sample inference</a></li>
<li class="chapter" data-level="7" data-path="two-sample-inference.html"><a href="two-sample-inference.html"><i class="fa fa-check"></i><b>7</b> Two-sample inference</a></li>
<li class="chapter" data-level="8" data-path="power-and-sample-size.html"><a href="power-and-sample-size.html"><i class="fa fa-check"></i><b>8</b> Power and sample size</a></li>
<li class="chapter" data-level="9" data-path="the-sign-test.html"><a href="the-sign-test.html"><i class="fa fa-check"></i><b>9</b> The sign test</a></li>
<li class="chapter" data-level="10" data-path="mood-median-test.html"><a href="mood-median-test.html"><i class="fa fa-check"></i><b>10</b> Mood median test</a></li>
<li class="chapter" data-level="11" data-path="matched-pairs-t-and-sign-test.html"><a href="matched-pairs-t-and-sign-test.html"><i class="fa fa-check"></i><b>11</b> Matched pairs t and sign test</a></li>
<li class="chapter" data-level="12" data-path="normal-quantile-plots.html"><a href="normal-quantile-plots.html"><i class="fa fa-check"></i><b>12</b> Normal quantile plots</a><ul>
<li class="chapter" data-level="12.1" data-path="normal-quantile-plots.html"><a href="normal-quantile-plots.html#lengths-of-heliconia-flowers"><i class="fa fa-check"></i><b>12.1</b> Lengths of heliconia flowers</a></li>
<li class="chapter" data-level="12.2" data-path="normal-quantile-plots.html"><a href="normal-quantile-plots.html#ferritin-and-normality"><i class="fa fa-check"></i><b>12.2</b> Ferritin and normality</a></li>
<li class="chapter" data-level="12.3" data-path="normal-quantile-plots.html"><a href="normal-quantile-plots.html#lengths-of-heliconia-flowers-1"><i class="fa fa-check"></i><b>12.3</b> Lengths of heliconia flowers</a></li>
<li class="chapter" data-level="12.4" data-path="normal-quantile-plots.html"><a href="normal-quantile-plots.html#ferritin-and-normality-1"><i class="fa fa-check"></i><b>12.4</b> Ferritin and normality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="analysis-of-variance.html"><a href="analysis-of-variance.html"><i class="fa fa-check"></i><b>13</b> Analysis of variance</a></li>
<li class="chapter" data-level="14" data-path="writing-reports.html"><a href="writing-reports.html"><i class="fa fa-check"></i><b>14</b> Writing reports</a></li>
<li class="chapter" data-level="15" data-path="learning-to-code.html"><a href="learning-to-code.html"><i class="fa fa-check"></i><b>15</b> Learning to code</a><ul>
<li class="chapter" data-level="15.1" data-path="learning-to-code.html"><a href="learning-to-code.html#introduction-1"><i class="fa fa-check"></i><b>15.1</b> Introduction</a></li>
<li class="chapter" data-level="15.2" data-path="learning-to-code.html"><a href="learning-to-code.html#data-and-pre-processing"><i class="fa fa-check"></i><b>15.2</b> Data and pre-processing</a></li>
<li class="chapter" data-level="15.3" data-path="learning-to-code.html"><a href="learning-to-code.html#analysis"><i class="fa fa-check"></i><b>15.3</b> Analysis</a></li>
<li class="chapter" data-level="15.4" data-path="learning-to-code.html"><a href="learning-to-code.html#conclusions-see-note-9"><i class="fa fa-check"></i><b>15.4</b> Conclusions (see note 9)</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="a-comparison-of-four-shampoos-in-treating-dandruff.html"><a href="a-comparison-of-four-shampoos-in-treating-dandruff.html"><i class="fa fa-check"></i><b>16</b> A comparison of four shampoos in treating dandruff</a><ul>
<li class="chapter" data-level="16.1" data-path="a-comparison-of-four-shampoos-in-treating-dandruff.html"><a href="a-comparison-of-four-shampoos-in-treating-dandruff.html#introduction-2"><i class="fa fa-check"></i><b>16.1</b> Introduction</a></li>
<li class="chapter" data-level="16.2" data-path="a-comparison-of-four-shampoos-in-treating-dandruff.html"><a href="a-comparison-of-four-shampoos-in-treating-dandruff.html#exploratory-analysis"><i class="fa fa-check"></i><b>16.2</b> Exploratory analysis</a></li>
<li class="chapter" data-level="16.3" data-path="a-comparison-of-four-shampoos-in-treating-dandruff.html"><a href="a-comparison-of-four-shampoos-in-treating-dandruff.html#analysis-of-variance-1"><i class="fa fa-check"></i><b>16.3</b> Analysis of Variance</a></li>
<li class="chapter" data-level="16.4" data-path="a-comparison-of-four-shampoos-in-treating-dandruff.html"><a href="a-comparison-of-four-shampoos-in-treating-dandruff.html#assessment-of-assumptions"><i class="fa fa-check"></i><b>16.4</b> Assessment of Assumptions</a></li>
<li class="chapter" data-level="16.5" data-path="a-comparison-of-four-shampoos-in-treating-dandruff.html"><a href="a-comparison-of-four-shampoos-in-treating-dandruff.html#conclusions"><i class="fa fa-check"></i><b>16.5</b> Conclusions</a></li>
<li class="chapter" data-level="16.6" data-path="a-comparison-of-four-shampoos-in-treating-dandruff.html"><a href="a-comparison-of-four-shampoos-in-treating-dandruff.html#end"><i class="fa fa-check"></i><b>16.6</b> End</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="tidying-data.html"><a href="tidying-data.html"><i class="fa fa-check"></i><b>17</b> Tidying data</a><ul>
<li class="chapter" data-level="17.1" data-path="tidying-data.html"><a href="tidying-data.html#baseball-and-softball-spaghetti"><i class="fa fa-check"></i><b>17.1</b> Baseball and softball spaghetti</a></li>
<li class="chapter" data-level="17.2" data-path="tidying-data.html"><a href="tidying-data.html#ethanol-and-sleep-time-in-rats"><i class="fa fa-check"></i><b>17.2</b> Ethanol and sleep time in rats</a></li>
<li class="chapter" data-level="17.3" data-path="tidying-data.html"><a href="tidying-data.html#growth-of-tomatoes"><i class="fa fa-check"></i><b>17.3</b> Growth of tomatoes</a></li>
<li class="chapter" data-level="17.4" data-path="tidying-data.html"><a href="tidying-data.html#pain-relief-in-migraine-headaches-again"><i class="fa fa-check"></i><b>17.4</b> Pain relief in migraine headaches (again)</a></li>
<li class="chapter" data-level="17.5" data-path="tidying-data.html"><a href="tidying-data.html#location-species-and-disease-in-plants"><i class="fa fa-check"></i><b>17.5</b> Location, species and disease in plants</a></li>
<li class="chapter" data-level="17.6" data-path="tidying-data.html"><a href="tidying-data.html#mating-songs-in-crickets"><i class="fa fa-check"></i><b>17.6</b> Mating songs in crickets</a></li>
<li class="chapter" data-level="17.7" data-path="tidying-data.html"><a href="tidying-data.html#number-1-songs"><i class="fa fa-check"></i><b>17.7</b> Number 1 songs</a></li>
<li class="chapter" data-level="17.8" data-path="tidying-data.html"><a href="tidying-data.html#bikes-on-college"><i class="fa fa-check"></i><b>17.8</b> Bikes on College</a></li>
<li class="chapter" data-level="17.9" data-path="tidying-data.html"><a href="tidying-data.html#feeling-the-heat"><i class="fa fa-check"></i><b>17.9</b> Feeling the heat</a></li>
<li class="chapter" data-level="17.10" data-path="tidying-data.html"><a href="tidying-data.html#isoflavones"><i class="fa fa-check"></i><b>17.10</b> Isoflavones</a></li>
<li class="chapter" data-level="17.11" data-path="tidying-data.html"><a href="tidying-data.html#jockos-garage"><i class="fa fa-check"></i><b>17.11</b> Jocko’s Garage</a></li>
<li class="chapter" data-level="17.12" data-path="tidying-data.html"><a href="tidying-data.html#tidying-electricity-consumption"><i class="fa fa-check"></i><b>17.12</b> Tidying electricity consumption</a></li>
<li class="chapter" data-level="17.13" data-path="tidying-data.html"><a href="tidying-data.html#tidy-blood-pressure"><i class="fa fa-check"></i><b>17.13</b> Tidy blood pressure</a></li>
<li class="chapter" data-level="17.14" data-path="tidying-data.html"><a href="tidying-data.html#baseball-and-softball-spaghetti-1"><i class="fa fa-check"></i><b>17.14</b> Baseball and softball spaghetti</a></li>
<li class="chapter" data-level="17.15" data-path="tidying-data.html"><a href="tidying-data.html#ethanol-and-sleep-time-in-rats-1"><i class="fa fa-check"></i><b>17.15</b> Ethanol and sleep time in rats</a></li>
<li class="chapter" data-level="17.16" data-path="tidying-data.html"><a href="tidying-data.html#growth-of-tomatoes-1"><i class="fa fa-check"></i><b>17.16</b> Growth of tomatoes</a></li>
<li class="chapter" data-level="17.17" data-path="tidying-data.html"><a href="tidying-data.html#pain-relief-in-migraine-headaches-again-1"><i class="fa fa-check"></i><b>17.17</b> Pain relief in migraine headaches (again)</a></li>
<li class="chapter" data-level="17.18" data-path="tidying-data.html"><a href="tidying-data.html#location-species-and-disease-in-plants-1"><i class="fa fa-check"></i><b>17.18</b> Location, species and disease in plants</a></li>
<li class="chapter" data-level="17.19" data-path="tidying-data.html"><a href="tidying-data.html#mating-songs-in-crickets-1"><i class="fa fa-check"></i><b>17.19</b> Mating songs in crickets</a></li>
<li class="chapter" data-level="17.20" data-path="tidying-data.html"><a href="tidying-data.html#number-1-songs-1"><i class="fa fa-check"></i><b>17.20</b> Number 1 songs</a></li>
<li class="chapter" data-level="17.21" data-path="tidying-data.html"><a href="tidying-data.html#bikes-on-college-1"><i class="fa fa-check"></i><b>17.21</b> Bikes on College</a></li>
<li class="chapter" data-level="17.22" data-path="tidying-data.html"><a href="tidying-data.html#feeling-the-heat-1"><i class="fa fa-check"></i><b>17.22</b> Feeling the heat</a></li>
<li class="chapter" data-level="17.23" data-path="tidying-data.html"><a href="tidying-data.html#isoflavones-1"><i class="fa fa-check"></i><b>17.23</b> Isoflavones</a></li>
<li class="chapter" data-level="17.24" data-path="tidying-data.html"><a href="tidying-data.html#jockos-garage-1"><i class="fa fa-check"></i><b>17.24</b> Jocko’s Garage</a></li>
<li class="chapter" data-level="17.25" data-path="tidying-data.html"><a href="tidying-data.html#tidying-electricity-consumption-1"><i class="fa fa-check"></i><b>17.25</b> Tidying electricity consumption</a></li>
<li class="chapter" data-level="17.26" data-path="tidying-data.html"><a href="tidying-data.html#tidy-blood-pressure-1"><i class="fa fa-check"></i><b>17.26</b> Tidy blood pressure</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="simple-regression.html"><a href="simple-regression.html"><i class="fa fa-check"></i><b>18</b> Simple regression</a></li>
<li class="chapter" data-level="19" data-path="multiple-regression.html"><a href="multiple-regression.html"><i class="fa fa-check"></i><b>19</b> Multiple regression</a></li>
<li class="chapter" data-level="20" data-path="regression-with-categorical-variables.html"><a href="regression-with-categorical-variables.html"><i class="fa fa-check"></i><b>20</b> Regression with categorical variables</a><ul>
<li class="chapter" data-level="20.1" data-path="regression-with-categorical-variables.html"><a href="regression-with-categorical-variables.html#crickets-revisited"><i class="fa fa-check"></i><b>20.1</b> Crickets revisited</a></li>
<li class="chapter" data-level="20.2" data-path="regression-with-categorical-variables.html"><a href="regression-with-categorical-variables.html#pulse-rates-and-marching"><i class="fa fa-check"></i><b>20.2</b> Pulse rates and marching</a></li>
<li class="chapter" data-level="20.3" data-path="regression-with-categorical-variables.html"><a href="regression-with-categorical-variables.html#crickets-revisited-1"><i class="fa fa-check"></i><b>20.3</b> Crickets revisited</a></li>
<li class="chapter" data-level="20.4" data-path="regression-with-categorical-variables.html"><a href="regression-with-categorical-variables.html#pulse-rates-and-marching-1"><i class="fa fa-check"></i><b>20.4</b> Pulse rates and marching</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="dates-and-times.html"><a href="dates-and-times.html"><i class="fa fa-check"></i><b>21</b> Dates and times</a></li>
<li class="chapter" data-level="22" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>22</b> Functions</a></li>
<li class="chapter" data-level="23" data-path="vector-and-matrix-algebra.html"><a href="vector-and-matrix-algebra.html"><i class="fa fa-check"></i><b>23</b> Vector and matrix algebra</a><ul>
<li class="chapter" data-level="23.1" data-path="vector-and-matrix-algebra.html"><a href="vector-and-matrix-algebra.html#heights-and-foot-lengths-again"><i class="fa fa-check"></i><b>23.1</b> Heights and foot lengths again</a></li>
<li class="chapter" data-level="23.2" data-path="vector-and-matrix-algebra.html"><a href="vector-and-matrix-algebra.html#heights-and-foot-lengths-again-1"><i class="fa fa-check"></i><b>23.2</b> Heights and foot lengths again</a></li>
</ul></li>
<li class="chapter" data-level="24" data-path="the-bootstrap.html"><a href="the-bootstrap.html"><i class="fa fa-check"></i><b>24</b> The Bootstrap</a></li>
<li class="chapter" data-level="25" data-path="bayesian-statistics-with-stan.html"><a href="bayesian-statistics-with-stan.html"><i class="fa fa-check"></i><b>25</b> Bayesian Statistics with Stan</a></li>
<li class="chapter" data-level="26" data-path="logistic-regression.html"><a href="logistic-regression.html"><i class="fa fa-check"></i><b>26</b> Logistic regression</a></li>
<li class="chapter" data-level="27" data-path="logistic-regression-with-ordinal-response.html"><a href="logistic-regression-with-ordinal-response.html"><i class="fa fa-check"></i><b>27</b> Logistic regression with ordinal response</a></li>
<li class="chapter" data-level="28" data-path="logistic-regression-with-nominal-response.html"><a href="logistic-regression-with-nominal-response.html"><i class="fa fa-check"></i><b>28</b> Logistic regression with nominal response</a></li>
<li class="chapter" data-level="29" data-path="survival-analysis.html"><a href="survival-analysis.html"><i class="fa fa-check"></i><b>29</b> Survival analysis</a></li>
<li class="chapter" data-level="30" data-path="analysis-of-variance-revisited.html"><a href="analysis-of-variance-revisited.html"><i class="fa fa-check"></i><b>30</b> Analysis of variance revisited</a></li>
<li class="chapter" data-level="31" data-path="analysis-of-covariance.html"><a href="analysis-of-covariance.html"><i class="fa fa-check"></i><b>31</b> Analysis of covariance</a></li>
<li class="chapter" data-level="32" data-path="multivariate-analysis-of-variance.html"><a href="multivariate-analysis-of-variance.html"><i class="fa fa-check"></i><b>32</b> Multivariate analysis of variance</a></li>
<li class="chapter" data-level="33" data-path="repeated-measures.html"><a href="repeated-measures.html"><i class="fa fa-check"></i><b>33</b> Repeated measures</a></li>
<li class="chapter" data-level="34" data-path="discriminant-analysis.html"><a href="discriminant-analysis.html"><i class="fa fa-check"></i><b>34</b> Discriminant analysis</a></li>
<li class="chapter" data-level="35" data-path="hierarchical-cluster-analysis.html"><a href="hierarchical-cluster-analysis.html"><i class="fa fa-check"></i><b>35</b> Hierarchical cluster analysis</a></li>
<li class="chapter" data-level="36" data-path="k-means-cluster-analysis.html"><a href="k-means-cluster-analysis.html"><i class="fa fa-check"></i><b>36</b> K-means cluster analysis</a></li>
<li class="chapter" data-level="37" data-path="drawing-maps-with-leaflet.html"><a href="drawing-maps-with-leaflet.html"><i class="fa fa-check"></i><b>37</b> Drawing maps with Leaflet</a></li>
<li class="chapter" data-level="38" data-path="multidimensional-scaling.html"><a href="multidimensional-scaling.html"><i class="fa fa-check"></i><b>38</b> Multidimensional Scaling</a></li>
<li class="chapter" data-level="39" data-path="principal-components.html"><a href="principal-components.html"><i class="fa fa-check"></i><b>39</b> Principal Components</a><ul>
<li class="chapter" data-level="39.1" data-path="principal-components.html"><a href="principal-components.html#the-weather-somewhere"><i class="fa fa-check"></i><b>39.1</b> The weather, somewhere</a></li>
<li class="chapter" data-level="39.2" data-path="principal-components.html"><a href="principal-components.html#the-weather-somewhere-1"><i class="fa fa-check"></i><b>39.2</b> The weather, somewhere</a></li>
</ul></li>
<li class="chapter" data-level="40" data-path="factor-analysis.html"><a href="factor-analysis.html"><i class="fa fa-check"></i><b>40</b> Factor Analysis</a></li>
<li class="chapter" data-level="41" data-path="frequency-table-analysis.html"><a href="frequency-table-analysis.html"><i class="fa fa-check"></i><b>41</b> Frequency table analysis</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Problems and Solutions in Applied Statistics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tidying-data" class="section level1">
<h1><span class="header-section-number">Chapter 17</span> Tidying data</h1>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb116-1" title="1"><span class="kw">library</span>(tidyverse)</a></code></pre></div>
<div id="baseball-and-softball-spaghetti" class="section level2">
<h2><span class="header-section-number">17.1</span> Baseball and softball spaghetti</h2>
<p>On a previous assignment, we found that students could throw
a baseball further than they could throw a softball. In this question,
we will make a graph called a “spaghetti plot” to illustrate this
graphically. (The issue previously was that the data were matched
pairs: the same students threw both balls.)</p>
<p>This seems to work most naturally by building a pipe, a line or two at
a time. See if you can do it that way. (If you can’t make it work, use lots of
temporary data frames, one to hold the result of each part.)</p>
<ol style="list-style-type: lower-alpha">
<li><p>Read in the data again from
<a href="http://ritsokiguess.site/datafiles/throw.txt">link</a>. The
variables had no names, so supply some, as you did before.</p></li>
<li><p>Create a new column that is the students turned into a <code>factor</code>,
adding it to your data frame. The reason for this will become clear
later.</p></li>
<li><p>Collect together all the throwing distances into one column,
making a second column that says which ball was thrown.</p></li>
<li><p>Using your new data frame, make a “scatterplot” of throwing
distance against type of ball.</p></li>
<li><p>Add two things to your plot: something that will distinguish
the students by colour (this works best if the thing distinguished
by colour is a factor),<a href="#fn22" class="footnote-ref" id="fnref22"><sup>22</sup></a>
and something that will join the two points for the same student by
a line.</p></li>
<li><p>The legend is not very informative. Remove it from the plot,
using <code>guides</code>.</p></li>
<li><p>What do you see on the final spaghetti plot? What does that tell you
about the relative distances a student can throw a baseball vs. a
softball? Explain briefly, blah blah blah.</p></li>
</ol>
</div>
<div id="ethanol-and-sleep-time-in-rats" class="section level2">
<h2><span class="header-section-number">17.2</span> Ethanol and sleep time in rats</h2>
<p>A biologist wished to study the effects of ethanol on sleep
time in rats. A sample of 20 rats (all the same age) was selected, and
each rat was given an injection having a particular concentration (0,
1, 2 or 4 grams per kilogram of body weight) of ethanol. These are
labelled <code>e0, e1, e2, e4</code>. The “0”
treatment was a control group. The rapid eye movement (REM) sleep time
was then recorded for each rat. The data are in
<a href="http://ritsokiguess.site/datafiles/ratsleep.txt">link</a>.</p>
<ol style="list-style-type: lower-alpha">
<li><p>Read the data in from the file. Check that you have four rows
of observations and five columns of sleep times.</p></li>
<li><p>Unfortunately, the data are in the wrong format. All the sleep
times for each treatment group are on one row, and we should have
<em>one</em> column containing <em>all</em> the sleep times, and the
corresponding row should show which treatment group that sleep time
came from. Transform this data frame into one that you could use for modelling or making graphs.</p></li>
<li><p>Using your new data frame, make side-by-side boxplots of sleep
time by treatment group.</p></li>
<li><p>In your boxplots, how does the median sleep time appear to
depend on treatment group?</p></li>
<li><p>There is an assumption about spread that the analysis of
variance needs in order to be reliable. Do your boxplots indicate that
this assumption is satisfied for these data, bearing in mind that you
have only five observations per group?</p></li>
<li><p>Run an analysis of variance to see whether sleep time differs
significantly among treatment groups. What do you conclude?</p></li>
<li><p>Would it be a good idea to run Tukey’s method here? Explain
briefly why or why not, and if you think it would be a good idea, run
it.</p></li>
<li><p>What do you conclude from Tukey’s method? (This is liable to be
a bit complicated.) Is there a treatment that is clearly best, in
terms of the sleep time being largest?</p></li>
</ol>
</div>
<div id="growth-of-tomatoes" class="section level2">
<h2><span class="header-section-number">17.3</span> Growth of tomatoes</h2>
<p>A biology graduate student exposed each of 32
tomato plants to one of four different colours of light (8 plants to
each colour). The growth rate of each plant, in millimetres per week,
was recorded. The data are in
<a href="http://ritsokiguess.site/datafiles/tomatoes.txt">link</a>.</p>
<ol style="list-style-type: lower-alpha">
<li><p>Read the data into R and confirm that you have 8 rows and 5
columns of data.</p></li>
<li><p>Re-arrange the data so that you have <em>one</em> column
containing all the growth rates, and another column saying which
colour light each plant was exposed to. (The aim here is to produce
something suitable for feeding into <code>aov</code> later.)</p></li>
<li><p>Save the data in the new format to a text file. This is
most easily done using <code>write_csv</code>, which is the opposite
of <code>read_csv</code>. It requires two things: a data frame, and
the name of a file to save in, which should have a <code>.csv</code>
extension.</p></li>
<li><p>Make a suitable boxplot, and use it to assess the assumptions
for ANOVA. What do you conclude? Explain briefly.</p></li>
<li><p>Run (regular) ANOVA on these data. What do you conclude?
(Optional extra: if you think that some other variant of ANOVA would
be better, run that as well and compare the results.)</p></li>
<li><p>If warranted, run a suitable follow-up. (If not warranted, explain briefly
why not.)</p></li>
</ol>
</div>
<div id="pain-relief-in-migraine-headaches-again" class="section level2">
<h2><span class="header-section-number">17.4</span> Pain relief in migraine headaches (again)</h2>
<p>The data in
<a href="http://ritsokiguess.site/datafiles/migraine.txt">link</a> are from a
study of pain relief in migraine headaches. Specifically, 27 subjects
were randomly assigned to receive <em>one</em> of three pain relieving
drugs, labelled A, B and C. Each subject reported the number of hours
of pain relief they obtained (that is, the number of hours between
taking the drug and the migraine symptoms returning). A higher value
is therefore better. Can we make some recommendation about which drug
is best for the population of migraine sufferers?</p>
<ol style="list-style-type: lower-alpha">
<li><p>Read in and display the data. Take a look at the data
file first, and see if you can say why <code>read_table</code> will
work and <code>read_delim</code> will not.</p></li>
<li><p>What is it about the experimental design that makes a one-way
analysis of variance plausible for data like this?</p></li>
<li><p>What is wrong with the current format of the data as far as
doing a one-way ANOVA analysis is concerned? (This is related to the
idea of whether or not the data are “tidy”.)</p></li>
<li><p>“Tidy” the data to produce a data frame suitable for your
analysis.</p></li>
<li><p>Go ahead and run your one-way ANOVA (and Tukey if
necessary). Assume for this that the pain relief hours in each group
are sufficiently close to normally distributed with sufficiently
equal spreads.</p></li>
<li><p>What recommendation would you make about the best drug or
drugs? Explain briefly.</p></li>
</ol>
</div>
<div id="location-species-and-disease-in-plants" class="section level2">
<h2><span class="header-section-number">17.5</span> Location, species and disease in plants</h2>
<p>The table below is a “contingency table”, showing
frequencies of diseased and undiseased plants of two different species
in two different locations:</p>
<pre><code>
Species     Disease present         Disease absent
Location X Location Y  Location X Location Y
A            44         12          38        10
B            28         22          20        18
</code></pre>
<p>The data were saved as
<a href="http://ritsokiguess.site/datafiles/disease.txt">link</a>. In that
file, the columns are coded by two letters: a <code>p</code> or an
<code>a</code> to denote presence or absence of disease, and an <code>x</code>
or a <code>y</code> to denote location X or Y. The data are separated by
multiple spaces and aligned with the variable names.</p>
<ol style="list-style-type: lower-alpha">
<li><p>Read in and display the data.</p></li>
<li><p>Explain briefly how these data are not “tidy”.</p></li>
<li><p>Use a suitable <code>tidyr</code> tool to get all the things
that are the same into a single column. (You’ll need to make up a
temporary name for the other new column that you create.) Show your
result.</p></li>
<li><p>Explain briefly how the data frame you just created is
still not “tidy” yet.</p></li>
<li><p>Use one more <code>tidyr</code> tool to make these data tidy,
and show your result.</p></li>
<li><p>Let’s see if we can re-construct the original contingency
table (or something equivalent to it). Use the function
<code>xtabs</code>. This requires first a model formula with the frequency
variable on the left of the squiggle, and the other variables
separated by plus signs on the right. Second it requires a data
frame, with <code>data=</code>. Feed
your data frame from the previous part into <code>xtabs</code>. Save the
result in a variable and display the result.</p></li>
<li><p>Take the output from the last part and feed it into the
function <code>ftable</code>. How has the output been changed? Which do
you like better? Explain briefly.</p></li>
</ol>
</div>
<div id="mating-songs-in-crickets" class="section level2">
<h2><span class="header-section-number">17.6</span> Mating songs in crickets</h2>
<p>Male tree crickets produce “mating songs” by rubbing their
wings together to produce a chirping sound. It is hypothesized that
female tree crickets identify males of the correct species by how fast
(in chirps per second) the male’s mating song is. This is called the
“pulse rate”. Some data for two species of crickets are in
<a href="http://ritsokiguess.site/datafiles/crickets.txt">link</a>. The
columns, which are unlabelled, are temperature and pulse rate
(respectively) for <em>Oecanthus exclamationis</em> (first two
columns) and <em>Oecanthus niveus</em> (third and fourth columns). The
columns are separated by tabs. There are some missing values in the
first two columns because fewer <em>exclamationis</em> crickets than
<em>niveus</em> crickets were measured.
The research question is whether males
of the different species have different average pulse rates. It is
also of interest to see whether temperature has an effect, and if
so, what.
Before we get to that, however, we have some data organization to do.</p>
<ol style="list-style-type: lower-alpha">
<li><p>Read in the data, allowing for the fact that you have no
column names. You’ll see that the
columns have names <code>X1</code> through <code>X4</code>. This is
OK.</p></li>
<li><p>Tidy these untidy data, going as directly as you can to something tidy. (Some later parts show you how it used to be done.) Begin by: (i) adding a column of row numbers, (ii) <code>rename</code>-ing the columns to species name, an underscore, and the variable contents (keeping <code>pulserate</code> as one word), and then use <code>pivot_longer</code>. Note that the column names encode <em>two</em> things.</p></li>
<li><p>If you found (b) a bit much to take in, the rest of the way we take a rather more leisurely approach towards the tidying.</p></li>
</ol>
<p>These data are rather far from being tidy. There need to be
three variables, temperature, pulse rate and species, and there
are <span class="math inline">\(14+17=31\)</span> observations altogether. This one is tricky in that
there are temperature and pulse rate for each of two levels of a
factor, so I’ll suggest combining the temperature and chirp rate
together into one thing for each species, then pivoting them longer (“combining”),
then pivoting them wider again (“splitting”). Create new columns, named for each species,
that contain the temperature and pulse rate for that species in
that order, <code>unite</code>d together.
For the rest of this question, start from the data frame you read
in, and build a pipe, one or two steps at a time, to save creating
a lot of temporary data frames.</p>
<ol start="4" style="list-style-type: lower-alpha">
<li><p>The two columns <code>exclamationis</code> and <code>niveus</code>
that you just created are both temperature-pulse rate combos, but
for different species. Collect them together into one
column, labelled by species. (This is a straight <code>tidyr</code> <code>pivot_longer</code>, even though the columns contain something odd-looking.)</p></li>
<li><p>Now split up the temperature-pulse combos at the underscore, into
two separate columns. This is <code>separate</code>. When specifying
what to separate by, you can use a number (“split after this many characters”) or a piece of text, in quotes (“when you see this text, split at it”).</p></li>
<li><p>Almost there. Temperature and pulse rate are still text
(because <code>unite</code> turned them into text), but they should be
numbers. Create new variables that are numerical versions of
temperature and pulse rate (using <code>as.numeric</code>). Check that
you have no extraneous variables (and, if necessary, get rid of
the ones you don’t want). (Species is also text and really ought
to be a factor, but having it as text doesn’t seem to cause any
problems.)
You can, if you like, use <code>parse_number</code> instead of
<code>as.numeric</code>. They should both work. The distinction I
prefer to make is that <code>parse_number</code> is good for text
with a number in it (that we want to pull the number out of),
while <code>as.numeric</code> is for turning something that looks like
a number but isn’t one into a genuine number.<a href="#fn23" class="footnote-ref" id="fnref23"><sup>23</sup></a></p></li>
</ol>
</div>
<div id="number-1-songs" class="section level2">
<h2><span class="header-section-number">17.7</span> Number 1 songs</h2>
<p>The data file
<a href="http://stat405.had.co.nz/data/billboard.csv">link</a> contains a lot of
information about songs popular in 2000. This dataset is untidy. Our
ultimate aim is to answer “which song occupied the #1 position for the largest number of weeks?”. To do that, we will build a pipe that
starts from the data frame read in from the URL above, and finishes
with an answer to the question. I will take you through this step by
step. Each part will involve adding something to the pipe you built
previously (possibly after removing a line or two that you used to
display the previous result).</p>
<ol style="list-style-type: lower-alpha">
<li><p>Read the data and display what you have.</p></li>
<li><p>The columns <code>x1st.week</code> through
<code>x76th.week</code> contain the rank of each song in the Billboard
chart in that week, with week 1 being the first week that the song
appeared in the chart. Convert all these columns into two: an
indication of week, called <code>week</code>, and of rank, called
<code>rank</code>. Most songs appeared in the Billboard chart for a
lot less than 76 weeks, so there are missing values, which you
want to remove. (I say “indication of week” since this will
probably be text at the moment). Display your new data frame. Do
you have fewer columns? Why do you have a lot more rows? Explain
briefly.</p></li>
<li><p>Both your <code>week</code> and <code>rank</code> columns are
(probably) text. Create new columns that contain just the numeric
values, and display just your new columns, again adding onto the
end of your pipe. If it so happens that <code>rank</code> is already a number, leave it as it is.</p></li>
<li><p>The meaning of your week-number column is that it refers
to the number of weeks <em>after</em> the song first appeared in the
Billboard chart. That is, if a song’s first appearance (in
<code>date.entered)</code> is July 24, then week 1 is July 24, week 2
is July 31, week 3 is August 7, and so on. Create a column
<code>current</code> by adding the appropriate number of <em>days</em>,
based on your week number, to <code>date.entered</code>. Display
<code>date.entered</code>, your week number, and <code>current</code> to
show that you have calculated the right thing. Note that you can
add a number of days onto a date and you will get another date.</p></li>
<li><p>Reaching the #1 rank on the Billboard chart is one of
the highest accolades in the popular music world. List all the
songs that reached <code>rank</code> 1. For these songs, list the
artist (as given in the data set), the song title, and the date(s)
for which the song was ranked number 1. Arrange the songs in date
order of being ranked #1. Display all the songs (I found 55 of them).</p></li>
<li><p>Use R to find out which song held the #1 rank for the
largest number of weeks. For this, you can assume that the song
titles are all unique (if it’s the same song title, it’s the same
song), but the artists might not be (for example, Madonna might
have had two different songs reach the #1 rank). The information
you need is in the output you obtained for the previous part, so
it’s a matter of adding some code to the end of that.
The last mark was for displaying <em>only</em> the song that was
ranked #1 for the largest number of weeks, or for otherwise
making it easy to see which song it was.</p></li>
</ol>
</div>
<div id="bikes-on-college" class="section level2">
<h2><span class="header-section-number">17.8</span> Bikes on College</h2>
<p>The City of Toronto collects all kinds of data on aspects of
life in the city. See
<a href="http://www1.toronto.ca/wps/portal/contentonly?vgnextoid=1a66e03bb8d1e310VgnVCM10000071d60f89RCRD">link</a>. One
collection of data is records of the number of cyclists on certain
downtown streets. The data in
<a href="http://ritsokiguess.site/datafiles/bikes.csv">link</a> are a record
of the cyclists on College Street on the block west from Huron to
Spadina on September 24, 2010. In the spreadsheet, each row relates to
one cyclist. The first column is the time the cyclist was observed (to
the nearest 15 minutes). After that, there are four pairs of
columns. The observer filled in (exactly) one X in each pair of
columns, according to whether (i) the cyclist was male or female, (ii)
was or was not wearing a helmet, (iii) was or was not carrying a
passenger on the bike, (iv) was or was not riding on the sidewalk. We
want to create a tidy data frame that has the time in each row, and
has columns containing appropriate values, often <code>TRUE</code> or
<code>FALSE</code>, for each of the four variables measured.</p>
<p>I will lead you through the process, which will involve developing a
(long) pipe, one step at a time.</p>
<ol style="list-style-type: lower-alpha">
<li><p>Take a look at the spreadsheet (using Excel or similar:
this may open when you click the link). Are there any obvious
header rows? Is there any extra material before the data start?
Explain briefly.</p></li>
<li><p>Read the data into an R data
frame. Read <em>without</em> headers, and instruct R how many lines
to skip over using <code>skip=</code> and a suitable number.
When this is working, display the first few lines of your data
frame. Note that your columns have names <code>X1</code> through
<code>X9</code>.</p></li>
<li><p>What do you notice about the times in your first
column? What do you think those “missing” times should be?</p></li>
<li><p>Find something from the <code>tidyverse</code> that will
fill<a href="#fn24" class="footnote-ref" id="fnref24"><sup>24</sup></a>
in those missing values with the right thing.
Start a pipe from the data frame you read in, that updates the
appropriate column with the filled-in times.</p></li>
<li><p>R’s <code>ifelse</code> function works like <code>=IF</code> in
Excel. You use it to create values for a new variable, for
example in a <code>mutate</code>. The first input to it is a
logical condition (something that is either true or false); the
second is the value your new variable should take if the
condition is true, and the third is the value of your new
variable if the condition is false. Create a new column
<code>gender</code> in your data frame that is “male” or
“female” depending on the value of your <code>X2</code> column,
using <code>mutate</code>. (You can assume that exactly one of the
second and third columns has an <code>X</code> in it.) Add your code
to the end of your pipe and display (the first 10 rows of) the
result.</p></li>
<li><p>Create variables <code>helmet</code>, <code>passenger</code> and
<code>sidewalk</code> in your data frame that are <code>TRUE</code> if
the “Yes” column contains <code>X</code> and <code>FALSE</code>
otherwise. This will use <code>mutate</code> again, but you don’t
need <code>ifelse</code>: just set the variable equal to the
appropriate logical condition. As before, the best way to
create these variables is to test the appropriate things for
missingness. Note that you can create as many new variables
as you like in one <code>mutate</code>. Show the first few lines
of your new data frame. (Add your code onto the end of the
pipe you made above.)</p></li>
<li><p>Finally
(for the data manipulation), get rid of
all the original columns, keeping only the new ones that
you created. Save the results in a data frame and display
its first few rows.</p></li>
<li><p>The next few parts are a quick-fire analysis of
the data set. They can all be solved using <code>count</code>.
How many male and how many female cyclists were observed
in total?</p></li>
<li><p>How many male and female cyclists were not
wearing helmets?</p></li>
<li><p>How many cyclists were riding on the sidewalk
<em>and</em> carrying a passenger?</p></li>
<li><p>What was the busiest 15-minute period of the
day, and how many cyclists were there then?</p></li>
</ol>
</div>
<div id="feeling-the-heat" class="section level2">
<h2><span class="header-section-number">17.9</span> Feeling the heat</h2>
<p>In summer, the city of Toronto issues Heat Alerts for
“high heat or humidity that is expected to last two or more days”. The
precise definitions are shown at
<a href="http://www1.toronto.ca/wps/portal/contentonly?vgnextoid=923b5ce6dfb31410VgnVCM10000071d60f89RCRD">link</a>. During
a heat alert, the city opens Cooling Centres and may extend the hours
of operation of city swimming pools, among other things. All the heat
alert days from 2001 to 2016 are listed at
<a href="http://ritsokiguess.site/datafiles/heat.csv">link</a>.</p>
<p>The word “warning” is sometimes used in place of “alert” in these
data. They mean the same thing.<a href="#fn25" class="footnote-ref" id="fnref25"><sup>25</sup></a></p>
<ol style="list-style-type: lower-alpha">
<li>Read the data into R, and display the data frame. Note that there are four columns:</li>
</ol>
<ul>
<li><p>a numerical <code>id</code> (numbered upwards from the first Heat
Alert in 2001; some of the numbers are missing)</p></li>
<li><p>the <code>date</code> of the heat alert, in year-month-day
format with 4-digit years.</p></li>
<li><p>a text <code>code</code> for the type of heat alert</p></li>
<li><p><code>text</code> describing the kind of heat alert. This can be quite long.</p></li>
</ul>
<ol start="2" style="list-style-type: lower-alpha">
<li><p>In your data frame, are the dates stored as genuine dates or as text? How can you tell?</p></li>
<li><p>Which different heat alert codes do you have, and how many of each?</p></li>
<li><p>Use the <code>text</code> in your dataset (or look back
at the original data file) to describe briefly in your own
words what the various codes represent.</p></li>
<li><p>How many (regular and extended) heat alert events
are there altogether? A heat alert event is a stretch of
consecutive days, on all of which there is a heat alert or
extended heat alert. Hints: (i) you can answer this from
output you already have; (ii) how can you tell when a heat
alert event <em>starts</em>?</p></li>
<li><p>We are going to investigate how many heat alert
days
there were in each year. To do that, we have
to extract the year from each of our dates.</p></li>
<li><p>Count the number of heat alert days for each
year, by tabulating the year variable.
Looking at this table, would you say that there
have been more heat alert days in recent years? Explain
(very) briefly.</p></li>
</ol>
</div>
<div id="isoflavones" class="section level2">
<h2><span class="header-section-number">17.10</span> Isoflavones</h2>
<p>The plant called kudzu was imported to the US South from Japan. It is rich in isoflavones, which are believed to be beneficial for bones. In a study, rats were randomly assigned to one of three diets: one with a low dose of isoflavones from kudzu, one with a high dose, and a control diet with no extra isoflavones. At the end of the study, each rat’s bone density was measured, in milligrams per square centimetre. The data as recorded are shown in .<a href="#fn26" class="footnote-ref" id="fnref26"><sup>26</sup></a> There are 15 observations for each treatment, and hence 45 altogether.</p>
<p>Here are some code ideas you might need to use later, all part of the <code>tidyverse</code>. You may need to find out how they work.</p>
<ul>
<li><code>col_names</code> (in the <code>read_</code> functions)</li>
<li><code>convert</code> (in various <code>tidyverse</code> functions)</li>
<li><code>fill</code></li>
<li><code>na_if</code></li>
<li><code>rename</code></li>
<li><code>separate_rows</code></li>
<li><code>skip</code> (in the <code>read_</code> functions)</li>
<li><code>values_drop_na</code> (in the <code>pivot_</code> functions)</li>
</ul>
<p>If you use any of these, <em>cite</em> the webpage(s) or other source(s) where you learned about them.</p>
<ol style="list-style-type: lower-alpha">
<li><p>Take a look at the data file. Describe briefly what you see.</p></li>
<li><p>Read in the data, using <code>read_table</code>, and get it into a tidy form, suitable for making a graph. This means finishing with (at least) a column of treatments with a suitable name (the treatments will be text) and a column of bone density values (numbers), one for each rat. You can have other columns as well; there is no obligation to get rid of them. Describe your process clearly enough that someone new to this data set would be able to understand what you have done and reproduce it on another similar dataset. Before you begin, think about whether or not you want to keep the column headers that are in the data file or not. (It can be done either way, but one way is easier than the other.)</p></li>
<li><p>The statistician on this study is thinking about running an ordinary analysis of variance to compare the bone mineral density for the different treatments. Obtain a plot from your tidy dataframe that will help her decide whether that is a good idea.</p></li>
<li><p>Based on your graph, and any additional graphs you wish to draw, what analysis would you recommend for this dataset? Explain briefly. (Don’t do the analysis.)</p></li>
</ol>
</div>
<div id="jockos-garage" class="section level2">
<h2><span class="header-section-number">17.11</span> Jocko’s Garage</h2>
<p>Insurance adjusters are concerned that Jocko’s Garage is giving estimates for repairing car damage that are too high. To see whether this is indeed the case, ten cars that had been in collisions were taken to both Jocko’s Garage and another garage, and the two estimates for repair were recorded. The data as recorded are <a href="http://ritsokiguess.site/datafiles/jocko.txt">here</a>.</p>
<ol style="list-style-type: lower-alpha">
<li><p>Take a look at the data file (eg. by using your web browser). How are the data laid out? Do there appear to be column headers?</p></li>
<li><p>Read in and display the data file, bearing in mind what you just concluded about it. What names did the columns acquire?</p></li>
<li><p>Make this data set tidy. That is, you need to end up with columns containing the repair cost estimates at each of the two garages and also identifying the cars, with each observation on one row. Describe your thought process. (It needs to be possible for the reader to follow your description and understand why it works.)
Save your tidy dataframe.</p></li>
<li><p>Make a suitable graph to assess the comparison of interest, and say briefly what your graph tells you.</p></li>
<li><p>Carry out a test to make an appropriate comparison of the mean estimates. What do you conclude, in the context of the data?</p></li>
</ol>
</div>
<div id="tidying-electricity-consumption" class="section level2">
<h2><span class="header-section-number">17.12</span> Tidying electricity consumption</h2>
<p>How does the consumption of electricity depend on temperature? To find out, a short-term study was carried out by a utility company based in a certain area. For a period of two years, the average monthly temperature was recorded (in degrees Fahrenheit), the mean daily demand for electricity per household (in kilowatt hours), and the cost per kilowatt hour of electricity for that year (8 cents for the first year and 10 cents for the second, which it will be easiest to treat as categorical).</p>
<p>The data were laid out in an odd way, as shown in , in aligned columns: the twelve months of temperature were laid out on <em>two</em> lines for the first year, then the twelve months of consumption for the first year on the next two lines, and then four more lines for the second year laid out the same way. Thus the temperature of 31 in the first line goes with the consumption of 55 in the <em>third</em> line, and the last measurements for that year are the 78 at the end of the second line (temperature) and 73 at the end of the fourth line (consumption). Lines 5 through 8 of the data file are the same thing for the second year (when electricity was more expensive).</p>
<p>The data seem to have been laid out in order of temperature, rather than in order of months, which I would have thought would make more sense. But this is what we have.</p>
<ol style="list-style-type: lower-alpha">
<li><p>Read in and display the data file, bearing in mind that it has <em>no column names</em>.</p></li>
<li><p>Arrange these data tidily, so that there is a column of price (per kilowatt hour), a column of temperatures, and a column of consumptions. Describe your process, including why you got list-columns (if you did) and what you did about them (if necessary).</p></li>
<li><p>Make a suitable graph of temperature, consumption and price in your tidy dataframe. Add smooth trends if appropriate. If you were unable to get the data tidy, use my tidy version <a href="http://ritsokiguess.site/datafiles/utils_tidy.csv">here</a>. (If you need the other file, right-click on “here” and Copy Link Address.)</p></li>
<li><p>What patterns or trends do you see on your graph? Do they make practical sense? There are two things I would like you to comment on.</p></li>
</ol>
</div>
<div id="tidy-blood-pressure" class="section level2">
<h2><span class="header-section-number">17.13</span> Tidy blood pressure</h2>
<p>Going to the dentist is scary for a lot of people. One way in which this might show up is that people might have higher blood pressure on average before their dentist’s appointment than an hour after the appointment is done. Ten randomly-chosen individuals have their (systolic<a href="#fn27" class="footnote-ref" id="fnref27"><sup>27</sup></a>) blood pressure measured while they are in a dentist’s waiting room, and then again one hour after their appointment is finished.</p>
<p>You might have seen a tidy version of this data set before.</p>
<p>The data as I originally received it is in <a href="http://ritsokiguess.site/datafiles/blood_pressure2.csv">http://ritsokiguess.site/datafiles/blood_pressure2.csv</a>.</p>
<ol style="list-style-type: lower-alpha">
<li><p>Read in and display the data as originally received.</p></li>
<li><p>Describe briefly how the data you read in is not tidy, bearing in mind how the data were collected and how they would be analysed.</p></li>
<li><p>Produce a tidy dataframe from the one you read in from the file. (How many rows should you have?)</p></li>
<li><p>What kind of test might you run on these data? Explain briefly.</p></li>
<li><p>Draw a suitable graph of these data.</p></li>
</ol>
<p>My solutions follow:</p>
</div>
<div id="baseball-and-softball-spaghetti-1" class="section level2">
<h2><span class="header-section-number">17.14</span> Baseball and softball spaghetti</h2>
<p>On a previous assignment, we found that students could throw
a baseball further than they could throw a softball. In this question,
we will make a graph called a “spaghetti plot” to illustrate this
graphically. (The issue previously was that the data were matched
pairs: the same students threw both balls.)</p>
<p>This seems to work most naturally by building a pipe, a line or two at
a time. See if you can do it that way. (If you can’t make it work, use lots of
temporary data frames, one to hold the result of each part.)</p>
<ol style="list-style-type: lower-alpha">
<li>Read in the data again from
<a href="http://ritsokiguess.site/datafiles/throw.txt">link</a>. The
variables had no names, so supply some, as you did before.</li>
</ol>
<p>Solution</p>
<p>Literal copy and paste:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" title="1">myurl &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/throw.txt&quot;</span></a>
<a class="sourceLine" id="cb118-2" title="2">throws &lt;-<span class="st"> </span><span class="kw">read_delim</span>(myurl, <span class="st">&quot; &quot;</span>, <span class="dt">col_names =</span> <span class="kw">c</span>(<span class="st">&quot;student&quot;</span>, <span class="st">&quot;baseball&quot;</span>, <span class="st">&quot;softball&quot;</span>))</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   student = col_double(),
##   baseball = col_double(),
##   softball = col_double()
## )</code></pre>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb120-1" title="1">throws</a></code></pre></div>
<pre><code>## # A tibble: 24 x 3
##    student baseball softball
##      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1       1       65       57
##  2       2       90       58
##  3       3       75       66
##  4       4       73       61
##  5       5       79       65
##  6       6       68       56
##  7       7       58       53
##  8       8       41       41
##  9       9       56       44
## 10      10       70       65
## # … with 14 more rows</code></pre>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Create a new column that is the students turned into a <code>factor</code>,
adding it to your data frame. The reason for this will become clear
later.</li>
</ol>
<p>Solution</p>
<p>Feed <code>student</code> into <code>factor</code>, creating a new
column with <code>mutate</code>:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" title="1">throws <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">fs =</span> <span class="kw">factor</span>(student))</a></code></pre></div>
<pre><code>## # A tibble: 24 x 4
##    student baseball softball fs   
##      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;
##  1       1       65       57 1    
##  2       2       90       58 2    
##  3       3       75       66 3    
##  4       4       73       61 4    
##  5       5       79       65 5    
##  6       6       68       56 6    
##  7       7       58       53 7    
##  8       8       41       41 8    
##  9       9       56       44 9    
## 10      10       70       65 10   
## # … with 14 more rows</code></pre>
<p>This doesn’t look any different from the original student numbers, but
note the variable type at the top of the column.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>Collect together all the throwing distances into one column,
making a second column that says which ball was thrown.</li>
</ol>
<p>Solution</p>
<p>Use <code>pivot_longer</code>. It goes like this:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" title="1">throws <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fs =</span> <span class="kw">factor</span>(student)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-3" title="3"><span class="st">  </span><span class="kw">pivot_longer</span>(baseball<span class="op">:</span>softball, <span class="dt">names_to=</span><span class="st">&quot;ball&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;distance&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 48 x 4
##    student fs    ball     distance
##      &lt;dbl&gt; &lt;fct&gt; &lt;chr&gt;       &lt;dbl&gt;
##  1       1 1     baseball       65
##  2       1 1     softball       57
##  3       2 2     baseball       90
##  4       2 2     softball       58
##  5       3 3     baseball       75
##  6       3 3     softball       66
##  7       4 4     baseball       73
##  8       4 4     softball       61
##  9       5 5     baseball       79
## 10       5 5     softball       65
## # … with 38 more rows</code></pre>
<p>The <code>names_to</code> is the name of a new categorical column whose values will be what is currently column names, and the <code>values_to</code> names a new quantitative (usually) column that will hold the values in those columns that you are making longer.</p>
<p>If you want to show off a little, you can use a select-helper, noting
that the columns you want to make longer all end in “ball”:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb126-1" title="1">throws <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb126-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fs =</span> <span class="kw">factor</span>(student)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb126-3" title="3"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">ends_with</span>(<span class="st">&quot;ball&quot;</span>), <span class="dt">names_to=</span><span class="st">&quot;ball&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;distance&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 48 x 4
##    student fs    ball     distance
##      &lt;dbl&gt; &lt;fct&gt; &lt;chr&gt;       &lt;dbl&gt;
##  1       1 1     baseball       65
##  2       1 1     softball       57
##  3       2 2     baseball       90
##  4       2 2     softball       58
##  5       3 3     baseball       75
##  6       3 3     softball       66
##  7       4 4     baseball       73
##  8       4 4     softball       61
##  9       5 5     baseball       79
## 10       5 5     softball       65
## # … with 38 more rows</code></pre>
<p>The same result. Use whichever you like.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>Using your new data frame, make a “scatterplot” of throwing
distance against type of ball.</li>
</ol>
<p>Solution</p>
<p>The obvious thing. No data frame in the <code>ggplot</code> because it’s the data frame that came out of the previous part of the pipeline (that doesn’t have a name):</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" title="1">throws <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fs =</span> <span class="kw">factor</span>(student)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-3" title="3"><span class="st">  </span><span class="kw">pivot_longer</span>(baseball<span class="op">:</span>softball, <span class="dt">names_to=</span><span class="st">&quot;ball&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;distance&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb128-4" title="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> ball, <span class="dt">y =</span> distance)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-97-1.png" width="672" /></p>
<p>This is an odd type of scatterplot because the <span class="math inline">\(x\)</span>-axis is actually a categorical variable. It’s really what would be called something like a dotplot. We’ll be using this as raw material for the plot we actually want.</p>
<p>What this plot is missing is an indication of which student threw
which ball. As it stands now, it could be an inferior version of a
boxplot of distances thrown for each ball (which would imply that they
are two independent sets of students, something that is not true).</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>Add two things to your plot: something that will distinguish
the students by colour (this works best if the thing distinguished
by colour is a factor),<a href="#fn28" class="footnote-ref" id="fnref28"><sup>28</sup></a>
and something that will join the two points for the same student by
a line.</li>
</ol>
<p>Solution</p>
<p>A <code>colour</code> and a <code>group</code> in the <code>aes</code>, and
a <code>geom_line</code>:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" title="1">throws <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fs =</span> <span class="kw">factor</span>(student)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-3" title="3"><span class="st">  </span><span class="kw">pivot_longer</span>(baseball<span class="op">:</span>softball, <span class="dt">names_to=</span><span class="st">&quot;ball&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;distance&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb129-4" title="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> ball, <span class="dt">y =</span> distance, <span class="dt">group =</span> fs, <span class="dt">colour =</span> fs)) <span class="op">+</span></a>
<a class="sourceLine" id="cb129-5" title="5"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-98-1.png" width="672" /></p>
<p>You can see what happens if you use the student as a number:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb130-1" title="1">throws <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb130-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fs =</span> <span class="kw">factor</span>(student)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb130-3" title="3"><span class="st">  </span><span class="kw">pivot_longer</span>(baseball<span class="op">:</span>softball, <span class="dt">names_to=</span><span class="st">&quot;ball&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;distance&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb130-4" title="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> ball, <span class="dt">y =</span> distance, <span class="dt">group =</span> student, <span class="dt">colour =</span> student)) <span class="op">+</span></a>
<a class="sourceLine" id="cb130-5" title="5"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-99-1.png" width="672" /></p>
<p>Now the student numbers are distinguished as a shade of blue (on an
implied continuous scale: even a nonsensical fractional student number
like 17.5 would be a shade of blue). This is not actually so bad here,
because all we are trying to do is to distinguish the students
sufficiently from each other so that we can see where the spaghetti
strands go. But I like the multi-coloured one better.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="6" style="list-style-type: lower-alpha">
<li>The legend is not very informative. Remove it from the plot,
using <code>guides</code>.</li>
</ol>
<p>Solution</p>
<p>You may not have seen this before. Here’s what to do: Find what’s
at the top of the legend that you want to remove. Here that is
<code>fs</code>. Find where <code>fs</code> appears in your
<code>aes</code>. It actually appears in two places: in
<code>group</code> and <code>colour</code>. I think the legend we want
to get rid of is actually the <code>colour</code> one, so we do this:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb131-1" title="1">throws <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fs =</span> <span class="kw">factor</span>(student)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-3" title="3"><span class="st">  </span><span class="kw">pivot_longer</span>(baseball<span class="op">:</span>softball, <span class="dt">names_to=</span><span class="st">&quot;ball&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;distance&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb131-4" title="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> ball, <span class="dt">y =</span> distance, <span class="dt">group =</span> fs, <span class="dt">colour =</span> fs)) <span class="op">+</span></a>
<a class="sourceLine" id="cb131-5" title="5"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb131-6" title="6"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">colour =</span> F)</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-100-1.png" width="672" /></p>
<p>That seems to have done it.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="7" style="list-style-type: lower-alpha">
<li>What do you see on the final spaghetti plot? What does that tell you
about the relative distances a student can throw a baseball vs. a
softball? Explain briefly, blah blah blah.</li>
</ol>
<p>Solution</p>
<p>Most of the spaghetti strands go downhill from baseball to
softball, or at least very few of them go uphill. That tells us
that most students can throw a baseball further than a softball.
That was the same impression that the matched-pairs <span class="math inline">\(t\)</span>-test
gave us. But the spaghetti plot tells us something else. If you
look carefully, you see that most of the big drops are for
students who could throw a baseball a long way. These students
also threw a softball further than the other students, but not
by as much. Most of the spaghetti strands in the bottom half of
the plot go more or less straight across. This indicates that
students who cannot throw a baseball very far will throw a
softball about the same distance as they threw the baseball.
There is an argument you could make here that the difference
between distances thrown is a <em>proportional</em> one, something
like “a student typically throws a baseball 20% further than a softball”.
That could be assessed by comparing not the
distances themselves, but the logs of the distances: in other
words, making a log transformation of all the
distances. (Distances have a lower limit of zero, so you might
expect observed distances to be skewed to the right, which is
another argument for making some kind of transformation.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="ethanol-and-sleep-time-in-rats-1" class="section level2">
<h2><span class="header-section-number">17.15</span> Ethanol and sleep time in rats</h2>
<p>A biologist wished to study the effects of ethanol on sleep
time in rats. A sample of 20 rats (all the same age) was selected, and
each rat was given an injection having a particular concentration (0,
1, 2 or 4 grams per kilogram of body weight) of ethanol. These are
labelled <code>e0, e1, e2, e4</code>. The “0”
treatment was a control group. The rapid eye movement (REM) sleep time
was then recorded for each rat. The data are in
<a href="http://ritsokiguess.site/datafiles/ratsleep.txt">link</a>.</p>
<ol style="list-style-type: lower-alpha">
<li>Read the data in from the file. Check that you have four rows
of observations and five columns of sleep times.</li>
</ol>
<p>Solution</p>
<p>Separated by single spaces:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb132-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/ratsleep.txt&quot;</span></a>
<a class="sourceLine" id="cb132-2" title="2">sleep1 &lt;-<span class="st"> </span><span class="kw">read_delim</span>(my_url, <span class="st">&quot; &quot;</span>)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   treatment = col_character(),
##   obs1 = col_double(),
##   obs2 = col_double(),
##   obs3 = col_double(),
##   obs4 = col_double(),
##   obs5 = col_double()
## )</code></pre>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb134-1" title="1">sleep1</a></code></pre></div>
<pre><code>## # A tibble: 4 x 6
##   treatment  obs1  obs2  obs3  obs4  obs5
##   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 e0         88.6  73.2  91.4  68    75.2
## 2 e1         63    53.9  69.2  50.1  71.5
## 3 e2         44.9  59.5  40.2  56.3  38.7
## 4 e4         31    39.6  45.3  25.2  22.7</code></pre>
<p>There are six columns, but one of them labels the groups, and there
are correctly five columns of sleep times.</p>
<p>I used a “temporary” name for my data frame, because I’m going to be
doing some processing on it in a minute, and I want to reserve the
name <code>sleep</code> for my processed data frame.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Unfortunately, the data are in the wrong format. All the sleep
times for each treatment group are on one row, and we should have
<em>one</em> column containing <em>all</em> the sleep times, and the
corresponding row should show which treatment group that sleep time
came from. Transform this data frame into one that you could use for modelling or making graphs.</li>
</ol>
<p>Solution</p>
<p>We will want <em>one</em> column of sleep times, with an additional categorical column saying what observation each sleep time was within its group (or, you might say, we don’t really care about that much, but that’s what we are going to get).</p>
<p>The columns <code>obs1</code> through <code>obs5</code> are
different in that they are different observation numbers
(“replicates”, in the jargon). I’ll call that <code>rep</code>. What
makes them the same is that they are all sleep times. Columns
<code>obs1</code> through <code>obs5</code> are the ones we want to
combine, thus.
Here is where I use the name <code>sleep</code>: I save the result of
the <code>pivot_longer</code> into a data frame <code>sleep</code>. Note that I
also used the brackets-around-the-outside to display what I had,
so that I didn’t have to do a separate display. This is a handy
way of saving <em>and</em> displaying in one shot:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb136-1" title="1">(sleep1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb136-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>treatment, <span class="dt">names_to=</span><span class="st">&quot;rep&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;sleeptime&quot;</span>) -&gt;<span class="st"> </span>sleep)</a></code></pre></div>
<pre><code>## # A tibble: 20 x 3
##    treatment rep   sleeptime
##    &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;
##  1 e0        obs1       88.6
##  2 e0        obs2       73.2
##  3 e0        obs3       91.4
##  4 e0        obs4       68  
##  5 e0        obs5       75.2
##  6 e1        obs1       63  
##  7 e1        obs2       53.9
##  8 e1        obs3       69.2
##  9 e1        obs4       50.1
## 10 e1        obs5       71.5
## 11 e2        obs1       44.9
## 12 e2        obs2       59.5
## 13 e2        obs3       40.2
## 14 e2        obs4       56.3
## 15 e2        obs5       38.7
## 16 e4        obs1       31  
## 17 e4        obs2       39.6
## 18 e4        obs3       45.3
## 19 e4        obs4       25.2
## 20 e4        obs5       22.7</code></pre>
<p>Typically in this kind of work, you have a lot of columns that need to be made longer, and a much smaller number of columns that need to be repeated as necessary. You can either specify all the columns to make longer, or you can specify “not” the other columns. Above, my first input to <code>pivot_longer</code> was “everything but treatment”, but you could also do it like this:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb138-1" title="1">sleep1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb138-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(obs1<span class="op">:</span>obs5, <span class="dt">names_to=</span><span class="st">&quot;rep&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;sleeptime&quot;</span>) </a></code></pre></div>
<pre><code>## # A tibble: 20 x 3
##    treatment rep   sleeptime
##    &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;
##  1 e0        obs1       88.6
##  2 e0        obs2       73.2
##  3 e0        obs3       91.4
##  4 e0        obs4       68  
##  5 e0        obs5       75.2
##  6 e1        obs1       63  
##  7 e1        obs2       53.9
##  8 e1        obs3       69.2
##  9 e1        obs4       50.1
## 10 e1        obs5       71.5
## 11 e2        obs1       44.9
## 12 e2        obs2       59.5
## 13 e2        obs3       40.2
## 14 e2        obs4       56.3
## 15 e2        obs5       38.7
## 16 e4        obs1       31  
## 17 e4        obs2       39.6
## 18 e4        obs3       45.3
## 19 e4        obs4       25.2
## 20 e4        obs5       22.7</code></pre>
<p>or like this:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb140-1" title="1">sleep1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb140-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;obs&quot;</span>), <span class="dt">names_to=</span><span class="st">&quot;rep&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;sleeptime&quot;</span>) </a></code></pre></div>
<pre><code>## # A tibble: 20 x 3
##    treatment rep   sleeptime
##    &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;
##  1 e0        obs1       88.6
##  2 e0        obs2       73.2
##  3 e0        obs3       91.4
##  4 e0        obs4       68  
##  5 e0        obs5       75.2
##  6 e1        obs1       63  
##  7 e1        obs2       53.9
##  8 e1        obs3       69.2
##  9 e1        obs4       50.1
## 10 e1        obs5       71.5
## 11 e2        obs1       44.9
## 12 e2        obs2       59.5
## 13 e2        obs3       40.2
## 14 e2        obs4       56.3
## 15 e2        obs5       38.7
## 16 e4        obs1       31  
## 17 e4        obs2       39.6
## 18 e4        obs3       45.3
## 19 e4        obs4       25.2
## 20 e4        obs5       22.7</code></pre>
<p>This one was a little unusual in that usually with these you have the <em>treatments</em> in the columns and the replicates in the rows. It doesn’t matter, though: <code>pivot_longer</code> handles both cases.</p>
<p>We have 20 rows of 3 columns. I got all the rows, but you will
probably get an output with ten rows as usual, and will need to click
Next to see the last ten rows. The initial display will say how many
rows (20) and columns (3) you have.</p>
<p>The column <code>rep</code> is not very interesting: it just says which
observation each one was within its group.<a href="#fn29" class="footnote-ref" id="fnref29"><sup>29</sup></a>
The interesting things are <code>treatment</code> and
<code>sleeptime</code>, which are the two variables we’ll need for our
analysis of variance.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>Using your new data frame, make side-by-side boxplots of sleep
time by treatment group.</li>
</ol>
<p>Solution</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb142-1" title="1"><span class="kw">ggplot</span>(sleep, <span class="kw">aes</span>(<span class="dt">x =</span> treatment, <span class="dt">y =</span> sleeptime)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-105-1.png" width="672" /></p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>In your boxplots, how does the median sleep time appear to
depend on treatment group?</li>
</ol>
<p>Solution</p>
<p>It appears to <em>decrease</em> as the dose of ethanol increases,
and pretty substantially so (in that the differences ought to be
significant, but that’s coming up).</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>There is an assumption about spread that the analysis of
variance needs in order to be reliable. Do your boxplots indicate that
this assumption is satisfied for these data, bearing in mind that you
have only five observations per group?</li>
</ol>
<p>Solution</p>
<p>The assumption is that the population SDs of each group are all
equal. Now, the boxplots show IQRs, which are kind of a surrogate
for SD, and because we only have five observations per group to
base the IQRs on, the <em>sample</em> IQRs might vary a bit. So we
should look at the heights of the boxes on the boxplot, and see
whether they are grossly unequal. They appear to be to be of very
similar heights, all things considered, so I am happy.</p>
<p>If you want the SDs themselves:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb143-1" title="1">sleep <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(treatment) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">stddev =</span> <span class="kw">sd</span>(sleeptime))</a></code></pre></div>
<pre><code>## # A tibble: 4 x 2
##   treatment stddev
##   &lt;chr&gt;      &lt;dbl&gt;
## 1 e0         10.2 
## 2 e1          9.34
## 3 e2          9.46
## 4 e4          9.56</code></pre>
<p>Those are <em>very</em> similar, given only 5 observations per group. No
problems here.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="6" style="list-style-type: lower-alpha">
<li>Run an analysis of variance to see whether sleep time differs
significantly among treatment groups. What do you conclude?</li>
</ol>
<p>Solution</p>
<p>I use <code>aov</code> here, because I might be following up with
Tukey in a minute:</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb145-1" title="1">sleep<span class="fl">.1</span> &lt;-<span class="st"> </span><span class="kw">aov</span>(sleeptime <span class="op">~</span><span class="st"> </span>treatment, <span class="dt">data =</span> sleep)</a>
<a class="sourceLine" id="cb145-2" title="2"><span class="kw">summary</span>(sleep<span class="fl">.1</span>)</a></code></pre></div>
<pre><code>##             Df Sum Sq Mean Sq F value   Pr(&gt;F)    
## treatment    3   5882    1961   21.09 8.32e-06 ***
## Residuals   16   1487      93                     
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>This is a very small P-value, so my conclusion is that the mean sleep
times are not all the same for the treatment groups. Further than that
I am not entitled to say (yet).</p>
<p>The technique here is to save the output from <code>aov</code> in
something, look at that (via <code>summary</code>), and then that same
something gets fed into <code>TukeyHSD</code> later.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="7" style="list-style-type: lower-alpha">
<li>Would it be a good idea to run Tukey’s method here? Explain
briefly why or why not, and if you think it would be a good idea, run
it.</li>
</ol>
<p>Solution</p>
<p>Tukey’s method is useful when (i) we have run an analysis of
variance and got a significant result and (ii) when we want to know
which groups differ significantly from which. Both (i) and (ii) are
true here. So:</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb147-1" title="1"><span class="kw">TukeyHSD</span>(sleep<span class="fl">.1</span>)</a></code></pre></div>
<pre><code>##   Tukey multiple comparisons of means
##     95% family-wise confidence level
## 
## Fit: aov(formula = sleeptime ~ treatment, data = sleep)
## 
## $treatment
##         diff       lwr         upr     p adj
## e1-e0 -17.74 -35.18636  -0.2936428 0.0455781
## e2-e0 -31.36 -48.80636 -13.9136428 0.0005142
## e4-e0 -46.52 -63.96636 -29.0736428 0.0000056
## e2-e1 -13.62 -31.06636   3.8263572 0.1563545
## e4-e1 -28.78 -46.22636 -11.3336428 0.0011925
## e4-e2 -15.16 -32.60636   2.2863572 0.1005398</code></pre>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="8" style="list-style-type: lower-alpha">
<li>What do you conclude from Tukey’s method? (This is liable to be
a bit complicated.) Is there a treatment that is clearly best, in
terms of the sleep time being largest?</li>
</ol>
<p>Solution</p>
<p>All the differences are significant except treatment <code>e2</code>
vs. <code>e1</code> and <code>e4</code>. All the differences involving
the control group <code>e0</code> are significant, and if you look
back at the boxplots in (c), you’ll see that the control group <code>e0</code>
had the <em>highest</em> mean sleep time. So the control group is
best (from this point of view), or another way of saying it is
that <em>any</em> dose of ethanol is significantly reducing mean
sleep time.
The other comparisons are a bit confusing, because the 1-4
difference is significant, but neither of the differences
involving 2 are. That is, 1 is better than 4, but 2 is not
significantly worse than 1 nor better than 4. This seems like it
should be a logical impossibility, but the story is that we don’t
have enough data to decide where 2 fits relative to 1 or 4. If we
had 10 or 20 observations per group, we might be able to conclude
that 2 is in between 1 and 4 as the boxplots suggest.</p>
<p>Extra: I didn’t ask about normality here, but like the equal-spreads assumption I’d say there’s nothing controversial about it with these data. With normality good and equal spreads good, <code>aov</code> plus Tukey is the analysis of choice.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="growth-of-tomatoes-1" class="section level2">
<h2><span class="header-section-number">17.16</span> Growth of tomatoes</h2>
<p>A biology graduate student exposed each of 32
tomato plants to one of four different colours of light (8 plants to
each colour). The growth rate of each plant, in millimetres per week,
was recorded. The data are in
<a href="http://ritsokiguess.site/datafiles/tomatoes.txt">link</a>.</p>
<ol style="list-style-type: lower-alpha">
<li>Read the data into R and confirm that you have 8 rows and 5
columns of data.</li>
</ol>
<p>Solution</p>
<p>This kind of thing:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb149-1" title="1">my_url=<span class="st">&quot;http://ritsokiguess.site/datafiles/tomatoes.txt&quot;</span></a>
<a class="sourceLine" id="cb149-2" title="2">toms1=<span class="kw">read_delim</span>(my_url,<span class="st">&quot; &quot;</span>)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   plant = col_double(),
##   blue = col_double(),
##   red = col_double(),
##   yellow = col_double(),
##   green = col_double()
## )</code></pre>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb151-1" title="1">toms1</a></code></pre></div>
<pre><code>## # A tibble: 8 x 5
##   plant  blue   red yellow green
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
## 1     1  5.34  13.7   4.61  2.72
## 2     2  7.45  13.0   6.63  1.08
## 3     3  7.15  10.2   5.29  3.97
## 4     4  5.53  13.1   5.29  2.66
## 5     5  6.34  11.1   4.76  3.69
## 6     6  7.16  11.4   5.57  1.96
## 7     7  7.77  14.0   6.57  3.38
## 8     8  5.09  13.5   5.25  1.87</code></pre>
<p>I do indeed have 8 rows and 5 columns.</p>
<p>With only 8 rows, listing the data like this is good.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Re-arrange the data so that you have <em>one</em> column
containing all the growth rates, and another column saying which
colour light each plant was exposed to. (The aim here is to produce
something suitable for feeding into <code>aov</code> later.)</li>
</ol>
<p>Solution</p>
<p>This is a job for <code>pivot_longer</code>:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb153-1" title="1">toms1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb153-2" title="2"><span class="st">   </span><span class="kw">pivot_longer</span>(<span class="op">-</span>plant, <span class="dt">names_to=</span><span class="st">&quot;colour&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;growthrate&quot;</span>) -&gt;<span class="st"> </span>toms2</a>
<a class="sourceLine" id="cb153-3" title="3">toms2</a></code></pre></div>
<pre><code>## # A tibble: 32 x 3
##    plant colour growthrate
##    &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;
##  1     1 blue         5.34
##  2     1 red         13.7 
##  3     1 yellow       4.61
##  4     1 green        2.72
##  5     2 blue         7.45
##  6     2 red         13.0 
##  7     2 yellow       6.63
##  8     2 green        1.08
##  9     3 blue         7.15
## 10     3 red         10.2 
## # … with 22 more rows</code></pre>
<p>I chose to specify “everything but plant number”, since there are several colour columns with different names.</p>
<p>Since the column <code>plant</code> was never mentioned, this gets
repeated as necessary, so now it denotes “plant within colour group”,
which in this case is not very useful. (Where you have
matched pairs, or repeated measures in general, you <em>do</em> want to
keep track of which individual is which. But this is not repeated
measures because plant number 1 in the blue group and plant number 1
in the red group are <em>different</em> plants.)</p>
<p>There were 8 rows originally and 4 different colours, so there should
be, and are, <span class="math inline">\(8 \times 4=32\)</span> rows in the made-longer data set.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>Save the data in the new format to a text file. This is
most easily done using <code>write_csv</code>, which is the opposite
of <code>read_csv</code>. It requires two things: a data frame, and
the name of a file to save in, which should have a <code>.csv</code>
extension.</li>
</ol>
<p>Solution</p>
<p>The code is easy enough:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb155-1" title="1"><span class="kw">write_csv</span>(toms2,<span class="st">&quot;tomatoes2.csv&quot;</span>)</a></code></pre></div>
<p>If no error, it worked. That’s all you need.</p>
<p>To verify (for my satisfaction) that it was saved correctly:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb156-1" title="1"><span class="fu">cat</span> tomatoes2.csv </a></code></pre></div>
<pre><code>## plant,colour,growthrate
## 1,blue,5.34
## 1,red,13.67
## 1,yellow,4.61
## 1,green,2.72
## 2,blue,7.45
## 2,red,13.04
## 2,yellow,6.63
## 2,green,1.08
## 3,blue,7.15
## 3,red,10.16
## 3,yellow,5.29
## 3,green,3.97
## 4,blue,5.53
## 4,red,13.12
## 4,yellow,5.29
## 4,green,2.66
## 5,blue,6.34
## 5,red,11.06
## 5,yellow,4.76
## 5,green,3.69
## 6,blue,7.16
## 6,red,11.43
## 6,yellow,5.57
## 6,green,1.96
## 7,blue,7.77
## 7,red,13.98
## 7,yellow,6.57
## 7,green,3.38
## 8,blue,5.09
## 8,red,13.49
## 8,yellow,5.25
## 8,green,1.87</code></pre>
<p>On my system, that will list the contents of the file. Or you can just
open it in R Studio (if you saved it the way I did, it’ll be in the
same folder, and you can find it in the Files pane.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>Make a suitable boxplot, and use it to assess the assumptions
for ANOVA. What do you conclude? Explain briefly.</li>
</ol>
<p>Solution</p>
<p>Nothing terribly surprising here. My data frame is called
<code>toms2</code>, for some reason:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb158-1" title="1"><span class="kw">ggplot</span>(toms2,<span class="kw">aes</span>(<span class="dt">x=</span>colour, <span class="dt">y=</span>growthrate))<span class="op">+</span><span class="kw">geom_boxplot</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-113-1.png" width="672" /></p>
<p>There are no outliers, but there is a little skewness (compare the
<em>whiskers</em>, not the placement of the median within the box,
because what matters with skewness is the <em>tails</em>, not the middle
of the distribution; it’s problems in the tails that make the mean
unsuitable as a measure of centre). The Red group looks the most
skewed. Also, the Yellow group has smaller spread than the others (we
assume that the population variances within each group are equal). The
thing to bear in mind here, though, is that there are only eight
observations per group, so the distributions could appear to have
unequal variances or some non-normality by chance.</p>
<p>My take is that these data, all things considered, are  OK for ANOVA. Another option would be to do Welch’s ANOVA as
well and compare with the regular ANOVA: if they give more or less the
same P-value, that’s a sign that I didn’t need to worry.</p>
<p>Extra: some people like to run a formal test on the variances to test
them for equality. My favourite (for reasons explained elsewhere) is
the Levene test, if you insist on going this way. It lives in package
<code>car</code>, and <em>does not</em> take a <code>data=</code>, so you need
to do the <code>with</code> thing:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb159-1" title="1"><span class="kw">library</span>(car)</a>
<a class="sourceLine" id="cb159-2" title="2"><span class="kw">with</span>(toms2,<span class="kw">leveneTest</span>(growthrate,colour))</a></code></pre></div>
<pre><code>## Warning in leveneTest.default(growthrate, colour): colour coerced to factor.</code></pre>
<pre><code>## Levene&#39;s Test for Homogeneity of Variance (center = median)
##       Df F value Pr(&gt;F)
## group  3  0.9075 0.4499
##       28</code></pre>
<p>The warning is because <code>colour</code> was actually text, but the test
did the right thing by turning it into a factor, so that’s OK.</p>
<p>There is no way we can reject equal variances in the four groups. The
<span class="math inline">\(F\)</span>-statistic is less than 1, in fact, which says that if the four
groups have the same population variances, the sample variances will
be <em>more</em> different than the ones we observed on average, and so
there is no way that these sample variances indicate different
population variances. (This is because of 8 observations only per
group; if there had been 80 observations per group, it would have been
a different story.) Decide for yourself whether you’re surprised by this.</p>
<p>With that in mind, I think the regular ANOVA will be perfectly good,
and we would expect that and the Welch ANOVA to give very similar results.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>Run (regular) ANOVA on these data. What do you conclude?
(Optional extra: if you think that some other variant of ANOVA would
be better, run that as well and compare the results.)</li>
</ol>
<p>Solution</p>
<p><code>aov</code>, bearing in mind that Tukey is likely to follow:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb162-1" title="1">toms<span class="fl">.1</span>=<span class="kw">aov</span>(growthrate<span class="op">~</span>colour,<span class="dt">data=</span>toms2)</a>
<a class="sourceLine" id="cb162-2" title="2"><span class="kw">summary</span>(toms<span class="fl">.1</span>)</a></code></pre></div>
<pre><code>##             Df Sum Sq Mean Sq F value   Pr(&gt;F)    
## colour       3  410.5  136.82   118.2 5.28e-16 ***
## Residuals   28   32.4    1.16                     
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>This is a tiny P-value, so the mean growth rate for the different
colours is definitely <em>not</em> the same for all colours. Or, if you
like, one or more of the colours has a different mean growth rate than
the others.</p>
<p>This, remember, is as far as we go right now.</p>
<p>Extra: if you thought that normality was OK but not equal spreads,
then Welch ANOVA is the way to go:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb164-1" title="1">toms<span class="fl">.2</span>=<span class="kw">oneway.test</span>(growthrate<span class="op">~</span>colour,<span class="dt">data=</span>toms2)</a>
<a class="sourceLine" id="cb164-2" title="2">toms<span class="fl">.2</span></a></code></pre></div>
<pre><code>## 
##  One-way analysis of means (not assuming equal variances)
## 
## data:  growthrate and colour
## F = 81.079, num df = 3.000, denom df = 15.227, p-value = 1.377e-09</code></pre>
<p>The P-value is not <em>quite</em> as small as for the regular ANOVA, but
it is still very small, and the conclusion is the same.</p>
<p>If you had doubts about the normality (that were sufficiently great,
even given the small sample sizes), then go with Mood’s median test
for multiple groups:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb166-1" title="1"><span class="kw">library</span>(smmr)</a>
<a class="sourceLine" id="cb166-2" title="2"><span class="kw">median_test</span>(toms2,growthrate,colour)</a></code></pre></div>
<pre><code>## $table
##         above
## group    above below
##   blue       5     3
##   green      0     8
##   red        8     0
##   yellow     3     5
## 
## $test
##        what        value
## 1 statistic 1.700000e+01
## 2        df 3.000000e+00
## 3   P-value 7.067424e-04</code></pre>
<p>The P-value is again extremely small (though not quite as small as for
the other two tests, for the usual reason that Mood’s median test
doesn’t use the data very efficiently: it doesn’t use how <em>far</em>
above or below the overall median the data values are.)</p>
<p>The story here, as ever, is consistency: whatever you thought was
wrong, looking at the boxplots, needs to guide the test you do:</p>
<ul>
<li><p>if you are not happy with normality, go with
<code>median_test</code> from <code>smmr</code> (Mood’s median test).</p></li>
<li><p>if you are happy with normality and equal variances, go with
<code>aov</code>.</p></li>
<li><p>if you are happy with normality but not equal variances, go with
<code>oneway.test</code> (Welch ANOVA).</p></li>
</ul>
<p>So the first thing to think about is normality, and if you are OK with
normality, then think about equal spreads. Bear in mind that you need
to be willing to tolerate a certain amount of non-normality and
inequality in the spreads, given that your data are only samples from
their populations. (Don’t expect perfection, in short.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="6" style="list-style-type: lower-alpha">
<li>If warranted, run a suitable follow-up. (If not warranted, explain briefly
why not.)</li>
</ol>
<p>Solution</p>
<p>Whichever flavour of ANOVA you ran (regular ANOVA, Welch ANOVA,
Mood’s median test), you got the same conclusion for these data:
that the average growth rates were not all the same for the four
colours. That, as you’ll remember, is as far as you go. To find
out which colours differ from which in terms of growth rate, you
need to run some kind of multiple-comparisons follow-up, the
right one for the analysis you did. Looking at the boxplots suggests that red is clearly best
and green clearly worst, and it is possible that all the colours
are significantly different from each other.)
If you did regular ANOVA, Tukey is what you need:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb168-1" title="1"><span class="kw">TukeyHSD</span>(toms<span class="fl">.1</span>)</a></code></pre></div>
<pre><code>##   Tukey multiple comparisons of means
##     95% family-wise confidence level
## 
## Fit: aov(formula = growthrate ~ colour, data = toms2)
## 
## $colour
##                 diff       lwr        upr     p adj
## green-blue   -3.8125 -5.281129 -2.3438706 0.0000006
## red-blue      6.0150  4.546371  7.4836294 0.0000000
## yellow-blue  -0.9825 -2.451129  0.4861294 0.2825002
## red-green     9.8275  8.358871 11.2961294 0.0000000
## yellow-green  2.8300  1.361371  4.2986294 0.0000766
## yellow-red   -6.9975 -8.466129 -5.5288706 0.0000000</code></pre>
<p>All of the differences are (strongly) significant, except for yellow
and blue, the two with middling growth rates on the boxplot. Thus we
would have no hesitation in saying that growth rate is biggest in red
light and smallest in green light.</p>
<p>If you did Welch ANOVA, you need Games-Howell, which you have to get
from one of the packages that offers it:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb170-1" title="1"><span class="kw">library</span>(PMCMRplus)</a>
<a class="sourceLine" id="cb170-2" title="2"><span class="kw">gamesHowellTest</span>(growthrate<span class="op">~</span><span class="kw">factor</span>(colour),<span class="dt">data=</span>toms2)</a></code></pre></div>
<pre><code>## 
##  Pairwise comparisons using Games-Howell test</code></pre>
<pre><code>## data: growthrate by factor(colour)</code></pre>
<pre><code>##        blue    green   red    
## green  1.6e-05 -       -      
## red    1.5e-06 4.8e-09 -      
## yellow 0.18707 0.00011 5.8e-07</code></pre>
<pre><code>## 
## P value adjustment method: none</code></pre>
<pre><code>## alternative hypothesis: two.sided</code></pre>
<p>The conclusions are the same as for the Tukey: all the means are
significantly different except for yellow and blue.
Finally, if you did Mood’s median test, you need this one:</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb176-1" title="1"><span class="kw">pairwise_median_test</span>(toms2, growthrate, colour)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   g1    g2       p_value adj_p_value
##   &lt;chr&gt; &lt;chr&gt;      &lt;dbl&gt;       &lt;dbl&gt;
## 1 blue  green  0.0000633    0.000380
## 2 blue  red    0.0000633    0.000380
## 3 blue  yellow 0.317        1       
## 4 green red    0.0000633    0.000380
## 5 green yellow 0.0000633    0.000380
## 6 red   yellow 0.0000633    0.000380</code></pre>
<p>Same conclusions again. This is what I would have guessed; the
conclusions from Tukey were so clear-cut that it really didn’t matter
which way you went; you’d come to the same conclusion.</p>
<p>That said, what I am looking for from you is a sensible choice of
analysis of variance (ANOVA, Welch’s ANOVA or Mood’s median test) for
a good reason, followed by the <em>right</em> follow-up for the test you
did. Even though the conclusions are all the same no matter what you
do here, I want you to get
used to following the right method, so that you will be able to do the
right thing when it <em>does</em> matter.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="pain-relief-in-migraine-headaches-again-1" class="section level2">
<h2><span class="header-section-number">17.17</span> Pain relief in migraine headaches (again)</h2>
<p>The data in
<a href="http://ritsokiguess.site/datafiles/migraine.txt">link</a> are from a
study of pain relief in migraine headaches. Specifically, 27 subjects
were randomly assigned to receive <em>one</em> of three pain relieving
drugs, labelled A, B and C. Each subject reported the number of hours
of pain relief they obtained (that is, the number of hours between
taking the drug and the migraine symptoms returning). A higher value
is therefore better. Can we make some recommendation about which drug
is best for the population of migraine sufferers?</p>
<ol style="list-style-type: lower-alpha">
<li>Read in and display the data. Take a look at the data
file first, and see if you can say why <code>read_table</code> will
work and <code>read_delim</code> will not.</li>
</ol>
<p>Solution</p>
<p>The key is two things: the data values are <em>lined up in columns</em>, and
<em>there is more than one space between values</em>.
The second thing is why <code>read_delim</code> will not
work. If you look carefully at the data file, you’ll see that
the column names are above and aligned with the columns, which
is what <code>read_table</code> wants. If the column names had
<em>not</em> been aligned with the columns, we would have needed
<code>read_table2</code>.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb178-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/migraine.txt&quot;</span></a>
<a class="sourceLine" id="cb178-2" title="2">migraine &lt;-<span class="st"> </span><span class="kw">read_table</span>(my_url)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   DrugA = col_double(),
##   DrugB = col_double(),
##   DrugC = col_double()
## )</code></pre>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb180-1" title="1">migraine</a></code></pre></div>
<pre><code>## # A tibble: 9 x 3
##   DrugA DrugB DrugC
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     4     6     6
## 2     5     8     7
## 3     4     4     6
## 4     3     5     6
## 5     2     4     7
## 6     4     6     5
## 7     3     5     6
## 8     4    11     5
## 9     4    10     5</code></pre>
<p>Success.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>What is it about the experimental design that makes a one-way
analysis of variance plausible for data like this?</li>
</ol>
<p>Solution</p>
<p>Each experimental subject only tested <em>one</em> drug, so that
we have 27 independent observations, nine from each drug. This
is exactly the setup that a one-way ANOVA requires.
Compare that to, for example, a situation where you had only 9
subjects, but they each tested <em>all</em> the drugs (so that
each subject produced three measurements). That is like a
three-measurement version of matched pairs, a so-called
<strong>repeated-measures design</strong>, which requires its own kind
of analysis.<a href="#fn30" class="footnote-ref" id="fnref30"><sup>30</sup></a></p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>What is wrong with the current format of the data as far as
doing a one-way ANOVA analysis is concerned? (This is related to the
idea of whether or not the data are “tidy”.)</li>
</ol>
<p>Solution</p>
<p>For our analysis, we need one column of pain relief time and one
column labelling the drug that the subject in question took.
Or, if you prefer to think about what would make these data
“tidy”: there are 27 subjects, so there ought to be 27 rows,
and all three columns are measurements of pain relief, so they
ought to be in one column.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>“Tidy” the data to produce a data frame suitable for your
analysis.</li>
</ol>
<p>Solution</p>
<p>This is <code>pivot_longer</code>. The column names are going to be stored in a column <code>drug</code>, and the corresponding values in a column called <code>painrelief</code> (use whatever names you like):</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb182-1" title="1">migraine <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb182-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>(), <span class="dt">names_to=</span><span class="st">&quot;drug&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;painrelief&quot;</span>) -&gt;<span class="st"> </span>migraine2</a></code></pre></div>
<p>Since I was making all the columns longer, I used the select-helper <code>everything()</code> to do that. Using instead <code>DrugA:DrugC</code> or <code>starts_with("Drug")</code> would also be good. Try them. <code>starts_with</code> is not case-sensitive, as far as I remember, so <code>starts_with("drug")</code> will also work here.</p>
<p>We do indeed have a new data frame with 27 rows, one per observation,
and 2 columns, one for each variable: the pain relief hours, plus a
column identifying which drug that pain relief time came from. Exactly
what <code>aov</code> needs.</p>
<p>You can probably devise a better name for your new data frame.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>Go ahead and run your one-way ANOVA (and Tukey if
necessary). Assume for this that the pain relief hours in each group
are sufficiently close to normally distributed with sufficiently
equal spreads.</li>
</ol>
<p>Solution</p>
<p>My last sentence absolves us from doing the boxplots that we
would normally insist on doing.</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb183-1" title="1">painrelief<span class="fl">.1</span> &lt;-<span class="st"> </span><span class="kw">aov</span>(painrelief <span class="op">~</span><span class="st"> </span>drug, <span class="dt">data =</span> migraine2)</a>
<a class="sourceLine" id="cb183-2" title="2"><span class="kw">summary</span>(painrelief<span class="fl">.1</span>)</a></code></pre></div>
<pre><code>##             Df Sum Sq Mean Sq F value  Pr(&gt;F)   
## drug         2  41.19   20.59   7.831 0.00241 **
## Residuals   24  63.11    2.63                   
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>There are (strongly) significant differences among the drugs, so it is
definitely worth firing up Tukey to figure out where the differences are:</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb185-1" title="1"><span class="kw">TukeyHSD</span>(painrelief<span class="fl">.1</span>)</a></code></pre></div>
<pre><code>##   Tukey multiple comparisons of means
##     95% family-wise confidence level
## 
## Fit: aov(formula = painrelief ~ drug, data = migraine2)
## 
## $drug
##                   diff        lwr      upr     p adj
## DrugB-DrugA  2.8888889  0.9798731 4.797905 0.0025509
## DrugC-DrugA  2.2222222  0.3132065 4.131238 0.0203671
## DrugC-DrugB -0.6666667 -2.5756824 1.242349 0.6626647</code></pre>
<p>Both the differences involving drug A are significant, and because a
high value of <code>painrelief</code> is better, in both cases drug A is
<em>worse</em> than the other drugs. Drugs B and C are not significantly
different from each other.</p>
<p>Extra: we can also use the “pipe” to do this all in one go:</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb187-1" title="1">migraine <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb187-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>(), <span class="dt">names_to=</span><span class="st">&quot;drug&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;painrelief&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb187-3" title="3"><span class="st">  </span><span class="kw">aov</span>(painrelief <span class="op">~</span><span class="st"> </span>drug, <span class="dt">data =</span> .) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb187-4" title="4"><span class="st">  </span><span class="kw">summary</span>()</a></code></pre></div>
<pre><code>##             Df Sum Sq Mean Sq F value  Pr(&gt;F)   
## drug         2  41.19   20.59   7.831 0.00241 **
## Residuals   24  63.11    2.63                   
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>with the same results as before. Notice that I never actually created
a second data frame by name; it was created by <code>pivot_longer</code> and
then immediately used as input to <code>aov</code>.<a href="#fn31" class="footnote-ref" id="fnref31"><sup>31</sup></a>
I also used the
<code>data=.</code> trick to use “the data frame that came out of the previous step” as my input to <code>aov</code>.</p>
<p>Read the above like this: “take <code>migraine</code>, and then make everything longer, creating new columns <code>drug</code> and <code>painrelief</code>, and then do an ANOVA of <code>painrelief</code> by <code>drug</code>, and then summarize the results.”</p>
<p>What is even more alarming is that I can feed the output from
<code>aov</code> straight into <code>TukeyHSD</code>:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb189-1" title="1">migraine <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb189-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>(), <span class="dt">names_to=</span><span class="st">&quot;drug&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;painrelief&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb189-3" title="3"><span class="st">  </span><span class="kw">aov</span>(painrelief <span class="op">~</span><span class="st"> </span>drug, <span class="dt">data =</span> .) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb189-4" title="4"><span class="st">  </span><span class="kw">TukeyHSD</span>()</a></code></pre></div>
<pre><code>##   Tukey multiple comparisons of means
##     95% family-wise confidence level
## 
## Fit: aov(formula = painrelief ~ drug, data = .)
## 
## $drug
##                   diff        lwr      upr     p adj
## DrugB-DrugA  2.8888889  0.9798731 4.797905 0.0025509
## DrugC-DrugA  2.2222222  0.3132065 4.131238 0.0203671
## DrugC-DrugB -0.6666667 -2.5756824 1.242349 0.6626647</code></pre>
<p>I wasn’t sure whether this would work, since the output from
<code>aov</code> is an R <code>list</code> rather than a data frame, but the
output from <code>aov</code> is sent into <code>TukeyHSD</code> whatever
kind of thing it is.</p>
<p>What I am missing here is to display the result of <code>aov</code>
<em>and</em> use it as input to <code>TukeyHSD</code>. Of course, I had to
discover that this could be solved, and indeed it can:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb191-1" title="1">migraine <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">everything</span>(), <span class="dt">names_to=</span><span class="st">&quot;drug&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;painrelief&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-3" title="3"><span class="st">  </span><span class="kw">aov</span>(painrelief <span class="op">~</span><span class="st"> </span>drug, <span class="dt">data =</span> .) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-4" title="4"><span class="st">  </span>{</a>
<a class="sourceLine" id="cb191-5" title="5">    <span class="kw">print</span>(<span class="kw">summary</span>(.))</a>
<a class="sourceLine" id="cb191-6" title="6">    .</a>
<a class="sourceLine" id="cb191-7" title="7">  } <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-8" title="8"><span class="st">  </span><span class="kw">TukeyHSD</span>()</a></code></pre></div>
<pre><code>##             Df Sum Sq Mean Sq F value  Pr(&gt;F)   
## drug         2  41.19   20.59   7.831 0.00241 **
## Residuals   24  63.11    2.63                   
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre><code>##   Tukey multiple comparisons of means
##     95% family-wise confidence level
## 
## Fit: aov(formula = painrelief ~ drug, data = .)
## 
## $drug
##                   diff        lwr      upr     p adj
## DrugB-DrugA  2.8888889  0.9798731 4.797905 0.0025509
## DrugC-DrugA  2.2222222  0.3132065 4.131238 0.0203671
## DrugC-DrugB -0.6666667 -2.5756824 1.242349 0.6626647</code></pre>
<p>The odd-looking second-last line of that again uses the <code>.</code> trick
for “whatever came out of the previous step”. The thing inside the
curly brackets is two commands one after the other; the first is to
display the <code>summary</code> of that <code>aov</code><a href="#fn32" class="footnote-ref" id="fnref32"><sup>32</sup></a>
and the second is to just pass whatever came out of the
previous line, the output from <code>aov</code>, on, unchanged, into
<code>TukeyHSD</code>.</p>
<p>In the Unix/Linux world this is called <code>tee</code>,
where you print something <em>and</em> pass it on to the next step. The
name <code>tee</code> comes from a (real physical) pipe that plumbers would use to
split water flow into two, which looks like a letter T.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="6" style="list-style-type: lower-alpha">
<li>What recommendation would you make about the best drug or
drugs? Explain briefly.</li>
</ol>
<p>Solution</p>
<p>Drug A is significantly the worst, so we eliminate that. But
there is no significant difference between drugs B and C, so we
have no reproducible reason for preferring one rather than the
other. Thus, we recommend “either B or C”.
If you weren’t sure which way around the drugs actually came
out, then you should work out the mean pain relief score by
drug:</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb194-1" title="1">migraine2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb194-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(drug) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb194-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">m =</span> <span class="kw">mean</span>(painrelief))</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   drug      m
##   &lt;chr&gt; &lt;dbl&gt;
## 1 DrugA  3.67
## 2 DrugB  6.56
## 3 DrugC  5.89</code></pre>
<p>These confirm that A is worst, and there is nothing much to choose
between B and C.
You should <em>not</em> recommend drug B over drug C on this evidence,
just because its (sample) mean is higher. The point about significant
differences is that they are supposed to stand up to replication: in
another experiment, or in real-life experiences with these drugs, the
mean pain relief score for drug A is expected to be worst, but between
drugs B and C, sometimes the mean of B will come out higher and
sometimes C’s mean will be higher, because there is no significant
difference between them.<a href="#fn33" class="footnote-ref" id="fnref33"><sup>33</sup></a>
Another way is to draw a boxplot of pain-relief scores:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb196-1" title="1"><span class="kw">ggplot</span>(migraine2, <span class="kw">aes</span>(<span class="dt">x =</span> drug, <span class="dt">y =</span> painrelief)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-129-1.png" width="672" /></p>
<p>The medians of drugs B and C are actually exactly the same. Because
the pain relief values are all whole numbers (and there are only 9 in
each group), you get that thing where enough of them are equal that
the median and third quartiles are equal, actually for two of the three
groups.</p>
<p>Despite the weird distributions, I’m willing to call these groups sufficiently
symmetric for the ANOVA to be OK, but I didn’t ask you to draw the
boxplot, because I didn’t want to confuse the issue with this. The
point of this question was to get the data tidy enough to do an
analysis.</p>
<p>As I said, I didn’t want you to have to get into this, but if you are
worried, you know what the remedy is — Mood’s median test. Don’t
forget to use the right data frame:</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb197-1" title="1"><span class="kw">library</span>(smmr)</a>
<a class="sourceLine" id="cb197-2" title="2"><span class="kw">median_test</span>(migraine2, painrelief, drug)</a></code></pre></div>
<pre><code>## $table
##        above
## group   above below
##   DrugA     0     8
##   DrugB     5     2
##   DrugC     6     0
## 
## $test
##        what        value
## 1 statistic 1.527273e+01
## 2        df 2.000000e+00
## 3   P-value 4.825801e-04</code></pre>
<p>Because the pain relief scores are integers, there are probably a lot
of them equal to the overall median. There were 27 observations
altogether, but Mood’s median test will discard any that are equal to
this value. There must have been 9 observations in each group to start
with, but if you look at each row of the table, there are only 8
observations listed for drug A, 7 for drug B and 6 for drug C, so
there must have been 1, 2 and 3 (totalling 6) observations equal to
the median that were discarded.</p>
<p>The P-value is a little bigger than came out of the <span class="math inline">\(F\)</span>-test, but the
conclusion is still that there are definitely differences among the
drugs in terms of pain relief. The table at the top of the output
again suggests that drug A is worse than the others, but to confirm
that you’d have to do Mood’s median test on all three <em>pairs</em> of
drugs, and then use Bonferroni to allow for your having done three tests:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb199-1" title="1"><span class="kw">pairwise_median_test</span>(migraine2, painrelief, drug)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 4
##   g1    g2     p_value adj_p_value
##   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;       &lt;dbl&gt;
## 1 DrugA DrugB 0.00721     0.0216  
## 2 DrugA DrugC 0.000183    0.000548
## 3 DrugB DrugC 0.921       1</code></pre>
<p>Drug A gives worse pain relief (fewer hours) than both drugs B and C,
which are not significantly different from each hour. This is exactly
what you would have guessed from the boxplot.</p>
<p>I adjusted the P-values as per Bonferroni by multiplying them by 3 (so that I could still compare with 0.05), but it makes no sense to have a P-value, which is a probability, greater than 1, so an “adjusted P-value” that comes out greater than 1 is rounded back down to 1. You interpret this as being “no evidence at all of a difference in medians” between drugs B and C.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="location-species-and-disease-in-plants-1" class="section level2">
<h2><span class="header-section-number">17.18</span> Location, species and disease in plants</h2>
<p>The table below is a “contingency table”, showing
frequencies of diseased and undiseased plants of two different species
in two different locations:</p>
<pre><code>
Species     Disease present         Disease absent
Location X Location Y  Location X Location Y
A            44         12          38        10
B            28         22          20        18
</code></pre>
<p>The data were saved as
<a href="http://ritsokiguess.site/datafiles/disease.txt">link</a>. In that
file, the columns are coded by two letters: a <code>p</code> or an
<code>a</code> to denote presence or absence of disease, and an <code>x</code>
or a <code>y</code> to denote location X or Y. The data are separated by
multiple spaces and aligned with the variable names.</p>
<ol style="list-style-type: lower-alpha">
<li>Read in and display the data.</li>
</ol>
<p>Solution</p>
<p><code>read_table</code> again. You know this because, when you looked
at the data file, which of course you did (didn’t you?), you saw
that the data values were aligned by columns with multiple spaces
between them:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb202-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/disease.txt&quot;</span></a>
<a class="sourceLine" id="cb202-2" title="2">tbl &lt;-<span class="st"> </span><span class="kw">read_table</span>(my_url)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   Species = col_character(),
##   px = col_double(),
##   py = col_double(),
##   ax = col_double(),
##   ay = col_double()
## )</code></pre>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb204-1" title="1">tbl</a></code></pre></div>
<pre><code>## # A tibble: 2 x 5
##   Species    px    py    ax    ay
##   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 A          44    12    38    10
## 2 B          28    22    20    18</code></pre>
<p>I was thinking ahead, since I’ll be wanting to have one of my columns
called <code>disease</code>, so I’m <em>not</em> calling the data frame
<code>disease</code>.</p>
<p>You’ll also have noticed that I simplified the data frame that I had
you read in, because the original contingency table I showed you has
<em>two</em> header rows, and we have to have <em>one</em> header row. So
I mixed up the information in the two header rows into one.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Explain briefly how these data are not “tidy”.</li>
</ol>
<p>Solution</p>
<p>The simple answer is that there are 8 frequencies, that each ought
to be in a row by themselves. Or, if you like, there are three
variables, Species, Disease status and Location, and each of
<em>those</em> should be in a <em>column</em> of its own.
Either one
of these ideas, or something like it, is good. I need you to
demonstrate that you know something about “tidy data” in this context.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>Use a suitable <code>tidyr</code> tool to get all the things
that are the same into a single column. (You’ll need to make up a
temporary name for the other new column that you create.) Show your
result.</li>
</ol>
<p>Solution</p>
<p><code>pivot_longer</code> is the tool. All the columns apart from
<code>Species</code> contain frequencies.
They are frequencies in disease-location combinations, so
I’ll call the column of “names” <code>disloc</code>. Feel
free to call it <code>temp</code> for now if you prefer:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb206-1" title="1">tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>Species, <span class="dt">names_to=</span><span class="st">&quot;disloc&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;frequency&quot;</span>) -&gt;<span class="st"> </span>tbl<span class="fl">.2</span></a>
<a class="sourceLine" id="cb206-2" title="2">tbl<span class="fl">.2</span></a></code></pre></div>
<pre><code>## # A tibble: 8 x 3
##   Species disloc frequency
##   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt;
## 1 A       px            44
## 2 A       py            12
## 3 A       ax            38
## 4 A       ay            10
## 5 B       px            28
## 6 B       py            22
## 7 B       ax            20
## 8 B       ay            18</code></pre>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>Explain briefly how the data frame you just created is
still not “tidy” yet.</li>
</ol>
<p>Solution</p>
<p>The column I called <code>disloc</code> actually contains <em>two</em>
variables, disease and location, which need to be split up. A
check on this is that we
have two columns (not including the frequencies), but back in
(b) we found <em>three</em> variables, so there
ought to be three non-frequency columns.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>Use one more <code>tidyr</code> tool to make these data tidy,
and show your result.</li>
</ol>
<p>Solution</p>
<p>This means splitting up <code>disloc</code> into two separate columns,
splitting after the first character, thus:</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb208-1" title="1">(tbl<span class="fl">.2</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">separate</span>(disloc, <span class="kw">c</span>(<span class="st">&quot;disease&quot;</span>, <span class="st">&quot;location&quot;</span>), <span class="dv">1</span>) -&gt;<span class="st"> </span>tbl<span class="fl">.3</span>)</a></code></pre></div>
<pre><code>## # A tibble: 8 x 4
##   Species disease location frequency
##   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;        &lt;dbl&gt;
## 1 A       p       x               44
## 2 A       p       y               12
## 3 A       a       x               38
## 4 A       a       y               10
## 5 B       p       x               28
## 6 B       p       y               22
## 7 B       a       x               20
## 8 B       a       y               18</code></pre>
<p>This is now tidy: eight frequencies in rows, and three non-frequency
columns. (Go back and look at your answer to part (b)
and note that the issues you found there have all been resolved now.)</p>
<p>Extra: my reading of one of the vignettes (the one called <code>pivot</code>) for <code>tidyr</code> suggests that <code>pivot_longer</code> can do both the making longer and the separating in one shot:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb210-1" title="1">tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>Species, <span class="dt">names_to=</span><span class="kw">c</span>(<span class="st">&quot;disease&quot;</span>, <span class="st">&quot;location&quot;</span>), <span class="dt">names_sep=</span><span class="dv">1</span>, <span class="dt">values_to=</span><span class="st">&quot;frequency&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 8 x 4
##   Species disease location frequency
##   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;        &lt;dbl&gt;
## 1 A       p       x               44
## 2 A       p       y               12
## 3 A       a       x               38
## 4 A       a       y               10
## 5 B       p       x               28
## 6 B       p       y               22
## 7 B       a       x               20
## 8 B       a       y               18</code></pre>
<p>And I (amazingly) got that right first time!</p>
<p>The idea is that you recognize that the column names are actually two things: a disease status and a location. To get <code>pivot_longer</code> to recognize that, you put two things in the <code>names_to</code>. Then you have to say how the two things in the columns are separated: this might be by an underscore or a dot, or, as here, “after the first character” (just as in <code>separate</code>). Using two names and some indication of what separates them then does a combined pivot-longer-and-separate, all in one shot.</p>
<p>The more I use <code>pivot_longer</code>, the more I marvel at the excellence of its design: it seems to be easy to guess how to make things work.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="6" style="list-style-type: lower-alpha">
<li>Let’s see if we can re-construct the original contingency
table (or something equivalent to it). Use the function
<code>xtabs</code>. This requires first a model formula with the frequency
variable on the left of the squiggle, and the other variables
separated by plus signs on the right. Second it requires a data
frame, with <code>data=</code>. Feed
your data frame from the previous part into <code>xtabs</code>. Save the
result in a variable and display the result.</li>
</ol>
<p>Solution</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb212-1" title="1">tbl<span class="fl">.4</span> &lt;-<span class="st"> </span><span class="kw">xtabs</span>(frequency <span class="op">~</span><span class="st"> </span>Species <span class="op">+</span><span class="st"> </span>disease <span class="op">+</span><span class="st"> </span>location, <span class="dt">data =</span> tbl<span class="fl">.3</span>)</a>
<a class="sourceLine" id="cb212-2" title="2">tbl<span class="fl">.4</span></a></code></pre></div>
<pre><code>## , , location = x
## 
##        disease
## Species  a  p
##       A 38 44
##       B 20 28
## 
## , , location = y
## 
##        disease
## Species  a  p
##       A 10 12
##       B 18 22</code></pre>
<p>This shows a pair of contingency tables, one each for each of the two
locations (in general, the variable you put last on the right side of
the model formula). You can check that everything corresponds with the
original data layout at the beginning of the question, possibly with
some things rearranged (but with the same frequencies in the same
places).</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="7" style="list-style-type: lower-alpha">
<li>Take the output from the last part and feed it into the
function <code>ftable</code>. How has the output been changed? Which do
you like better? Explain briefly.</li>
</ol>
<p>Solution</p>
<p>This:</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb214-1" title="1"><span class="kw">ftable</span>(tbl<span class="fl">.4</span>)</a></code></pre></div>
<pre><code>##                 location  x  y
## Species disease               
## A       a                38 10
##         p                44 12
## B       a                20 18
##         p                28 22</code></pre>
<p>This is the same output, but shown more compactly. (Rather like a
vertical version of the original data, in fact.) I like
<code>ftable</code> better because it displays the data in the smallest
amount of space, though I’m fine if you prefer the <code>xtabs</code>
output because it spreads things out more. This is a matter of
taste. Pick one and tell me why you prefer it, and I’m good.</p>
<p>That’s the end of what you had to do, but I thought I would do some
modelling and try to find out what’s associated with disease. The
appropriate modelling with frequencies is called “log-linear modelling”,
and it assumes that the log of the frequencies has a
linear relationship with the effects of the other variables. This is
not quite as simple as the log transformations we had before, because
bigger frequencies are going to be more variable, so we fit a
generalized linear model with a Poisson-distributed response and log
link. (It’s better if you know what that means, but you ought to be
able to follow the logic if you don’t. <a href="http://ritsokiguess.site/pasias/frequency-table-analysis.html#frequency-table-analysis">Chapter 29</a> has more on this.)</p>
<p>First, fit a model predicting frequency from everything, including all
the interactions. (The reason for doing it this way will become clear later):</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb216-1" title="1">model<span class="fl">.1</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(frequency <span class="op">~</span><span class="st"> </span>Species <span class="op">*</span><span class="st"> </span>location <span class="op">*</span><span class="st"> </span>disease, <span class="dt">data =</span> tbl<span class="fl">.3</span>, <span class="dt">family =</span> <span class="st">&quot;poisson&quot;</span>)</a>
<a class="sourceLine" id="cb216-2" title="2"><span class="kw">drop1</span>(model<span class="fl">.1</span>, <span class="dt">test =</span> <span class="st">&quot;Chisq&quot;</span>)</a></code></pre></div>
<pre><code>## Single term deletions
## 
## Model:
## frequency ~ Species * location * disease
##                          Df Deviance    AIC      LRT Pr(&gt;Chi)
## &lt;none&gt;                      0.000000 55.291                  
## Species:location:disease  1 0.070257 53.362 0.070257    0.791</code></pre>
<p>The residuals are all zero because this model fits perfectly. The
problem is that it is very complicated, so it offers no insight. So
what we do is to look at the highest-order interaction
<code>Species:location:disease</code> and see whether it is
significant. It is not, so we can remove it. This is reminiscent of
variable selection in regression, where we pull the least significant
thing out of the model in turn until we can go no further. But here,
we have additional things to think about: we have to get rid of all
the three-way interactions before we can tackle the two-way ones, and
all the two-way ones before we can tackle the main effects. There is a
so-called “nested” structure happening here that says you don’t look
at, say, <code>Species</code>, until you have removed <em>all</em> the
higher-order interactions involving <code>Species</code>. Not clear yet?
Don’t fret. <code>drop1</code> allows you to assess what is currently up
for grabs (here, only the three-way interaction, which is not
significant, so out it comes).</p>
<p>Let’s get rid of that three-way interaction. This is another use for
<code>update</code> that you might have seen in connection with multiple regression
(to make small changes to a big model):</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb218-1" title="1">model<span class="fl">.2</span> &lt;-<span class="st"> </span><span class="kw">update</span>(model<span class="fl">.1</span>, . <span class="op">~</span><span class="st"> </span>. <span class="op">-</span><span class="st"> </span>Species<span class="op">:</span>location<span class="op">:</span>disease)</a>
<a class="sourceLine" id="cb218-2" title="2"><span class="kw">drop1</span>(model<span class="fl">.2</span>, <span class="dt">test =</span> <span class="st">&quot;Chisq&quot;</span>)</a></code></pre></div>
<pre><code>## Single term deletions
## 
## Model:
## frequency ~ Species + location + disease + Species:location + 
##     Species:disease + location:disease
##                  Df Deviance    AIC     LRT  Pr(&gt;Chi)    
## &lt;none&gt;                0.0703 53.362                      
## Species:location  1  13.0627 64.354 12.9924 0.0003128 ***
## Species:disease   1   0.2696 51.561  0.1993 0.6552865    
## location:disease  1   0.1043 51.396  0.0340 0.8536877    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Notice how <code>update</code> saved us having to write the whole model
out again.</p>
<p>Now the three two-way interactions are up for grabs:
<code>Species:location</code>, <code>Species:disease</code> and
<code>location:disease</code>. The last of these is the least significant,
so out it comes. I did some copying and pasting, but I had to remember
which model I was working with and what I was removing:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb220-1" title="1">model<span class="fl">.3</span> &lt;-<span class="st"> </span><span class="kw">update</span>(model<span class="fl">.2</span>, . <span class="op">~</span><span class="st"> </span>. <span class="op">-</span><span class="st"> </span>location<span class="op">:</span>disease)</a>
<a class="sourceLine" id="cb220-2" title="2"><span class="kw">drop1</span>(model<span class="fl">.3</span>, <span class="dt">test =</span> <span class="st">&quot;Chisq&quot;</span>)</a></code></pre></div>
<pre><code>## Single term deletions
## 
## Model:
## frequency ~ Species + location + disease + Species:location + 
##     Species:disease
##                  Df Deviance    AIC     LRT  Pr(&gt;Chi)    
## &lt;none&gt;                0.1043 51.396                      
## Species:location  1  13.0678 62.359 12.9635 0.0003176 ***
## Species:disease   1   0.2746 49.566  0.1703 0.6798021    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p><code>Species:disease</code> comes out, but it looks as if
<code>Species:location</code> will have to stay:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb222-1" title="1">model<span class="fl">.4</span> &lt;-<span class="st"> </span><span class="kw">update</span>(model<span class="fl">.3</span>, . <span class="op">~</span><span class="st"> </span>. <span class="op">-</span><span class="st"> </span>Species<span class="op">:</span>disease)</a>
<a class="sourceLine" id="cb222-2" title="2"><span class="kw">drop1</span>(model<span class="fl">.4</span>, <span class="dt">test =</span> <span class="st">&quot;Chisq&quot;</span>)</a></code></pre></div>
<pre><code>## Single term deletions
## 
## Model:
## frequency ~ Species + location + disease + Species:location
##                  Df Deviance    AIC     LRT  Pr(&gt;Chi)    
## &lt;none&gt;                0.2746 49.566                      
## disease           1   2.3617 49.653  2.0871 0.1485461    
## Species:location  1  13.2381 60.530 12.9635 0.0003176 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p><code>Species:location</code> indeed stays. That means that anything
“contained in” it also has to stay, regardless of its main
effect. So the only candidate for removal now is <code>disease</code>: not
significant, out it comes:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb224-1" title="1">model<span class="fl">.5</span> &lt;-<span class="st"> </span><span class="kw">update</span>(model<span class="fl">.4</span>, . <span class="op">~</span><span class="st"> </span>. <span class="op">-</span><span class="st"> </span>disease)</a>
<a class="sourceLine" id="cb224-2" title="2"><span class="kw">drop1</span>(model<span class="fl">.5</span>, <span class="dt">test =</span> <span class="st">&quot;Chisq&quot;</span>)</a></code></pre></div>
<pre><code>## Single term deletions
## 
## Model:
## frequency ~ Species + location + Species:location
##                  Df Deviance    AIC    LRT  Pr(&gt;Chi)    
## &lt;none&gt;                2.3617 49.653                     
## Species:location  1  15.3252 60.617 12.963 0.0003176 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>And now we have to stop.</p>
<p>What does this final model mean? Well, frequency depends significantly
on the <code>Species:location</code> combination, but not on anything
else. To see how, we make a contingency table of species by location
(totalling up over disease status, since that is not significant):</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb226-1" title="1"><span class="kw">xtabs</span>(frequency <span class="op">~</span><span class="st"> </span>Species <span class="op">+</span><span class="st"> </span>location, <span class="dt">data =</span> tbl<span class="fl">.3</span>)</a></code></pre></div>
<pre><code>##        location
## Species  x  y
##       A 82 22
##       B 48 40</code></pre>
<p>Most of the species A’s are at location X, but the species B’s are
about evenly divided between the two locations. Or, if you prefer
(equally good): location X has mostly species A, while location Y has
mostly species B. You can condition on either variable and compare the
conditional distribution of the other one.</p>
<p>Now, this is rather interesting, because this began as a study of
disease, but disease has completely disappeared from our final model!
That means that nothing in our final model has any relationship with
disease. Indeed, if you check the original table, you’ll find that
disease is present slightly more than it’s absent, for all
combinations of species and location. That is, neither species nor
location has any particular association with (effect on) disease,
since disease prevalence doesn’t change appreciably if you change
location, species or the combination of them.</p>
<p>The way an association with disease would show up is if a
<code>disease:</code>something interaction had been significant and had
stayed in the model, that something would have been associated with
disease. For example, if the <code>disease:Species</code> table had looked
like this:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb228-1" title="1">disease &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;p&quot;</span>, <span class="st">&quot;p&quot;</span>)</a>
<a class="sourceLine" id="cb228-2" title="2">Species &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>)</a>
<a class="sourceLine" id="cb228-3" title="3">frequency &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">30</span>, <span class="dv">30</span>)</a>
<a class="sourceLine" id="cb228-4" title="4">xx &lt;-<span class="st"> </span><span class="kw">tibble</span>(disease, Species, frequency)</a>
<a class="sourceLine" id="cb228-5" title="5"><span class="kw">xtabs</span>(frequency <span class="op">~</span><span class="st"> </span>disease <span class="op">+</span><span class="st"> </span>Species, <span class="dt">data=</span>xx)</a></code></pre></div>
<pre><code>##        Species
## disease  A  B
##       a 10 50
##       p 30 30</code></pre>
<p>For species A, disease is present 75% of the time, but for species B
it’s present less than 40% of the time. So in this one there ought to be a
significant association between disease and species:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb230-1" title="1">xx<span class="fl">.1</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(frequency <span class="op">~</span><span class="st"> </span>disease <span class="op">*</span><span class="st"> </span>Species, <span class="dt">data =</span> xx, <span class="dt">family =</span> <span class="st">&quot;poisson&quot;</span>)</a>
<a class="sourceLine" id="cb230-2" title="2"><span class="kw">drop1</span>(xx<span class="fl">.1</span>, <span class="dt">test =</span> <span class="st">&quot;Chisq&quot;</span>)</a></code></pre></div>
<pre><code>## Single term deletions
## 
## Model:
## frequency ~ disease * Species
##                 Df Deviance    AIC    LRT  Pr(&gt;Chi)    
## &lt;none&gt;                0.000 28.400                     
## disease:Species  1   15.518 41.918 15.518 8.171e-05 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>And so there is. Nothing can come out of the model. (This is the same
kind of test as a chi-squared test for association.<br />
The log-linear model is a multi-variable generalization of that.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="mating-songs-in-crickets-1" class="section level2">
<h2><span class="header-section-number">17.19</span> Mating songs in crickets</h2>
<p>Male tree crickets produce “mating songs” by rubbing their
wings together to produce a chirping sound. It is hypothesized that
female tree crickets identify males of the correct species by how fast
(in chirps per second) the male’s mating song is. This is called the
“pulse rate”. Some data for two species of crickets are in
<a href="http://ritsokiguess.site/datafiles/crickets.txt">link</a>. The
columns, which are unlabelled, are temperature and pulse rate
(respectively) for <em>Oecanthus exclamationis</em> (first two
columns) and <em>Oecanthus niveus</em> (third and fourth columns). The
columns are separated by tabs. There are some missing values in the
first two columns because fewer <em>exclamationis</em> crickets than
<em>niveus</em> crickets were measured.
The research question is whether males
of the different species have different average pulse rates. It is
also of interest to see whether temperature has an effect, and if
so, what.
Before we get to that, however, we have some data organization to do.</p>
<ol style="list-style-type: lower-alpha">
<li>Read in the data, allowing for the fact that you have no
column names. You’ll see that the
columns have names <code>X1</code> through <code>X4</code>. This is
OK.</li>
</ol>
<p>Solution</p>
<p>Tab-separated, so <code>read_tsv</code>; no column names, so <code>col_names=F</code>:</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb232-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/crickets.txt&quot;</span></a>
<a class="sourceLine" id="cb232-2" title="2">crickets &lt;-<span class="st"> </span><span class="kw">read_tsv</span>(my_url, <span class="dt">col_names =</span> F)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   X1 = col_double(),
##   X2 = col_double(),
##   X3 = col_double(),
##   X4 = col_double()
## )</code></pre>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb234-1" title="1">crickets</a></code></pre></div>
<pre><code>## # A tibble: 17 x 4
##       X1    X2    X3    X4
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  20.8  67.9  17.2  44.3
##  2  20.8  65.1  18.3  47.2
##  3  24    77.3  18.3  47.6
##  4  24    78.7  18.3  49.6
##  5  24    79.4  18.9  50.3
##  6  24    80.4  18.9  51.8
##  7  26.2  85.8  20.4  60  
##  8  26.2  86.6  21    58.5
##  9  26.2  87.5  21    58.9
## 10  26.2  89.1  22.1  60.7
## 11  28.4  98.6  23.5  69.8
## 12  29   101.   24.2  70.9
## 13  30.4  99.3  25.9  76.2
## 14  30.4 102.   26.5  76.1
## 15  NA    NA    26.5  77  
## 16  NA    NA    26.5  77.7
## 17  NA    NA    28.6  84.7</code></pre>
<p>As promised.</p>
<p>If you didn’t catch the tab-separated part, this probably happened to you:</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb236-1" title="1">d &lt;-<span class="st"> </span><span class="kw">read_delim</span>(my_url, <span class="st">&quot; &quot;</span>, <span class="dt">col_names =</span> F)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   X1 = col_character()
## )</code></pre>
<pre><code>## Warning: 3 parsing failures.
## row col  expected    actual                                              file
##  15  -- 1 columns 2 columns &#39;http://ritsokiguess.site/datafiles/crickets.txt&#39;
##  16  -- 1 columns 2 columns &#39;http://ritsokiguess.site/datafiles/crickets.txt&#39;
##  17  -- 1 columns 2 columns &#39;http://ritsokiguess.site/datafiles/crickets.txt&#39;</code></pre>
<p>This doesn’t look good:</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb239-1" title="1"><span class="kw">problems</span>(d)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##     row col   expected  actual    file                                             
##   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;                                            
## 1    15 &lt;NA&gt;  1 columns 2 columns &#39;http://ritsokiguess.site/datafiles/crickets.txt&#39;
## 2    16 &lt;NA&gt;  1 columns 2 columns &#39;http://ritsokiguess.site/datafiles/crickets.txt&#39;
## 3    17 &lt;NA&gt;  1 columns 2 columns &#39;http://ritsokiguess.site/datafiles/crickets.txt&#39;</code></pre>
<p>The “expected columns” being 1 should bother you, since we know
there are supposed to be 4 columns. At this point, we take a look at
what got read in:</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb241-1" title="1">d</a></code></pre></div>
<pre><code>## # A tibble: 17 x 1
##    X1                       
##    &lt;chr&gt;                    
##  1 &quot;20.8\t67.9\t17.2\t44.3&quot; 
##  2 &quot;20.8\t65.1\t18.3\t47.2&quot; 
##  3 &quot;24.0\t77.3\t18.3\t47.6&quot; 
##  4 &quot;24.0\t78.7\t18.3\t49.6&quot; 
##  5 &quot;24.0\t79.4\t18.9\t50.3&quot; 
##  6 &quot;24.0\t80.4\t18.9\t51.8&quot; 
##  7 &quot;26.2\t85.8\t20.4\t60.0&quot; 
##  8 &quot;26.2\t86.6\t21.0\t58.5&quot; 
##  9 &quot;26.2\t87.5\t21.0\t58.9&quot; 
## 10 &quot;26.2\t89.1\t22.1\t60.7&quot; 
## 11 &quot;28.4\t98.6\t23.5\t69.8&quot; 
## 12 &quot;29.0\t100.8\t24.2\t70.9&quot;
## 13 &quot;30.4\t99.3\t25.9\t76.2&quot; 
## 14 &quot;30.4\t101.7\t26.5\t76.1&quot;
## 15 &quot;NA\tNA&quot;                 
## 16 &quot;NA\tNA&quot;                 
## 17 &quot;NA\tNA&quot;</code></pre>
<p>and there you see the <code>t</code> or “tab” characters separating the
values, instead of spaces. (This is what I tried first, and once I
looked at this, I realized that <code>read_tsv</code> was what I needed.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Tidy these untidy data, going as directly as you can to something tidy. (Some later parts show you how it used to be done.) Begin by: (i) adding a column of row numbers, (ii) <code>rename</code>-ing the columns to species name, an underscore, and the variable contents (keeping <code>pulserate</code> as one word), and then use <code>pivot_longer</code>. Note that the column names encode <em>two</em> things.</li>
</ol>
<p>Solution</p>
<p>Take this one piece of the pipeline at a time: that is, first check that you got the renaming right and looking at what you have, before proceeding to the <code>pivot_longer</code>. The syntax of <code>rename</code> is new name equals old name, and I like to split this over several lines to make it easier to read:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb243-1" title="1">crickets <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb243-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">row=</span><span class="kw">row_number</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb243-3" title="3"><span class="st">  </span><span class="kw">rename</span>(</a>
<a class="sourceLine" id="cb243-4" title="4">    <span class="dt">exclamationis_temperature =</span> X1,</a>
<a class="sourceLine" id="cb243-5" title="5">    <span class="dt">exclamationis_pulserate =</span> X2,</a>
<a class="sourceLine" id="cb243-6" title="6">    <span class="dt">niveus_temperature =</span> X3,</a>
<a class="sourceLine" id="cb243-7" title="7">    <span class="dt">niveus_pulserate =</span> X4</a>
<a class="sourceLine" id="cb243-8" title="8">  ) </a></code></pre></div>
<pre><code>## # A tibble: 17 x 5
##    exclamationis_temperature exclamationis_pulserate niveus_temperature niveus_pulserate   row
##                        &lt;dbl&gt;                   &lt;dbl&gt;              &lt;dbl&gt;            &lt;dbl&gt; &lt;int&gt;
##  1                      20.8                    67.9               17.2             44.3     1
##  2                      20.8                    65.1               18.3             47.2     2
##  3                      24                      77.3               18.3             47.6     3
##  4                      24                      78.7               18.3             49.6     4
##  5                      24                      79.4               18.9             50.3     5
##  6                      24                      80.4               18.9             51.8     6
##  7                      26.2                    85.8               20.4             60       7
##  8                      26.2                    86.6               21               58.5     8
##  9                      26.2                    87.5               21               58.9     9
## 10                      26.2                    89.1               22.1             60.7    10
## 11                      28.4                    98.6               23.5             69.8    11
## 12                      29                     101.                24.2             70.9    12
## 13                      30.4                    99.3               25.9             76.2    13
## 14                      30.4                   102.                26.5             76.1    14
## 15                      NA                      NA                 26.5             77      15
## 16                      NA                      NA                 26.5             77.7    16
## 17                      NA                      NA                 28.6             84.7    17</code></pre>
<p>The first part of each column name is the species and the second part is what was measured each time, separated by an underscore. To handle that in <code>pivot_longer</code>, you give <em>two</em> names of new columns to create (in <code>names_to</code>), and say what they’re separated by:</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb245-1" title="1">crickets <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb245-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">row=</span><span class="kw">row_number</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb245-3" title="3"><span class="st">  </span><span class="kw">rename</span>(</a>
<a class="sourceLine" id="cb245-4" title="4">    <span class="dt">exclamationis_temperature =</span> X1,</a>
<a class="sourceLine" id="cb245-5" title="5">    <span class="dt">exclamationis_pulserate =</span> X2,</a>
<a class="sourceLine" id="cb245-6" title="6">    <span class="dt">niveus_temperature =</span> X3,</a>
<a class="sourceLine" id="cb245-7" title="7">    <span class="dt">niveus_pulserate =</span> X4</a>
<a class="sourceLine" id="cb245-8" title="8">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb245-9" title="9"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>row, <span class="dt">names_to=</span><span class="kw">c</span>(<span class="st">&quot;species&quot;</span>, <span class="st">&quot;measurement&quot;</span>), <span class="dt">names_sep=</span><span class="st">&quot;_&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;obs&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 68 x 4
##      row species       measurement   obs
##    &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;       &lt;dbl&gt;
##  1     1 exclamationis temperature  20.8
##  2     1 exclamationis pulserate    67.9
##  3     1 niveus        temperature  17.2
##  4     1 niveus        pulserate    44.3
##  5     2 exclamationis temperature  20.8
##  6     2 exclamationis pulserate    65.1
##  7     2 niveus        temperature  18.3
##  8     2 niveus        pulserate    47.2
##  9     3 exclamationis temperature  24  
## 10     3 exclamationis pulserate    77.3
## # … with 58 more rows</code></pre>
<p>This is tidy now, but we went a step too far: that column <code>measurement</code> should be <em>two</em> columns, called <code>temperature</code> and <code>pulserate</code>, which means it should be made wider:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb247-1" title="1">crickets <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb247-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">row=</span><span class="kw">row_number</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb247-3" title="3"><span class="st">  </span><span class="kw">rename</span>(</a>
<a class="sourceLine" id="cb247-4" title="4">    <span class="dt">exclamationis_temperature =</span> X1,</a>
<a class="sourceLine" id="cb247-5" title="5">    <span class="dt">exclamationis_pulserate =</span> X2,</a>
<a class="sourceLine" id="cb247-6" title="6">    <span class="dt">niveus_temperature =</span> X3,</a>
<a class="sourceLine" id="cb247-7" title="7">    <span class="dt">niveus_pulserate =</span> X4</a>
<a class="sourceLine" id="cb247-8" title="8">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb247-9" title="9"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>row, <span class="dt">names_to=</span><span class="kw">c</span>(<span class="st">&quot;species&quot;</span>, <span class="st">&quot;measurement&quot;</span>), <span class="dt">names_sep=</span><span class="st">&quot;_&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;obs&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb247-10" title="10"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from=</span>measurement, <span class="dt">values_from=</span>obs)</a></code></pre></div>
<pre><code>## # A tibble: 34 x 4
##      row species       temperature pulserate
##    &lt;int&gt; &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;
##  1     1 exclamationis        20.8      67.9
##  2     1 niveus               17.2      44.3
##  3     2 exclamationis        20.8      65.1
##  4     2 niveus               18.3      47.2
##  5     3 exclamationis        24        77.3
##  6     3 niveus               18.3      47.6
##  7     4 exclamationis        24        78.7
##  8     4 niveus               18.3      49.6
##  9     5 exclamationis        24        79.4
## 10     5 niveus               18.9      50.3
## # … with 24 more rows</code></pre>
<p>The row numbers are cricket-within-species, which isn’t very meaningful, but we needed something for the <code>pivot_wider</code> to key on, to recognize what needed to go in which row. The way it works is it uses anything not mentioned in <code>names_from</code> or <code>values_from</code> as a “key”: each unique combination belongs in a row. Here that would be the combination of row and species, which is a good key because each species appears once with each row number.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>If you found (b) a bit much to take in, the rest of the way we take a rather more leisurely approach towards the tidying.</li>
</ol>
<p>These data are rather far from being tidy. There need to be
three variables, temperature, pulse rate and species, and there
are <span class="math inline">\(14+17=31\)</span> observations altogether. This one is tricky in that
there are temperature and pulse rate for each of two levels of a
factor, so I’ll suggest combining the temperature and chirp rate
together into one thing for each species, then pivoting them longer (“combining”),
then pivoting them wider again (“splitting”). Create new columns, named for each species,
that contain the temperature and pulse rate for that species in
that order, <code>unite</code>d together.
For the rest of this question, start from the data frame you read
in, and build a pipe, one or two steps at a time, to save creating
a lot of temporary data frames.</p>
<p>Solution</p>
<p>Breathe, and then begin. <code>unite</code> creates new columns by
joining together old ones:<a href="#fn34" class="footnote-ref" id="fnref34"><sup>34</sup></a></p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb249-1" title="1">crickets <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb249-2" title="2"><span class="st">  </span><span class="kw">unite</span>(exclamationis, X1<span class="op">:</span>X2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb249-3" title="3"><span class="st">  </span><span class="kw">unite</span>(niveus, X3<span class="op">:</span>X4)</a></code></pre></div>
<pre><code>## # A tibble: 17 x 2
##    exclamationis niveus   
##    &lt;chr&gt;         &lt;chr&gt;    
##  1 20.8_67.9     17.2_44.3
##  2 20.8_65.1     18.3_47.2
##  3 24_77.3       18.3_47.6
##  4 24_78.7       18.3_49.6
##  5 24_79.4       18.9_50.3
##  6 24_80.4       18.9_51.8
##  7 26.2_85.8     20.4_60  
##  8 26.2_86.6     21_58.5  
##  9 26.2_87.5     21_58.9  
## 10 26.2_89.1     22.1_60.7
## 11 28.4_98.6     23.5_69.8
## 12 29_100.8      24.2_70.9
## 13 30.4_99.3     25.9_76.2
## 14 30.4_101.7    26.5_76.1
## 15 NA_NA         26.5_77  
## 16 NA_NA         26.5_77.7
## 17 NA_NA         28.6_84.7</code></pre>
<p>Note that the original columns <code>X1:X4</code> are <em>gone</em>, which
is fine, because the information we needed from them is contained in
the two new columns. <code>unite</code> by default uses an underscore to
separate the joined-together values, which is generally safe since you
won’t often find those in data.</p>
<p>Digression: <code>unite</code>-ing with a space could cause problems if
the data values have spaces in them already. Consider this list of names:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb251-1" title="1">names &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Cameron McDonald&quot;</span>, <span class="st">&quot;Durwin Yang&quot;</span>, <span class="st">&quot;Ole Gunnar Solskjaer&quot;</span>, <span class="st">&quot;Mahmudullah&quot;</span>)</a></code></pre></div>
<p>Two very former students of mine, a Norwegian soccer player, and a
Bangladeshi cricketer. Only one of these has played for Manchester United:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb252-1" title="1">manu &lt;-<span class="st"> </span><span class="kw">c</span>(F, F, T, F)</a></code></pre></div>
<p>and let’s make a data frame:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb253-1" title="1">d &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">name =</span> names, <span class="dt">manu =</span> manu)</a>
<a class="sourceLine" id="cb253-2" title="2">d</a></code></pre></div>
<pre><code>## # A tibble: 4 x 2
##   name                 manu 
##   &lt;chr&gt;                &lt;lgl&gt;
## 1 Cameron McDonald     FALSE
## 2 Durwin Yang          FALSE
## 3 Ole Gunnar Solskjaer TRUE 
## 4 Mahmudullah          FALSE</code></pre>
<p>Now, what happens if we <code>unite</code> those columns, separating them
by a space?</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb255-1" title="1">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unite</span>(joined, name<span class="op">:</span>manu, <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 1
##   joined                   
##   &lt;chr&gt;                    
## 1 Cameron McDonald FALSE   
## 2 Durwin Yang FALSE        
## 3 Ole Gunnar Solskjaer TRUE
## 4 Mahmudullah FALSE</code></pre>
<p>If we then try to separate them again, what happens?</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb257-1" title="1">d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb257-2" title="2"><span class="st">  </span><span class="kw">unite</span>(joined, name<span class="op">:</span>manu, <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb257-3" title="3"><span class="st">  </span><span class="kw">separate</span>(joined, <span class="kw">c</span>(<span class="st">&quot;one&quot;</span>, <span class="st">&quot;two&quot;</span>), <span class="st">&quot; &quot;</span>)</a></code></pre></div>
<pre><code>## Warning: Expected 2 pieces. Additional pieces discarded in 3 rows [1, 2, 3].</code></pre>
<pre><code>## # A tibble: 4 x 2
##   one         two     
##   &lt;chr&gt;       &lt;chr&gt;   
## 1 Cameron     McDonald
## 2 Durwin      Yang    
## 3 Ole         Gunnar  
## 4 Mahmudullah FALSE</code></pre>
<p>Things have gotten lost: most of the original values of <code>manu</code>
and some of the names. If we use a different separator character,
either choosing one deliberately or going with the default underscore,
everything works swimmingly:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb260-1" title="1">d <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb260-2" title="2"><span class="st">  </span><span class="kw">unite</span>(joined, name<span class="op">:</span>manu, <span class="dt">sep =</span> <span class="st">&quot;:&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb260-3" title="3"><span class="st">  </span><span class="kw">separate</span>(joined, <span class="kw">c</span>(<span class="st">&quot;one&quot;</span>, <span class="st">&quot;two&quot;</span>), <span class="st">&quot;:&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 2
##   one                  two  
##   &lt;chr&gt;                &lt;chr&gt;
## 1 Cameron McDonald     FALSE
## 2 Durwin Yang          FALSE
## 3 Ole Gunnar Solskjaer TRUE 
## 4 Mahmudullah          FALSE</code></pre>
<p>and we are back to where we started.</p>
<p>If you run just the <code>unite</code> line (move the pipe symbol to the
next line so that the <code>unite</code> line is complete as it stands),
you’ll see what happened.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>The two columns <code>exclamationis</code> and <code>niveus</code>
that you just created are both temperature-pulse rate combos, but
for different species. Collect them together into one
column, labelled by species. (This is a straight <code>tidyr</code> <code>pivot_longer</code>, even though the columns contain something odd-looking.)</li>
</ol>
<p>Solution</p>
<p>Thus, this, naming the new column <code>temp_pulse</code> since it
contains both of those things. Add to the end of the pipe you
started building in the previous part:</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb262-1" title="1">crickets <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb262-2" title="2"><span class="st">  </span><span class="kw">unite</span>(exclamationis, X1<span class="op">:</span>X2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb262-3" title="3"><span class="st">  </span><span class="kw">unite</span>(niveus, X3<span class="op">:</span>X4) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb262-4" title="4"><span class="st">  </span><span class="kw">pivot_longer</span>(exclamationis<span class="op">:</span>niveus, <span class="dt">names_to =</span> <span class="st">&quot;species&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;temp_pulse&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 34 x 2
##    species       temp_pulse
##    &lt;chr&gt;         &lt;chr&gt;     
##  1 exclamationis 20.8_67.9 
##  2 niveus        17.2_44.3 
##  3 exclamationis 20.8_65.1 
##  4 niveus        18.3_47.2 
##  5 exclamationis 24_77.3   
##  6 niveus        18.3_47.6 
##  7 exclamationis 24_78.7   
##  8 niveus        18.3_49.6 
##  9 exclamationis 24_79.4   
## 10 niveus        18.9_50.3 
## # … with 24 more rows</code></pre>
<p>Yep. You’ll see both species of
crickets, and you’ll see some missing values at the bottom, labelled,
at the moment, <code>NA_NA</code>.</p>
<p>This is going to get rather long, but don’t fret: we debugged the two
<code>unite</code> lines before, so if you get any errors, they must
have come from the <code>pivot_longer</code>. So that would be the place to check.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>Now split up the temperature-pulse combos at the underscore, into
two separate columns. This is <code>separate</code>. When specifying
what to separate by, you can use a number (“split after this many characters”) or a piece of text, in quotes (“when you see this text, split at it”).</li>
</ol>
<p>Solution</p>
<p>The text to split by is an underscore (in quotes), since
<code>unite</code> by default puts an underscore in between the
values it pastes together. Glue the <code>separate</code> onto the
end. We are creating two new variables <code>temperature</code> and
<code>pulse_rate</code>:</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb264-1" title="1">crickets <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb264-2" title="2"><span class="st">  </span><span class="kw">unite</span>(exclamationis, X1<span class="op">:</span>X2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb264-3" title="3"><span class="st">  </span><span class="kw">unite</span>(niveus, X3<span class="op">:</span>X4) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb264-4" title="4"><span class="st">  </span><span class="kw">pivot_longer</span>(exclamationis<span class="op">:</span>niveus, <span class="dt">names_to =</span> <span class="st">&quot;species&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;temp_pulse&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb264-5" title="5"><span class="st">  </span><span class="kw">separate</span>(temp_pulse, <span class="kw">c</span>(<span class="st">&quot;temperature&quot;</span>, <span class="st">&quot;pulse_rate&quot;</span>), <span class="st">&quot;_&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 34 x 3
##    species       temperature pulse_rate
##    &lt;chr&gt;         &lt;chr&gt;       &lt;chr&gt;     
##  1 exclamationis 20.8        67.9      
##  2 niveus        17.2        44.3      
##  3 exclamationis 20.8        65.1      
##  4 niveus        18.3        47.2      
##  5 exclamationis 24          77.3      
##  6 niveus        18.3        47.6      
##  7 exclamationis 24          78.7      
##  8 niveus        18.3        49.6      
##  9 exclamationis 24          79.4      
## 10 niveus        18.9        50.3      
## # … with 24 more rows</code></pre>
<p>You’ll note that <code>unite</code> and <code>separate</code> are opposites (“inverses”) of each other, but we haven’t just done something and then undone it, because we have a <code>pivot_longer</code> in between; in fact, arranging it this way has done precisely the tidying we wanted.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="6" style="list-style-type: lower-alpha">
<li>Almost there. Temperature and pulse rate are still text
(because <code>unite</code> turned them into text), but they should be
numbers. Create new variables that are numerical versions of
temperature and pulse rate (using <code>as.numeric</code>). Check that
you have no extraneous variables (and, if necessary, get rid of
the ones you don’t want). (Species is also text and really ought
to be a factor, but having it as text doesn’t seem to cause any
problems.)
You can, if you like, use <code>parse_number</code> instead of
<code>as.numeric</code>. They should both work. The distinction I
prefer to make is that <code>parse_number</code> is good for text
with a number in it (that we want to pull the number out of),
while <code>as.numeric</code> is for turning something that looks like
a number but isn’t one into a genuine number.<a href="#fn35" class="footnote-ref" id="fnref35"><sup>35</sup></a></li>
</ol>
<p>Solution</p>
<p><code>mutate</code>-ing into a column that already exists overwrites
the variable that’s already there (which saves us some effort
here).</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb266-1" title="1">crickets<span class="fl">.1</span> &lt;-<span class="st"> </span>crickets <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb266-2" title="2"><span class="st">  </span><span class="kw">unite</span>(exclamationis, X1<span class="op">:</span>X2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb266-3" title="3"><span class="st">  </span><span class="kw">unite</span>(niveus, X3<span class="op">:</span>X4) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb266-4" title="4"><span class="st">  </span><span class="kw">pivot_longer</span>(exclamationis<span class="op">:</span>niveus, <span class="dt">names_to =</span> <span class="st">&quot;species&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;temp_pulse&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb266-5" title="5"><span class="st">  </span><span class="kw">separate</span>(temp_pulse, <span class="kw">c</span>(<span class="st">&quot;temperature&quot;</span>, <span class="st">&quot;pulse_rate&quot;</span>), <span class="st">&quot;_&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb266-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">temperature =</span> <span class="kw">as.numeric</span>(temperature)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb266-7" title="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pulse_rate =</span> <span class="kw">as.numeric</span>(pulse_rate))</a></code></pre></div>
<pre><code>## Warning in mask$eval_all_mutate(quo): NAs introduced by coercion

## Warning in mask$eval_all_mutate(quo): NAs introduced by coercion</code></pre>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb268-1" title="1">crickets<span class="fl">.1</span></a></code></pre></div>
<pre><code>## # A tibble: 34 x 3
##    species       temperature pulse_rate
##    &lt;chr&gt;               &lt;dbl&gt;      &lt;dbl&gt;
##  1 exclamationis        20.8       67.9
##  2 niveus               17.2       44.3
##  3 exclamationis        20.8       65.1
##  4 niveus               18.3       47.2
##  5 exclamationis        24         77.3
##  6 niveus               18.3       47.6
##  7 exclamationis        24         78.7
##  8 niveus               18.3       49.6
##  9 exclamationis        24         79.4
## 10 niveus               18.9       50.3
## # … with 24 more rows</code></pre>
<p>I saved the data frame this time, since this is the one we will use
for our analysis.</p>
<p>The warning message tells us that we got genuine missing-value NAs
back, which is probably what we want. Specifically, they got turned
from missing <em>text</em> to missing <em>numbers</em>!<a href="#fn36" class="footnote-ref" id="fnref36"><sup>36</sup></a>
The R word
“coercion” means values being changed from one type of thing to
another type of thing. (We’ll ignore the missings and see if they
cause us any trouble. The same warning messages will show up on graphs
later.) So I have 34 rows (including three rows of missings) instead
of the 31 rows I would have liked. Otherwise, success.</p>
<p>There is (inevitably) another way to do this. We are doing the
<code>as.numeric</code> twice, exactly the same on two different columns,
and when you are doing the same thing on a number of columns, here a
<code>mutate</code> with the same function, you have the option of using
<code>across</code>. This is the same idea
that we used way
back to compute numerical summaries of a bunch of columns:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb270-1" title="1">crickets <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb270-2" title="2"><span class="st">  </span><span class="kw">unite</span>(exclamationis, X1<span class="op">:</span>X2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb270-3" title="3"><span class="st">  </span><span class="kw">unite</span>(niveus, X3<span class="op">:</span>X4) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb270-4" title="4"><span class="st">  </span><span class="kw">pivot_longer</span>(exclamationis<span class="op">:</span>niveus, <span class="dt">names_to =</span> <span class="st">&quot;species&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;temp_pulse&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb270-5" title="5"><span class="st">  </span><span class="kw">separate</span>(temp_pulse, <span class="kw">c</span>(<span class="st">&quot;temperature&quot;</span>, <span class="st">&quot;pulse_rate&quot;</span>), <span class="st">&quot;_&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb270-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="kw">across</span>(<span class="kw">c</span>(temperature, pulse_rate), <span class="op">~</span><span class="kw">as.numeric</span>(.)))</a></code></pre></div>
<pre><code>## Warning in (structure(function (..., .x = ..1, .y = ..2, . = ..1) : NAs introduced by coercion</code></pre>
<pre><code>## Warning in (structure(function (..., .x = ..1, .y = ..2, . = ..1) : NAs introduced by coercion</code></pre>
<pre><code>## # A tibble: 34 x 3
##    species       temperature pulse_rate
##    &lt;chr&gt;               &lt;dbl&gt;      &lt;dbl&gt;
##  1 exclamationis        20.8       67.9
##  2 niveus               17.2       44.3
##  3 exclamationis        20.8       65.1
##  4 niveus               18.3       47.2
##  5 exclamationis        24         77.3
##  6 niveus               18.3       47.6
##  7 exclamationis        24         78.7
##  8 niveus               18.3       49.6
##  9 exclamationis        24         79.4
## 10 niveus               18.9       50.3
## # … with 24 more rows</code></pre>
<p>Can’t I just say that these are columns 2 and 3?</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb274-1" title="1">crickets <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb274-2" title="2"><span class="st">  </span><span class="kw">unite</span>(exclamationis, X1<span class="op">:</span>X2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb274-3" title="3"><span class="st">  </span><span class="kw">unite</span>(niveus, X3<span class="op">:</span>X4) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb274-4" title="4"><span class="st">  </span><span class="kw">pivot_longer</span>(exclamationis<span class="op">:</span>niveus, <span class="dt">names_to =</span> <span class="st">&quot;species&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;temp_pulse&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb274-5" title="5"><span class="st">  </span><span class="kw">separate</span>(temp_pulse, <span class="kw">c</span>(<span class="st">&quot;temperature&quot;</span>, <span class="st">&quot;pulse_rate&quot;</span>), <span class="st">&quot;_&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb274-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="kw">across</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>, <span class="op">~</span><span class="kw">as.numeric</span>(.)))</a></code></pre></div>
<pre><code>## Warning in (structure(function (..., .x = ..1, .y = ..2, . = ..1) : NAs introduced by coercion</code></pre>
<pre><code>## Warning in (structure(function (..., .x = ..1, .y = ..2, . = ..1) : NAs introduced by coercion</code></pre>
<pre><code>## # A tibble: 34 x 3
##    species       temperature pulse_rate
##    &lt;chr&gt;               &lt;dbl&gt;      &lt;dbl&gt;
##  1 exclamationis        20.8       67.9
##  2 niveus               17.2       44.3
##  3 exclamationis        20.8       65.1
##  4 niveus               18.3       47.2
##  5 exclamationis        24         77.3
##  6 niveus               18.3       47.6
##  7 exclamationis        24         78.7
##  8 niveus               18.3       49.6
##  9 exclamationis        24         79.4
## 10 niveus               18.9       50.3
## # … with 24 more rows</code></pre>
<p>Yes. Equally good. What goes into the <code>across</code>
is the same as can go into a <code>select</code>: column numbers, names,
or any of those “select helpers” like <code>starts_with</code>.</p>
<p>You might think of using <code>across</code> here on the quantitative columns, but remember the reason for doing this: all the columns are text, before you convert temperature and pulse rate to numbers, and so there’s no way to pick out just the two columns you want that way.</p>
<p>Check that the temperature and pulse rate columns are now labelled
<code>dbl</code>, which means they actually <em>are</em> decimal numbers
(and don’t just look like decimal numbers).</p>
<p>Either way, using <code>unite</code> and then <code>separate</code> means that
all the columns we created we want to keep (or, all the ones we would
have wanted to get rid of have already been gotten rid of).</p>
<p>Now we could actually do some statistics. That we do elsewhere.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="number-1-songs-1" class="section level2">
<h2><span class="header-section-number">17.20</span> Number 1 songs</h2>
<p>The data file
<a href="http://stat405.had.co.nz/data/billboard.csv">link</a> contains a lot of
information about songs popular in 2000. This dataset is untidy. Our
ultimate aim is to answer “which song occupied the #1 position for the largest number of weeks?”. To do that, we will build a pipe that
starts from the data frame read in from the URL above, and finishes
with an answer to the question. I will take you through this step by
step. Each part will involve adding something to the pipe you built
previously (possibly after removing a line or two that you used to
display the previous result).</p>
<ol style="list-style-type: lower-alpha">
<li>Read the data and display what you have.</li>
</ol>
<p>Solution</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb278-1" title="1">billboard &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;http://stat405.had.co.nz/data/billboard.csv&quot;</span>)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   .default = col_double(),
##   artist.inverted = col_character(),
##   track = col_character(),
##   time = col_time(format = &quot;&quot;),
##   genre = col_character(),
##   date.entered = col_date(format = &quot;&quot;),
##   date.peaked = col_date(format = &quot;&quot;),
##   x66th.week = col_logical(),
##   x67th.week = col_logical(),
##   x68th.week = col_logical(),
##   x69th.week = col_logical(),
##   x70th.week = col_logical(),
##   x71st.week = col_logical(),
##   x72nd.week = col_logical(),
##   x73rd.week = col_logical(),
##   x74th.week = col_logical(),
##   x75th.week = col_logical(),
##   x76th.week = col_logical()
## )
## ℹ Use `spec()` for the full column specifications.</code></pre>
<p>There are a <em>lot</em> of columns. What does this look like?</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb280-1" title="1">billboard</a></code></pre></div>
<pre><code>## # A tibble: 317 x 83
##     year artist.inverted  track  time  genre date.entered date.peaked x1st.week x2nd.week x3rd.week x4th.week x5th.week x6th.week x7th.week x8th.week x9th.week x10th.week x11th.week x12th.week x13th.week x14th.week x15th.week x16th.week x17th.week x18th.week x19th.week x20th.week x21st.week x22nd.week x23rd.week x24th.week x25th.week x26th.week x27th.week x28th.week x29th.week x30th.week x31st.week x32nd.week x33rd.week x34th.week x35th.week x36th.week x37th.week x38th.week x39th.week x40th.week x41st.week x42nd.week x43rd.week x44th.week x45th.week x46th.week x47th.week x48th.week x49th.week x50th.week x51st.week x52nd.week x53rd.week x54th.week x55th.week x56th.week x57th.week x58th.week x59th.week x60th.week
##    &lt;dbl&gt; &lt;chr&gt;            &lt;chr&gt;  &lt;tim&gt; &lt;chr&gt; &lt;date&gt;       &lt;date&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
##  1  2000 Destiny&#39;s Child  Indep… 03:38 Rock  2000-09-23   2000-11-18         78        63        49        33        23        15         7         5         1          1          1          1          1          1          1          1          1          1          1          2          3          7         10         12         15         22         29         31         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
##  2  2000 Santana          Maria… 04:18 Rock  2000-02-12   2000-04-08         15         8         6         5         2         3         2         2         1          1          1          1          1          1          1          1          1          1          8         15         19         21         26         36         48         47         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
##  3  2000 Savage Garden    I Kne… 04:07 Rock  1999-10-23   2000-01-29         71        48        43        31        20        13         7         6         4          4          4          6          4          2          1          1          1          2          1          2          4          8          8         12         14         17         21         24         30         34         37         46         47         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
##  4  2000 Madonna          Music  03:45 Rock  2000-08-12   2000-09-16         41        23        18        14         2         1         1         1         1          2          2          2          2          2          4          8         11         16         20         25         27         27         29         44         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
##  5  2000 Aguilera, Chris… Come … 03:38 Rock  2000-08-05   2000-10-14         57        47        45        29        23        18        11         9         9         11          1          1          1          1          4          8         12         22         23         43         44         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
##  6  2000 Janet            Doesn… 04:17 Rock  2000-06-17   2000-08-26         59        52        43        30        29        22        15        10        10          5          1          1          1          2          2          3          3          7          8         20         25         37         40         41         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
##  7  2000 Destiny&#39;s Child  Say M… 04:31 Rock  1999-12-25   2000-03-18         83        83        44        38        16        13        16        16        16         18         17         14          1          1          1          2          2          3          5          5          5          7         10         13         14         18         23         23         34         37         43         47         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
##  8  2000 Iglesias, Enriq… Be Wi… 03:36 Latin 2000-04-01   2000-06-24         63        45        34        23        17        12         9         8         8          6          5          4          1          1          1          3         11         14         24         28         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
##  9  2000 Sisqo            Incom… 03:52 Rock  2000-06-24   2000-08-12         77        66        61        61        61        55         2         1         1          2          2          4          5          5          7          8         10         10          9         14         17         20         25         31         32         46         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
## 10  2000 Lonestar         Amazed 04:25 Coun… 1999-06-05   2000-03-04         81        54        44        39        38        33        29        29        32         27         26         24         27         32         33         35         35         40         43         50         NA         NA         NA         NA         NA         NA         NA         NA         NA         45         45         45         23         17         14         17         18         18          3          1          1          2          3          4          4          5          6          8          9         10         12         15         20         22         22         25         26         31         32         37
## # … with 307 more rows, and 16 more variables: x61st.week &lt;dbl&gt;, x62nd.week &lt;dbl&gt;, x63rd.week &lt;dbl&gt;, x64th.week &lt;dbl&gt;, x65th.week &lt;dbl&gt;, x66th.week &lt;lgl&gt;, x67th.week &lt;lgl&gt;,
## #   x68th.week &lt;lgl&gt;, x69th.week &lt;lgl&gt;, x70th.week &lt;lgl&gt;, x71st.week &lt;lgl&gt;, x72nd.week &lt;lgl&gt;, x73rd.week &lt;lgl&gt;, x74th.week &lt;lgl&gt;, x75th.week &lt;lgl&gt;, x76th.week &lt;lgl&gt;</code></pre>
<p>On yours, you will definitely see a little arrow top right saying
“there are more columns”, and you will have to click on it several
times to see them all. A lot of the ones on the right will be missing.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>The columns <code>x1st.week</code> through
<code>x76th.week</code> contain the rank of each song in the Billboard
chart in that week, with week 1 being the first week that the song
appeared in the chart. Convert all these columns into two: an
indication of week, called <code>week</code>, and of rank, called
<code>rank</code>. Most songs appeared in the Billboard chart for a
lot less than 76 weeks, so there are missing values, which you
want to remove. (I say “indication of week” since this will
probably be text at the moment). Display your new data frame. Do
you have fewer columns? Why do you have a lot more rows? Explain
briefly.</li>
</ol>
<p>Solution</p>
<p>As is often the case, the first step is <code>pivot_longer</code>, to reduce all those columns to something easier to deal with. The columns we want to make longer are the ones ending in “week”:</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb282-1" title="1">billboard <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb282-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">ends_with</span>(<span class="st">&quot;week&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;rank&quot;</span>, <span class="dt">values_drop_na =</span> T)</a></code></pre></div>
<pre><code>## # A tibble: 5,307 x 9
##     year artist.inverted track                    time   genre date.entered date.peaked week        rank
##    &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;                    &lt;time&gt; &lt;chr&gt; &lt;date&gt;       &lt;date&gt;      &lt;chr&gt;      &lt;dbl&gt;
##  1  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x1st.week     78
##  2  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x2nd.week     63
##  3  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x3rd.week     49
##  4  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x4th.week     33
##  5  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x5th.week     23
##  6  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x6th.week     15
##  7  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x7th.week      7
##  8  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x8th.week      5
##  9  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x9th.week      1
## 10  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x10th.week     1
## # … with 5,297 more rows</code></pre>
<p>The “values” (ranks) have missings in them, which we wanted to get rid of.</p>
<p>There are now only 9 columns, a lot fewer than we started with. This
is (I didn’t need you to say) because we have collected together all
those <code>week</code> columns into one (a column called <code>rank</code>
with an indication of which <code>week</code> it came from). The logic of
the <code>pivot_longer</code> is that all those columns contain ranks (which is
what make them the same), but they are ranks from different weeks
(which is what makes them different).</p>
<p>What has actually happened is that we have turned “wide” format into
“long” format. This is not very insightful, so I would like you to
go a bit further in your explanation. The original data frame encodes
the rank of each song in each week, and what the <code>pivot_longer</code> has
done is to make that explicit: in the new data frame, each song’s rank
in each week appears in <em>one</em> row, so that there are as many rows
as there are song-week combinations. The original data frame had 317
songs over 76 weeks, so this many:</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb284-1" title="1"><span class="dv">317</span> <span class="op">*</span><span class="st"> </span><span class="dv">76</span></a></code></pre></div>
<pre><code>## [1] 24092</code></pre>
<p>song-week combinations.</p>
<p>Not every song appeared in the Billboard chart for 76 weeks, so our tidy
data frame has a lot fewer rows than this.</p>
<p>You need to say that the original data frame had each song appearing
once (on one line), but now each song appears on multiple rows, one
for each week that the song was in the chart. Or something equivalent
to that.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>Both your <code>week</code> and <code>rank</code> columns are
(probably) text. Create new columns that contain just the numeric
values, and display just your new columns, again adding onto the
end of your pipe. If it so happens that <code>rank</code> is already a number, leave it as it is.</li>
</ol>
<p>Solution</p>
<p>My <code>rank</code> is already a number, so I could leave it; for later, I make a copy of it called <code>rakn_numbe</code>. The <code>week</code> has a number <em>in</em> it, which I can extract using <code>parse_number</code>:</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb286-1" title="1">billboard <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb286-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">ends_with</span>(<span class="st">&quot;week&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;rank&quot;</span>, <span class="dt">values_drop_na =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb286-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">week_number=</span><span class="kw">parse_number</span>(week),</a>
<a class="sourceLine" id="cb286-4" title="4">         <span class="dt">rank_number=</span>rank)</a></code></pre></div>
<pre><code>## # A tibble: 5,307 x 11
##     year artist.inverted track                    time   genre date.entered date.peaked week        rank week_number rank_number
##    &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;                    &lt;time&gt; &lt;chr&gt; &lt;date&gt;       &lt;date&gt;      &lt;chr&gt;      &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
##  1  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x1st.week     78           1          78
##  2  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x2nd.week     63           2          63
##  3  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x3rd.week     49           3          49
##  4  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x4th.week     33           4          33
##  5  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x5th.week     23           5          23
##  6  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x6th.week     15           6          15
##  7  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x7th.week      7           7           7
##  8  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x8th.week      5           8           5
##  9  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x9th.week      1           9           1
## 10  2000 Destiny&#39;s Child Independent Women Part I 03:38  Rock  2000-09-23   2000-11-18  x10th.week     1          10           1
## # … with 5,297 more rows</code></pre>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>The meaning of your week-number column is that it refers
to the number of weeks <em>after</em> the song first appeared in the
Billboard chart. That is, if a song’s first appearance (in
<code>date.entered)</code> is July 24, then week 1 is July 24, week 2
is July 31, week 3 is August 7, and so on. Create a column
<code>current</code> by adding the appropriate number of <em>days</em>,
based on your week number, to <code>date.entered</code>. Display
<code>date.entered</code>, your week number, and <code>current</code> to
show that you have calculated the right thing. Note that you can
add a number of days onto a date and you will get another date.</li>
</ol>
<p>Solution</p>
<p>There is a (small) gotcha here: if you read carefully, you’ll
see that “week 1” is actually “week 0” in terms of the
number of days to add on to <code>date.entered</code>. So you have
to subtract one from the number of weeks before you multiply
it by seven to get a number of days.
After that thinking, this:</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb288-1" title="1">billboard <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb288-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">ends_with</span>(<span class="st">&quot;week&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;rank&quot;</span>, <span class="dt">values_drop_na =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb288-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">week_number=</span><span class="kw">parse_number</span>(week),</a>
<a class="sourceLine" id="cb288-4" title="4">         <span class="dt">rank_number=</span>rank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb288-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">current =</span> date.entered <span class="op">+</span><span class="st"> </span>(week_number <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">7</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb288-6" title="6"><span class="st">  </span><span class="kw">select</span>(date.entered, week_number, current)</a></code></pre></div>
<pre><code>## # A tibble: 5,307 x 3
##    date.entered week_number current   
##    &lt;date&gt;             &lt;dbl&gt; &lt;date&gt;    
##  1 2000-09-23             1 2000-09-23
##  2 2000-09-23             2 2000-09-30
##  3 2000-09-23             3 2000-10-07
##  4 2000-09-23             4 2000-10-14
##  5 2000-09-23             5 2000-10-21
##  6 2000-09-23             6 2000-10-28
##  7 2000-09-23             7 2000-11-04
##  8 2000-09-23             8 2000-11-11
##  9 2000-09-23             9 2000-11-18
## 10 2000-09-23            10 2000-11-25
## # … with 5,297 more rows</code></pre>
<p>Don’t forget to use your <code>week</code>-turned-into-number, or else it
won’t work! (This bit me too, so you don’t need to feel bad.)</p>
<p>You can also combine the three column-definition statements into one
mutate. It doesn’t matter; as soon as you have defined a column, you
can use it in defining another column, even within the same
<code>mutate</code>.</p>
<p>Anyway, the rows displayed are all <code>week_number</code> 1, so the
<code>current</code> date should be the same as <code>date.entered</code>, and
is. (These are all the first week that a song is in the Billboard
chart).</p>
<p>You might be thinking that this is not much of a check, and you would
be right. A handy trick is to display a random sample of 10 (say) out
of the 5,000-odd rows of the data frame. To do that, add the line
<code>sample_n(10)</code> on the end, like this:</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb290-1" title="1">billboard <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb290-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">ends_with</span>(<span class="st">&quot;week&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;rank&quot;</span>, <span class="dt">values_drop_na =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb290-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb290-4" title="4">    <span class="dt">week_number =</span> <span class="kw">parse_number</span>(week),</a>
<a class="sourceLine" id="cb290-5" title="5">    <span class="dt">rank_number =</span> rank</a>
<a class="sourceLine" id="cb290-6" title="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb290-7" title="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">current =</span> date.entered <span class="op">+</span><span class="st"> </span>(week_number <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">7</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb290-8" title="8"><span class="st">  </span><span class="kw">select</span>(date.entered, week_number, current) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb290-9" title="9"><span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">10</span>)</a></code></pre></div>
<pre><code>## # A tibble: 10 x 3
##    date.entered week_number current   
##    &lt;date&gt;             &lt;dbl&gt; &lt;date&gt;    
##  1 2000-09-09             7 2000-10-21
##  2 2000-11-25            18 2001-03-24
##  3 1999-11-13            18 2000-03-11
##  4 1999-12-25             1 1999-12-25
##  5 2000-07-08            20 2000-11-18
##  6 2000-08-19            13 2000-11-11
##  7 2000-08-12            15 2000-11-18
##  8 2000-10-21            10 2000-12-23
##  9 2000-08-12             2 2000-08-19
## 10 2000-08-12            19 2000-12-16</code></pre>
<p>This gives a variety of rows to check. The first <code>current</code>
should be <span class="math inline">\(7-1=6\)</span> weeks, or about a month and a half, after the date the song
entered the chart, and so it is; the second and third ones should be <span class="math inline">\(18-1=17\)</span>
weeks after entry, which is very close to a third of a year (<span class="math inline">\(17 \times 3 = 51\)</span>), or four months. November to March is indeed four months. The fourth one is the first week on the charts, so the current date and the date entered should be (and are) the same.
And so on.</p>
<p>Your random selection of rows is likely to be different from mine, but
the same kind of thinking will enable you to check whether it makes
sense.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="6" style="list-style-type: lower-alpha">
<li>Reaching the #1 rank on the Billboard chart is one of
the highest accolades in the popular music world. List all the
songs that reached <code>rank</code> 1. For these songs, list the
artist (as given in the data set), the song title, and the date(s)
for which the song was ranked number 1. Arrange the songs in date
order of being ranked #1. Display all the songs (I found 55 of them).</li>
</ol>
<p>Solution</p>
<p>To the previous pipe, add the last lines below. You can use
either <code>rank</code> (text) or what I called
<code>rank_number</code> (a number). It doesn’t matter here,
since we are only checking for equal-to, not something like
“less than”:</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb292-1" title="1">billboard <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb292-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">ends_with</span>(<span class="st">&quot;week&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;rank&quot;</span>, <span class="dt">values_drop_na =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb292-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">week_number=</span><span class="kw">parse_number</span>(week),</a>
<a class="sourceLine" id="cb292-4" title="4">         <span class="dt">rank_number=</span>rank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb292-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">current =</span> date.entered <span class="op">+</span><span class="st"> </span>(week_number <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">7</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb292-6" title="6"><span class="st">  </span><span class="kw">filter</span>(rank <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb292-7" title="7"><span class="st">  </span><span class="kw">arrange</span>(current) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb292-8" title="8"><span class="st">  </span><span class="kw">select</span>(artist.inverted, track, current)</a></code></pre></div>
<pre><code>## # A tibble: 55 x 3
##    artist.inverted     track                 current   
##    &lt;chr&gt;               &lt;chr&gt;                 &lt;date&gt;    
##  1 Aguilera, Christina What A Girl Wants     2000-01-15
##  2 Aguilera, Christina What A Girl Wants     2000-01-22
##  3 Savage Garden       I Knew I Loved You    2000-01-29
##  4 Savage Garden       I Knew I Loved You    2000-02-05
##  5 Savage Garden       I Knew I Loved You    2000-02-12
##  6 Carey, Mariah       Thank God I Found You 2000-02-19
##  7 Savage Garden       I Knew I Loved You    2000-02-26
##  8 Lonestar            Amazed                2000-03-04
##  9 Lonestar            Amazed                2000-03-11
## 10 Destiny&#39;s Child     Say My Name           2000-03-18
## # … with 45 more rows</code></pre>
<p>You’ll see the first ten rows, as here, but with clickable buttons to
see the next 10 (and the previous 10 if you have moved beyond 1–10).
The “artist” column is called <code>artist.inverted</code> because, if
the artist is a single person rather than a group, their last name is
listed first. The song title appears in the column <code>track</code>.</p>
<p>The song by Destiny’s Child spills into 2001 because it entered the
chart in 2000, and the data set keeps a record of all such songs until
they drop out of the chart. I’m not sure what happened to the song
that was #1 on January 8, 2000; maybe it entered the chart in
1999<a href="#fn37" class="footnote-ref" id="fnref37"><sup>37</sup></a> and so is not
listed here.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="7" style="list-style-type: lower-alpha">
<li>Use R to find out which song held the #1 rank for the
largest number of weeks. For this, you can assume that the song
titles are all unique (if it’s the same song title, it’s the same
song), but the artists might not be (for example, Madonna might
have had two different songs reach the #1 rank). The information
you need is in the output you obtained for the previous part, so
it’s a matter of adding some code to the end of that.
The last mark was for displaying <em>only</em> the song that was
ranked #1 for the largest number of weeks, or for otherwise
making it easy to see which song it was.</li>
</ol>
<p>Solution</p>
<p>This is a question of using <code>count</code>, but on the
<code>track</code> title:</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb294-1" title="1">billboard <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb294-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">ends_with</span>(<span class="st">&quot;week&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;rank&quot;</span>, <span class="dt">values_drop_na =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb294-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">week_number=</span><span class="kw">parse_number</span>(week),</a>
<a class="sourceLine" id="cb294-4" title="4">         <span class="dt">rank_number=</span>rank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb294-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">current =</span> date.entered <span class="op">+</span><span class="st"> </span>(week_number <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">7</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb294-6" title="6"><span class="st">  </span><span class="kw">filter</span>(rank <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb294-7" title="7"><span class="st">  </span><span class="kw">arrange</span>(current) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb294-8" title="8"><span class="st">  </span><span class="kw">select</span>(artist.inverted, track, current) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb294-9" title="9"><span class="st">  </span><span class="kw">count</span>(track)</a></code></pre></div>
<pre><code>## # A tibble: 17 x 2
##    track                                     n
##    &lt;chr&gt;                                 &lt;int&gt;
##  1 Amazed                                    2
##  2 Be With You                               3
##  3 Bent                                      1
##  4 Come On Over Baby (All I Want Is You)     4
##  5 Doesn&#39;t Really Matter                     3
##  6 Everything You Want                       1
##  7 I Knew I Loved You                        4
##  8 Incomplete                                2
##  9 Independent Women Part I                 11
## 10 It&#39;s Gonna Be Me                          2
## 11 Maria, Maria                             10
## 12 Music                                     4
## 13 Say My Name                               3
## 14 Thank God I Found You                     1
## 15 Try Again                                 1
## 16 What A Girl Wants                         2
## 17 With Arms Wide Open                       1</code></pre>
<p>Then you can scan down the <code>n</code> column, find that the
biggest number is 11, and say: it’s the song “Independent Women Part I” by Destiny’s Child. This is 3 points (out of 4, when the question
was to be handed in).</p>
<p>But, this is a data frame, so anything we can do to a data frame we
can do to this, like listing out only the row(s) where <code>n</code> is
equal to its maximum value:</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb296-1" title="1">billboard <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb296-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">ends_with</span>(<span class="st">&quot;week&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;rank&quot;</span>, <span class="dt">values_drop_na =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb296-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">week_number=</span><span class="kw">parse_number</span>(week),</a>
<a class="sourceLine" id="cb296-4" title="4">         <span class="dt">rank_number=</span>rank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb296-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">current =</span> date.entered <span class="op">+</span><span class="st"> </span>(week_number <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">7</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb296-6" title="6"><span class="st">  </span><span class="kw">filter</span>(rank <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb296-7" title="7"><span class="st">  </span><span class="kw">arrange</span>(current) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb296-8" title="8"><span class="st">  </span><span class="kw">select</span>(artist.inverted, track, current) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb296-9" title="9"><span class="st">  </span><span class="kw">count</span>(track) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb296-10" title="10"><span class="st">  </span><span class="kw">filter</span>(n <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   track                        n
##   &lt;chr&gt;                    &lt;int&gt;
## 1 Independent Women Part I    11</code></pre>
<p>or arranging them in (most logically, descending) order by <code>n</code>
to make it easier to pick out the top one:</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb298-1" title="1">billboard <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb298-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">ends_with</span>(<span class="st">&quot;week&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;rank&quot;</span>, <span class="dt">values_drop_na =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb298-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">week_number=</span><span class="kw">parse_number</span>(week),</a>
<a class="sourceLine" id="cb298-4" title="4">         <span class="dt">rank_number=</span>rank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb298-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">current =</span> date.entered <span class="op">+</span><span class="st"> </span>(week_number <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">7</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb298-6" title="6"><span class="st">  </span><span class="kw">filter</span>(rank <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb298-7" title="7"><span class="st">  </span><span class="kw">arrange</span>(current) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb298-8" title="8"><span class="st">  </span><span class="kw">select</span>(artist.inverted, track, current) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb298-9" title="9"><span class="st">  </span><span class="kw">count</span>(track) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb298-10" title="10"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 17 x 2
##    track                                     n
##    &lt;chr&gt;                                 &lt;int&gt;
##  1 Independent Women Part I                 11
##  2 Maria, Maria                             10
##  3 Come On Over Baby (All I Want Is You)     4
##  4 I Knew I Loved You                        4
##  5 Music                                     4
##  6 Be With You                               3
##  7 Doesn&#39;t Really Matter                     3
##  8 Say My Name                               3
##  9 Amazed                                    2
## 10 Incomplete                                2
## 11 It&#39;s Gonna Be Me                          2
## 12 What A Girl Wants                         2
## 13 Bent                                      1
## 14 Everything You Want                       1
## 15 Thank God I Found You                     1
## 16 Try Again                                 1
## 17 With Arms Wide Open                       1</code></pre>
<p>Either of those would have netted you the 4th point.</p>
<p>If you want to be a little bit more careful, you can make an
artist-track combination as below. This would catch occasions where
the same song by two different artists made it to #1, or two
different songs that happened to have the same title did. It’s not
very likely that the same artist would record two <em>different</em>
songs with the same title, though it is possible that the same song by
the same artist could appear in the Billboard chart on two different
occasions.<a href="#fn38" class="footnote-ref" id="fnref38"><sup>38</sup></a></p>
<p>I think I want to create an artist-song combo fairly early in my pipe,
and then display <em>that</em> later, something like this. This means
replacing <code>track</code> by my <code>combo</code> later in the pipe,
wherever it appears:</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb300-1" title="1">billboard <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb300-2" title="2"><span class="st">  </span><span class="kw">pivot_longer</span>(x1st.week<span class="op">:</span>x76th.week, <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;rank&quot;</span>, <span class="dt">values_drop_na =</span> T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb300-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb300-4" title="4">    <span class="dt">week_number =</span> <span class="kw">parse_number</span>(week),</a>
<a class="sourceLine" id="cb300-5" title="5">    <span class="dt">rank_number =</span> rank</a>
<a class="sourceLine" id="cb300-6" title="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb300-7" title="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">combo =</span> <span class="kw">paste</span>(track, artist.inverted, <span class="dt">sep =</span> <span class="st">&quot; by &quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb300-8" title="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">current =</span> date.entered <span class="op">+</span><span class="st"> </span>(week_number <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span><span class="dv">7</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb300-9" title="9"><span class="st">  </span><span class="kw">filter</span>(rank <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb300-10" title="10"><span class="st">  </span><span class="kw">arrange</span>(current) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb300-11" title="11"><span class="st">  </span><span class="kw">select</span>(combo, current) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb300-12" title="12"><span class="st">  </span><span class="kw">count</span>(combo) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb300-13" title="13"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 17 x 2
##    combo                                                            n
##    &lt;chr&gt;                                                        &lt;int&gt;
##  1 Independent Women Part I by Destiny&#39;s Child                     11
##  2 Maria, Maria by Santana                                         10
##  3 Come On Over Baby (All I Want Is You) by Aguilera, Christina     4
##  4 I Knew I Loved You by Savage Garden                              4
##  5 Music by Madonna                                                 4
##  6 Be With You by Iglesias, Enrique                                 3
##  7 Doesn&#39;t Really Matter by Janet                                   3
##  8 Say My Name by Destiny&#39;s Child                                   3
##  9 Amazed by Lonestar                                               2
## 10 Incomplete by Sisqo                                              2
## 11 It&#39;s Gonna Be Me by N&#39;Sync                                       2
## 12 What A Girl Wants by Aguilera, Christina                         2
## 13 Bent by matchbox twenty                                          1
## 14 Everything You Want by Vertical Horizon                          1
## 15 Thank God I Found You by Carey, Mariah                           1
## 16 Try Again by Aaliyah                                             1
## 17 With Arms Wide Open by Creed                                     1</code></pre>
<p>I don’t think it makes any difference here, but it might in other
years, or if you look over several years where you might get cover
versions of the same song performed by different artists.</p>
<p>Zero-point bonus: how many of these artists have you heard of? How
many have your parents heard of? (I followed popular music quite
closely much earlier than this, in the early 1980s in the UK. I
remember both Madonna and U2 when they <em>first</em> became
famous. U2’s first single was called “Fire” and it just scraped into
the UK top 40. Things changed after that.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="bikes-on-college-1" class="section level2">
<h2><span class="header-section-number">17.21</span> Bikes on College</h2>
<p>The City of Toronto collects all kinds of data on aspects of
life in the city. See
<a href="http://www1.toronto.ca/wps/portal/contentonly?vgnextoid=1a66e03bb8d1e310VgnVCM10000071d60f89RCRD">link</a>. One
collection of data is records of the number of cyclists on certain
downtown streets. The data in
<a href="http://ritsokiguess.site/datafiles/bikes.csv">link</a> are a record
of the cyclists on College Street on the block west from Huron to
Spadina on September 24, 2010. In the spreadsheet, each row relates to
one cyclist. The first column is the time the cyclist was observed (to
the nearest 15 minutes). After that, there are four pairs of
columns. The observer filled in (exactly) one X in each pair of
columns, according to whether (i) the cyclist was male or female, (ii)
was or was not wearing a helmet, (iii) was or was not carrying a
passenger on the bike, (iv) was or was not riding on the sidewalk. We
want to create a tidy data frame that has the time in each row, and
has columns containing appropriate values, often <code>TRUE</code> or
<code>FALSE</code>, for each of the four variables measured.</p>
<p>I will lead you through the process, which will involve developing a
(long) pipe, one step at a time.</p>
<ol style="list-style-type: lower-alpha">
<li>Take a look at the spreadsheet (using Excel or similar:
this may open when you click the link). Are there any obvious
header rows? Is there any extra material before the data start?
Explain briefly.</li>
</ol>
<p>Solution</p>
<p>This is what I see (you should see something that looks like this):</p>
<p><img src="bikes-ss.png" /></p>
<p>There are really <em>two</em> rows of headers (the rows
highlighted in yellow). The actual information that says what
the column pair is about is in the first of those two rows, and
the second row indicates which category of the information above
this column refers to.
This is not the usual way that the column headers encode what
the columns are about: we are used to having <em>one</em> column
<code>gender</code> that would take the values <code>female</code> or
<code>male</code>, or a column <code>helmet</code> containing the values
<code>yes</code> or <code>no</code>. (You might be sensing
<code>pivot_longer</code> here, which may be one way of tackling this, but
I lead you into another idea below.)
There are also six lines above the highlighted ones that contain
background information about this study. (This is where I got
the information about the date of the study and which block of
which street it is about.)
I am looking for two things: the apparent header line is
actually two lines (the ones in yellow), and there are extra
lines above that which are not data.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Read the data into an R data
frame. Read <em>without</em> headers, and instruct R how many lines
to skip over using <code>skip=</code> and a suitable number.
When this is working, display the first few lines of your data
frame. Note that your columns have names <code>X1</code> through
<code>X9</code>.</li>
</ol>
<p>Solution</p>
<p>The actual data start on line 9, so we need to skip 8
lines. <code>col_names=F</code> is the way to say that we have no
column names (not ones that we want to use, anyway). Just
typing the name of the data frame will display “a few” (that
is, 10) lines of it, so that you can check it for
plausibleness:</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb302-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/bikes.csv&quot;</span></a>
<a class="sourceLine" id="cb302-2" title="2">bikes &lt;-<span class="st"> </span><span class="kw">read_csv</span>(my_url, <span class="dt">skip =</span> <span class="dv">8</span>, <span class="dt">col_names =</span> F)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   X1 = col_time(format = &quot;&quot;),
##   X2 = col_character(),
##   X3 = col_character(),
##   X4 = col_character(),
##   X5 = col_character(),
##   X6 = col_character(),
##   X7 = col_character(),
##   X8 = col_character(),
##   X9 = col_character()
## )</code></pre>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb304-1" title="1">bikes</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 9
##    X1     X2    X3    X4    X5    X6    X7    X8    X9   
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
##  1 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  2    NA  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  3    NA  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  4    NA  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  5    NA  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  6 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
##  7    NA  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
##  8    NA  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
##  9    NA  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     X     &lt;NA&gt; 
## 10    NA  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
## # … with 1,948 more rows</code></pre>
<p>This seems to have worked: a column with times in it, and four pairs
of columns, with exactly one of each pair having an X in it. The
variable names <code>X1</code> through <code>X9</code> were generated by
<code>read_csv</code>, as it does when you read in data with
<code>col_names=F</code>. The times are correctly <code>time</code>s, and the
other columns are all text. The blank cells in the spreadsheet have
appeared in our data frame as “missing” (<code>NA</code>). The notation
<code>&lt;NA&gt;</code> means “missing text” (as opposed to a missing number,
say).</p>
<p>The first line in our data frame contains the first 7:00 (am) cyclist,
so it looks as if we skipped the right number of lines.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>What do you notice about the times in your first
column? What do you think those “missing” times should be?</li>
</ol>
<p>Solution</p>
<p>There are some times and some missing values. It seems a
reasonable guess that the person recording the data only
recorded a time when a new period of 15 minutes had begun, so
that the missing times should be the same as the previous
non-missing one: For
example, the first five rows are cyclists observed at 7:00 am
(or, at least, between 7:00 and 7:15). So they should be
recorded as 7:00, and the ones in rows 7–10 should be
recorded as 7:15, and so on.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>Find something from the <code>tidyverse</code> that will
fill<a href="#fn39" class="footnote-ref" id="fnref39"><sup>39</sup></a>
in those missing values with the right thing.
Start a pipe from the data frame you read in, that updates the
appropriate column with the filled-in times.</li>
</ol>
<p>Solution</p>
<p><code>fill</code> from <code>tidyr</code> fills
in the missing times with the previous non-missing
value. (This will mean finding the help for <code>fill</code> in R
Studio or online.)
I told you it was a giveaway.
If you look in the help for <code>fill</code> via <code>?fill</code>
(or if you Google <code>tidyr::fill</code>, which is the full
name for “the <code>fill</code> that lives in <code>tidyr</code>”),
you’ll see that it requires up to two
things (not including the data frame): a column to fill, and
a direction to fill it (the default of “down” is exactly
what we want). Thus:</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb306-1" title="1">bikes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fill</span>(X1)</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 9
##    X1     X2    X3    X4    X5    X6    X7    X8    X9   
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
##  1 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  2 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  3 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  4 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  5 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  6 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
##  7 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
##  8 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
##  9 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     X     &lt;NA&gt; 
## 10 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
## # … with 1,948 more rows</code></pre>
<p>Success!</p>
<p>We will probably want to rename <code>X1</code> to something like
<code>time</code>, so let’s do that now before we forget. There is a
<code>rename</code> that does about what you’d expect:</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb308-1" title="1">bikes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1)</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 9
##    Time   X2    X3    X4    X5    X6    X7    X8    X9   
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
##  1 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  2 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  3 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  4 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  5 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X    
##  6 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
##  7 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
##  8 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
##  9 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     X     &lt;NA&gt; 
## 10 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X    
## # … with 1,948 more rows</code></pre>
<p>The only thing I keep forgetting is that the syntax of <code>rename</code>
is “new name equals old name”. Sometimes I think it’s the other way
around, and then I wonder why it doesn’t work.</p>
<p>I gave it a capital T so as not to confuse it with other things in R
called <code>time</code>.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>R’s <code>ifelse</code> function works like <code>=IF</code> in
Excel. You use it to create values for a new variable, for
example in a <code>mutate</code>. The first input to it is a
logical condition (something that is either true or false); the
second is the value your new variable should take if the
condition is true, and the third is the value of your new
variable if the condition is false. Create a new column
<code>gender</code> in your data frame that is “male” or
“female” depending on the value of your <code>X2</code> column,
using <code>mutate</code>. (You can assume that exactly one of the
second and third columns has an <code>X</code> in it.) Add your code
to the end of your pipe and display (the first 10 rows of) the
result.</li>
</ol>
<p>Solution</p>
<p>Under the assumption we are making, we only have to look
at column <code>X2</code> and we ignore <code>X3</code> totally:</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb310-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb310-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb310-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb310-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gender =</span> <span class="kw">ifelse</span>(X2 <span class="op">==</span><span class="st"> &quot;X&quot;</span>, <span class="st">&quot;male&quot;</span>, <span class="st">&quot;female&quot;</span>))</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 10
##    Time   X2    X3    X4    X5    X6    X7    X8    X9    gender
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  2 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  3 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  4 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  5 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  6 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  7 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  
##  8 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  9 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  
## 10 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male  
## # … with 1,948 more rows</code></pre>
<p>Oh, that didn’t work. The gender column is either <code>male</code> or
missing; the two missing ones here should say <code>female</code>. What
happened? Let’s just look at our logical condition this time:</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb312-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb312-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb312-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb312-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">isX =</span> (X2 <span class="op">==</span><span class="st"> &quot;X&quot;</span>))</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 10
##    Time   X2    X3    X4    X5    X6    X7    X8    X9    isX  
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;lgl&gt;
##  1 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     TRUE 
##  2 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     TRUE 
##  3 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     TRUE 
##  4 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     TRUE 
##  5 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     TRUE 
##  6 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     TRUE 
##  7 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     NA   
##  8 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     TRUE 
##  9 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     X     &lt;NA&gt;  NA   
## 10 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     TRUE 
## # … with 1,948 more rows</code></pre>
<p>This is not true and false, it is true and missing. The idea is that
if <code>X2</code> is missing, we don’t (in general) know what its value
is: it might even be <code>X</code>! So if <code>X2</code> is missing, any
comparison of it with another value ought to be missing as well.</p>
<p>That’s in general. Here, we know where those missing values came from:
they were blank cells in the spreadsheet, so we actually have more
information.</p>
<p>Perhaps a better way to go is to test whether <code>X2</code> is missing (in which
case, it’s a female cyclist). R has a function <code>is.na</code> which is
<code>TRUE</code> if the thing inside it is missing and <code>FALSE</code> if
the thing inside it has some non-missing value. In our case, it
goes like this:</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb314-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb314-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb314-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb314-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gender =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(X2), <span class="st">&quot;female&quot;</span>, <span class="st">&quot;male&quot;</span>))</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 10
##    Time   X2    X3    X4    X5    X6    X7    X8    X9    gender
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  2 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  3 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  4 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  5 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  6 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  7 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     female
##  8 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male  
##  9 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     X     &lt;NA&gt;  female
## 10 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male  
## # … with 1,948 more rows</code></pre>
<p>Or you can test <code>X3</code> for missingness: if missing, it’s male,
otherwise it’s female. That also works.</p>
<p>This made an assumption that the person recording the X’s actually
<em>did</em> mark an X in exactly one of the columns. For example, the
columns could <em>both</em> be missing, or <em>both</em> have an X in
them. This gives us more things to check, at least
three. <code>ifelse</code> is good for something with only two
alternatives, but when you have more, <code>case_when</code> is much
better.<a href="#fn40" class="footnote-ref" id="fnref40"><sup>40</sup></a>
Here’s how that goes. Our strategy is to
check for three things: (i) <code>X2</code> has an <code>X</code> and
<code>X3</code> is missing; (ii) <code>X2</code> is missing and <code>X3</code>
has an <code>X</code>; (iii) anything else, which is an error:</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb316-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb316-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb316-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb316-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gender =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb316-5" title="5">    X2 <span class="op">==</span><span class="st"> &quot;X&quot;</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(X3) <span class="op">~</span><span class="st"> &quot;Male&quot;</span>,</a>
<a class="sourceLine" id="cb316-6" title="6">    <span class="kw">is.na</span>(X2) <span class="op">&amp;</span><span class="st"> </span>X3 <span class="op">==</span><span class="st"> &quot;X&quot;</span> <span class="op">~</span><span class="st"> &quot;Female&quot;</span>,</a>
<a class="sourceLine" id="cb316-7" title="7">    <span class="ot">TRUE</span>                  <span class="op">~</span><span class="st"> &quot;Error!&quot;</span></a>
<a class="sourceLine" id="cb316-8" title="8">  ))</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 10
##    Time   X2    X3    X4    X5    X6    X7    X8    X9    gender
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     Male  
##  2 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     Male  
##  3 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     Male  
##  4 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     Male  
##  5 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     Male  
##  6 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     Male  
##  7 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     Female
##  8 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     Male  
##  9 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     X     &lt;NA&gt;  Female
## 10 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     Male  
## # … with 1,948 more rows</code></pre>
<p>It seems nicest to format it with the squiggles lining up,
so you can see what possible values <code>gender</code> might take.</p>
<p>The structure of the <code>case_when</code> is that the thing you’re
checking for goes on the left of the squiggle, and the value you want
your new variable to take goes on the right. What it does is to go
down the list of conditions that you are checking for, and as soon as
it finds one that is true, it grabs the value on the right of the
squiggle and moves on to the next row. The usual way to write these is
to have a catch-all condition at the end that is always true, serving
to make sure that your new variable always gets <em>some</em>
value. <code>TRUE</code> is, um, always true. If you want an English word
for the last condition of your <code>case_when</code>, “otherwise” is a
nice one.</p>
<p>I wanted to check that the observer did check exactly one of
<code>V2</code> and <code>V3</code> as I asserted, which can be done by
gluing this onto the end:</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb318-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb318-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb318-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb318-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gender =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb318-5" title="5">    X2 <span class="op">==</span><span class="st"> &quot;X&quot;</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(X3) <span class="op">~</span><span class="st"> &quot;Male&quot;</span>,</a>
<a class="sourceLine" id="cb318-6" title="6">    <span class="kw">is.na</span>(X2) <span class="op">&amp;</span><span class="st"> </span>X3 <span class="op">==</span><span class="st"> &quot;X&quot;</span> <span class="op">~</span><span class="st"> &quot;Female&quot;</span>,</a>
<a class="sourceLine" id="cb318-7" title="7">    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> &quot;Error!&quot;</span></a>
<a class="sourceLine" id="cb318-8" title="8">  )) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb318-9" title="9"><span class="st">  </span><span class="kw">count</span>(gender)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   gender     n
##   &lt;chr&gt;  &lt;int&gt;
## 1 Female   861
## 2 Male    1097</code></pre>
<p>There are only Males and Females, so the observer really did mark
exactly one X. (As a bonus, you see that there were slightly more male
cyclists than female ones.)</p>
<p>Extra: I was wondering how <code>pivot_longer</code> would play out here. The
way to do it seems to be to rename the columns we want first, and get rid of the others:</p>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb320-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb320-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb320-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb320-4" title="4"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">male =</span> X2, <span class="dt">female =</span> X3) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb320-5" title="5"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">starts_with</span>(<span class="st">&quot;X&quot;</span>))</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 3
##    Time   male  female
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 07:00  X     &lt;NA&gt;  
##  2 07:00  X     &lt;NA&gt;  
##  3 07:00  X     &lt;NA&gt;  
##  4 07:00  X     &lt;NA&gt;  
##  5 07:00  X     &lt;NA&gt;  
##  6 07:15  X     &lt;NA&gt;  
##  7 07:15  &lt;NA&gt;  X     
##  8 07:15  X     &lt;NA&gt;  
##  9 07:15  &lt;NA&gt;  X     
## 10 07:15  X     &lt;NA&gt;  
## # … with 1,948 more rows</code></pre>
<p>Each row should have one X and one missing in it, so we may as well drop the missings as we pivot-longer:</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb322-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb322-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb322-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb322-4" title="4"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">male =</span> X2, <span class="dt">female =</span> X3) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb322-5" title="5"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">starts_with</span>(<span class="st">&quot;X&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb322-6" title="6"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>Time, <span class="dt">names_to=</span><span class="st">&quot;gender&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;observed&quot;</span>, <span class="dt">values_drop_na =</span> T)</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 3
##    Time   gender observed
##    &lt;time&gt; &lt;chr&gt;  &lt;chr&gt;   
##  1 07:00  male   X       
##  2 07:00  male   X       
##  3 07:00  male   X       
##  4 07:00  male   X       
##  5 07:00  male   X       
##  6 07:15  male   X       
##  7 07:15  female X       
##  8 07:15  male   X       
##  9 07:15  female X       
## 10 07:15  male   X       
## # … with 1,948 more rows</code></pre>
<p>The <code>observed</code> column is kind of pointless, since its value is always X. But we do have a check: the previous data frame had 1958 rows, with an X in either the male or the female column. This data frame has the gender of each observed cyclist in the <code>gender</code> column, and it also has 1958 rows. So, either way, that’s how many cyclists were observed in total.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="6" style="list-style-type: lower-alpha">
<li>Create variables <code>helmet</code>, <code>passenger</code> and
<code>sidewalk</code> in your data frame that are <code>TRUE</code> if
the “Yes” column contains <code>X</code> and <code>FALSE</code>
otherwise. This will use <code>mutate</code> again, but you don’t
need <code>ifelse</code>: just set the variable equal to the
appropriate logical condition. As before, the best way to
create these variables is to test the appropriate things for
missingness. Note that you can create as many new variables
as you like in one <code>mutate</code>. Show the first few lines
of your new data frame. (Add your code onto the end of the
pipe you made above.)</li>
</ol>
<p>Solution</p>
<p>On the face of it, the way to do this is to go looking
for <code>X</code>’s:</p>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb324-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb324-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb324-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb324-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gender =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(X2), <span class="st">&quot;female&quot;</span>, <span class="st">&quot;male&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb324-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb324-6" title="6">    <span class="dt">helmet =</span> (X4 <span class="op">==</span><span class="st"> &quot;X&quot;</span>),</a>
<a class="sourceLine" id="cb324-7" title="7">    <span class="dt">passenger =</span> (X6 <span class="op">==</span><span class="st"> &quot;X&quot;</span>),</a>
<a class="sourceLine" id="cb324-8" title="8">    <span class="dt">sidewalk =</span> (X8 <span class="op">==</span><span class="st"> &quot;X&quot;</span>)</a>
<a class="sourceLine" id="cb324-9" title="9">  )</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 13
##    Time   X2    X3    X4    X5    X6    X7    X8    X9    gender helmet passenger sidewalk
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;lgl&gt;  &lt;lgl&gt;     &lt;lgl&gt;   
##  1 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   NA     NA        NA      
##  2 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   NA     NA        NA      
##  3 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   NA     NA        NA      
##  4 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   NA     NA        NA      
##  5 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   NA     NA        NA      
##  6 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male   TRUE   NA        NA      
##  7 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     female TRUE   NA        NA      
##  8 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male   TRUE   NA        NA      
##  9 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     X     &lt;NA&gt;  female TRUE   NA        TRUE    
## 10 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male   TRUE   NA        NA      
## # … with 1,948 more rows</code></pre>
<p>But, we run into the same problem that we did with <code>gender</code>:
the new variables are either <code>TRUE</code> or missing, never <code>FALSE</code>.</p>
<p>The solution is the same: look for the things that are <em>missing</em>
if the cyclist is wearing a helmet, carrying a passenger or riding on
the sidewalk. These are <code>X5, X7, X9</code> respectively:</p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb326-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb326-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb326-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb326-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gender =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(X2), <span class="st">&quot;female&quot;</span>, <span class="st">&quot;male&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb326-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb326-6" title="6">    <span class="dt">helmet =</span> <span class="kw">is.na</span>(X5),</a>
<a class="sourceLine" id="cb326-7" title="7">    <span class="dt">passenger =</span> <span class="kw">is.na</span>(X7),</a>
<a class="sourceLine" id="cb326-8" title="8">    <span class="dt">sidewalk =</span> <span class="kw">is.na</span>(X9)</a>
<a class="sourceLine" id="cb326-9" title="9">  )</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 13
##    Time   X2    X3    X4    X5    X6    X7    X8    X9    gender helmet passenger sidewalk
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;lgl&gt;  &lt;lgl&gt;     &lt;lgl&gt;   
##  1 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   FALSE  FALSE     FALSE   
##  2 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   FALSE  FALSE     FALSE   
##  3 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   FALSE  FALSE     FALSE   
##  4 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   FALSE  FALSE     FALSE   
##  5 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   FALSE  FALSE     FALSE   
##  6 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male   TRUE   FALSE     FALSE   
##  7 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     female TRUE   FALSE     FALSE   
##  8 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male   TRUE   FALSE     FALSE   
##  9 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     X     &lt;NA&gt;  female TRUE   FALSE     TRUE    
## 10 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male   TRUE   FALSE     FALSE   
## # … with 1,948 more rows</code></pre>
<p>Again, you can do the <code>mutate</code> all on one line if you want to,
or all four variable assignments in one <code>mutate</code>,
but I used newlines and indentation to make the structure
clear.</p>
<p>It is less elegant, though equally good for the purposes of the
assignment, to use <code>ifelse</code> for these as well, which would go
like this, for example:</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb328-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gender =</span> <span class="kw">ifelse</span>(X2 <span class="op">==</span><span class="st"> &quot;X&quot;</span>, <span class="st">&quot;male&quot;</span>, <span class="st">&quot;female&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb328-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">helmet =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(X5), T, F))</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 11
##    Time   X2    X3    X4    X5    X6    X7    X8    X9    gender helmet
##    &lt;time&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;lgl&gt; 
##  1 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   FALSE 
##  2 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   FALSE 
##  3 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   FALSE 
##  4 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   FALSE 
##  5 07:00  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;  X     male   FALSE 
##  6 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male   TRUE  
##  7 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     &lt;NA&gt;   TRUE  
##  8 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male   TRUE  
##  9 07:15  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;  X     X     &lt;NA&gt;  &lt;NA&gt;   TRUE  
## 10 07:15  X     &lt;NA&gt;  X     &lt;NA&gt;  &lt;NA&gt;  X     &lt;NA&gt;  X     male   TRUE  
## # … with 1,948 more rows</code></pre>
<p>and the same for <code>passenger</code> and <code>sidewalk</code>. The warning
is, whenever you see a <code>T</code> and an <code>F</code> in an
<code>ifelse</code>, that you could probably get rid of the
<code>ifelse</code> and use the logical condition directly.<a href="#fn41" class="footnote-ref" id="fnref41"><sup>41</sup></a></p>
<p>For <code>gender</code>, though, you need the
<code>ifelse</code> (or a <code>case_when</code>) because the values you want
it to take are <code>male</code> and <code>female</code>, something other than
<code>TRUE</code> and <code>FALSE</code>.</p>
<p>I like to put brackets around logical conditions when I am assigning
them to a variable or defining new columns containing them.
If I don’t, I get something like</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb330-1" title="1">helmet &lt;-<span class="st"> </span>V4 <span class="op">==</span><span class="st"> &quot;X&quot;</span></a></code></pre></div>
<p>which actually works, but is hard to read. Well, I <em>think</em> it
works. Let’s check:</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb331-1" title="1">exes &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;X&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;X&quot;</span>)</a>
<a class="sourceLine" id="cb331-2" title="2">y &lt;-<span class="st"> </span>exes <span class="op">==</span><span class="st"> &quot;X&quot;</span></a>
<a class="sourceLine" id="cb331-3" title="3">y</a></code></pre></div>
<pre><code>## [1]  TRUE FALSE  TRUE FALSE  TRUE</code></pre>
<p>Yes it does. But I would not recommend writing it this way, because
unless you are paying attention, you won’t notice that <code>==</code> is
testing for “logically equal” rather than putting something in a column.</p>
<p>It works because of a thing called “operator precedence”: the
logical-equals is evaluated first, and the result of that is saved in
the variable. But unless you or your readers remember that, it’s
better to write</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb333-1" title="1">y &lt;-<span class="st"> </span>(exes <span class="op">==</span><span class="st"> &quot;X&quot;</span>)</a></code></pre></div>
<p>to draw attention to the order of calculation. This is the same reason that</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb334-1" title="1"><span class="dv">4</span> <span class="op">+</span><span class="st"> </span><span class="dv">5</span> <span class="op">*</span><span class="st"> </span><span class="dv">6</span></a></code></pre></div>
<pre><code>## [1] 34</code></pre>
<p>evaluates this way rather than doing the addition first and getting
54. BODMAS and all that.</p>
<p>The <code>pivot_longer</code> approach works for these too. Rename the columns
as <code>yes</code> and <code>no</code>, and then give the <code>names_to</code> column a name like <code>helmet</code>.
Give the <code>values_to</code> column a name like
<code>what2</code>, to make it easier to remove later. And then do the
same with the others, one <code>pivot_longer</code> at a time. (Keep all the columns, and then discard them at the end if you want. That way you don’t risk deleting something you might need later.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="7" style="list-style-type: lower-alpha">
<li>Finally
(for the data manipulation), get rid of
all the original columns, keeping only the new ones that
you created. Save the results in a data frame and display
its first few rows.</li>
</ol>
<p>Solution</p>
<p>This is a breath of fresh air after all the thinking
needed above: this is just <code>select</code>, added to
the end:</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb336-1" title="1">mybikes &lt;-<span class="st"> </span>bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gender =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(X2), <span class="st">&quot;female&quot;</span>, <span class="st">&quot;male&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb336-6" title="6">    <span class="dt">helmet =</span> <span class="kw">is.na</span>(X5),</a>
<a class="sourceLine" id="cb336-7" title="7">    <span class="dt">passenger =</span> <span class="kw">is.na</span>(X7),</a>
<a class="sourceLine" id="cb336-8" title="8">    <span class="dt">sidewalk =</span> <span class="kw">is.na</span>(X9)</a>
<a class="sourceLine" id="cb336-9" title="9">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb336-10" title="10"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>(X2<span class="op">:</span>X9))</a>
<a class="sourceLine" id="cb336-11" title="11">mybikes</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 5
##    Time   gender helmet passenger sidewalk
##    &lt;time&gt; &lt;chr&gt;  &lt;lgl&gt;  &lt;lgl&gt;     &lt;lgl&gt;   
##  1 07:00  male   FALSE  FALSE     FALSE   
##  2 07:00  male   FALSE  FALSE     FALSE   
##  3 07:00  male   FALSE  FALSE     FALSE   
##  4 07:00  male   FALSE  FALSE     FALSE   
##  5 07:00  male   FALSE  FALSE     FALSE   
##  6 07:15  male   TRUE   FALSE     FALSE   
##  7 07:15  female TRUE   FALSE     FALSE   
##  8 07:15  male   TRUE   FALSE     FALSE   
##  9 07:15  female TRUE   FALSE     TRUE    
## 10 07:15  male   TRUE   FALSE     FALSE   
## # … with 1,948 more rows</code></pre>
<p>You might not have renamed your <code>X1</code>, in which case, you still
have it, but need to keep it (because it holds the times).</p>
<p>Another way to do this is to use a “select-helper”, thus:</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb338-1" title="1">bikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb338-2" title="2"><span class="st">  </span><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb338-3" title="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Time =</span> X1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb338-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gender =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(X2), <span class="st">&quot;female&quot;</span>, <span class="st">&quot;male&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb338-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb338-6" title="6">    <span class="dt">helmet =</span> <span class="kw">is.na</span>(X5),</a>
<a class="sourceLine" id="cb338-7" title="7">    <span class="dt">passenger =</span> <span class="kw">is.na</span>(X7),</a>
<a class="sourceLine" id="cb338-8" title="8">    <span class="dt">sidewalk =</span> <span class="kw">is.na</span>(X9)</a>
<a class="sourceLine" id="cb338-9" title="9">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb338-10" title="10"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">num_range</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">2</span><span class="op">:</span><span class="dv">9</span>))</a></code></pre></div>
<pre><code>## # A tibble: 1,958 x 5
##    Time   gender helmet passenger sidewalk
##    &lt;time&gt; &lt;chr&gt;  &lt;lgl&gt;  &lt;lgl&gt;     &lt;lgl&gt;   
##  1 07:00  male   FALSE  FALSE     FALSE   
##  2 07:00  male   FALSE  FALSE     FALSE   
##  3 07:00  male   FALSE  FALSE     FALSE   
##  4 07:00  male   FALSE  FALSE     FALSE   
##  5 07:00  male   FALSE  FALSE     FALSE   
##  6 07:15  male   TRUE   FALSE     FALSE   
##  7 07:15  female TRUE   FALSE     FALSE   
##  8 07:15  male   TRUE   FALSE     FALSE   
##  9 07:15  female TRUE   FALSE     TRUE    
## 10 07:15  male   TRUE   FALSE     FALSE   
## # … with 1,948 more rows</code></pre>
<p>This means “get rid of all the columns whose names are <em>X</em> followed by a number 2 through 9”.</p>
<p>The pipe looks long and forbidding, but you built it (and tested it) a
little at a time. Which is how you do it.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="8" style="list-style-type: lower-alpha">
<li>The next few parts are a quick-fire analysis of
the data set. They can all be solved using <code>count</code>.
How many male and how many female cyclists were observed
in total?</li>
</ol>
<p>Solution</p>
<p>I already got this one when I was checking for
observer-notation errors earlier:</p>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb340-1" title="1">mybikes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(gender)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   gender     n
##   &lt;chr&gt;  &lt;int&gt;
## 1 female   861
## 2 male    1097</code></pre>
<p>861 females and 1097 males.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol style="list-style-type: lower-roman">
<li>How many male and female cyclists were not
wearing helmets?</li>
</ol>
<p>Solution</p>
<p>You can count two variables at once, in which case
you get counts of all combinations of them:</p>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb342-1" title="1">mybikes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(gender, helmet)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##   gender helmet     n
##   &lt;chr&gt;  &lt;lgl&gt;  &lt;int&gt;
## 1 female FALSE    403
## 2 female TRUE     458
## 3 male   FALSE    604
## 4 male   TRUE     493</code></pre>
<p>403 females and 604 males were not wearing helmets, picking out what
we need.</p>
<p>The real question of interest here is “what <em>proportion</em> of male and female cyclists were not wearing helmets?”<a href="#fn42" class="footnote-ref" id="fnref42"><sup>42</sup></a>
This has a rather elegant
solution that I will have to explain. First, let’s go back to the
<code>group_by</code> and <code>summarize</code> version of the
<code>count</code> here:</p>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb344-1" title="1">mybikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb344-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(gender, helmet) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb344-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">the_count =</span> <span class="kw">n</span>())</a></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;gender&#39;. You can override using the `.groups` argument.</code></pre>
<pre><code>## # A tibble: 4 x 3
## # Groups:   gender [2]
##   gender helmet the_count
##   &lt;chr&gt;  &lt;lgl&gt;      &lt;int&gt;
## 1 female FALSE        403
## 2 female TRUE         458
## 3 male   FALSE        604
## 4 male   TRUE         493</code></pre>
<p>That’s the same table we got just now. Now, let’s calculate a
proportion and see what happens:</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb347-1" title="1">mybikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb347-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(gender, helmet) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb347-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">the_count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb347-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> the_count <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(the_count))</a></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;gender&#39;. You can override using the `.groups` argument.</code></pre>
<pre><code>## # A tibble: 4 x 4
## # Groups:   gender [2]
##   gender helmet the_count  prop
##   &lt;chr&gt;  &lt;lgl&gt;      &lt;int&gt; &lt;dbl&gt;
## 1 female FALSE        403 0.468
## 2 female TRUE         458 0.532
## 3 male   FALSE        604 0.551
## 4 male   TRUE         493 0.449</code></pre>
<p>We seem to have the proportions of males and females who were and were
not wearing a helmet, and you can check that this is indeed the case,
for example:</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb350-1" title="1"><span class="dv">403</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">403</span> <span class="op">+</span><span class="st"> </span><span class="dv">458</span>)</a></code></pre></div>
<pre><code>## [1] 0.4680604</code></pre>
<p>47% of females were not wearing helmets, while 55% of males were
helmetless. (You can tell from the original frequencies that a small
majority of females wore helmets and a small majority of males did not.)</p>
<p>Now, we have to ask ourselves: how on earth did that work?</p>
<p>When you calculate a summary (like our <code>sum(count)</code> above), it
figures that you can’t want the sum by gender-helmet combination,
since you already have those in <code>count</code>. You must want the sum
<em>over</em> something. What? What happens is that it goes back to the
<code>group_by</code> and “peels off” the last thing there, which in
this case is <code>helmet</code>, leaving only <code>gender</code>. It then
sums the counts for each gender, giving us what we wanted.</p>
<p>It just blows my mind that someone (ie., Hadley Wickham) could (i) think
that this would be a nice syntax to have (instead of just being an
error), (ii) find a way to implement it and (iii) find a nice logical
explanation (“peeling off”) to explain how it worked.</p>
<p>What happens if we switch the order of the things in the <code>group_by</code>?</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb352-1" title="1">mybikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb352-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(helmet, gender) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb352-3" title="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">the_count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb352-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> the_count <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(the_count))</a></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;helmet&#39;. You can override using the `.groups` argument.</code></pre>
<pre><code>## # A tibble: 4 x 4
## # Groups:   helmet [2]
##   helmet gender the_count  prop
##   &lt;lgl&gt;  &lt;chr&gt;      &lt;int&gt; &lt;dbl&gt;
## 1 FALSE  female       403 0.400
## 2 FALSE  male         604 0.600
## 3 TRUE   female       458 0.482
## 4 TRUE   male         493 0.518</code></pre>
<p>Now we get the proportion of helmeted riders of each gender, which is
not the same as what we had before. Before, we had “out of males”
and “out of females”; now we have “out of helmeted riders” and
“out of helmetless riders”. (The riders with helmets are almost
50–50 males and females, but the riders without helmets are about
60% male.)</p>
<p>This is row and column proportions in a contingency table, B22 style.</p>
<p>Now, I have to see whether the <code>count</code> variant of this works:</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb355-1" title="1">mybikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb355-2" title="2"><span class="st">  </span><span class="kw">count</span>(gender, helmet) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb355-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 4 x 4
##   gender helmet     n  prop
##   &lt;chr&gt;  &lt;lgl&gt;  &lt;int&gt; &lt;dbl&gt;
## 1 female FALSE    403 0.206
## 2 female TRUE     458 0.234
## 3 male   FALSE    604 0.308
## 4 male   TRUE     493 0.252</code></pre>
<p>It doesn’t. Well, it kind of does, but it divided by the sum of all of
them rather than “peeling off”, so these are overall proportions
rather than row or column proportions.</p>
<p>So I think you have to do this the <code>group_by</code> and
<code>summarize</code> way.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="10" style="list-style-type: lower-alpha">
<li>How many cyclists were riding on the sidewalk
<em>and</em> carrying a passenger?</li>
</ol>
<p>Solution</p>
<p>Not too many, I’d hope. Again:</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb357-1" title="1">mybikes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(passenger, sidewalk)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   passenger sidewalk     n
##   &lt;lgl&gt;     &lt;lgl&gt;    &lt;int&gt;
## 1 FALSE     FALSE     1880
## 2 FALSE     TRUE        73
## 3 TRUE      FALSE        5</code></pre>
<p>We’re looking for the “true”, “true” entry of that table, which
seems to have vanished. That means the count is <em>zero</em>:
none at all.
(There were
only 5 passenger-carrying riders, and they were all on the road.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="11" style="list-style-type: lower-alpha">
<li>What was the busiest 15-minute period of the
day, and how many cyclists were there then?</li>
</ol>
<p>Solution</p>
<p>The obvious way is to list every 15-minute period
and eyeball the largest frequency. There are quite a
few 15-minute periods, so be prepared to hit Next a
few times (or use <code>View</code>):</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb359-1" title="1">mybikes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(Time) </a></code></pre></div>
<pre><code>## # A tibble: 48 x 2
##    Time       n
##    &lt;time&gt; &lt;int&gt;
##  1 07:00      5
##  2 07:15      8
##  3 07:30      9
##  4 07:45      5
##  5 08:00     18
##  6 08:15     14
##  7 08:30     12
##  8 08:45     22
##  9 09:00     17
## 10 09:15     15
## # … with 38 more rows</code></pre>
<p>17:15, or 5:15 pm, with 128 cyclists.</p>
<p>But, computers are meant to save us that kind of effort. How? Note
that the output from <code>count</code> is itself a data frame, so
anything you can do to a data frame, you can do to <em>it</em>: for
example, display only the rows where the frequency equals the maximum
frequency:</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb361-1" title="1">mybikes <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb361-2" title="2"><span class="st">  </span><span class="kw">count</span>(Time) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb361-3" title="3"><span class="st">  </span><span class="kw">filter</span>(n <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   Time       n
##   &lt;time&gt; &lt;int&gt;
## 1 17:15    128</code></pre>
<p>That will actually display <em>all</em> the times where the cyclist
count equals the maximum, of which there might be more than one.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="feeling-the-heat-1" class="section level2">
<h2><span class="header-section-number">17.22</span> Feeling the heat</h2>
<p>In summer, the city of Toronto issues Heat Alerts for
“high heat or humidity that is expected to last two or more days”. The
precise definitions are shown at
<a href="http://www1.toronto.ca/wps/portal/contentonly?vgnextoid=923b5ce6dfb31410VgnVCM10000071d60f89RCRD">link</a>. During
a heat alert, the city opens Cooling Centres and may extend the hours
of operation of city swimming pools, among other things. All the heat
alert days from 2001 to 2016 are listed at
<a href="http://ritsokiguess.site/datafiles/heat.csv">link</a>.</p>
<p>The word “warning” is sometimes used in place of “alert” in these
data. They mean the same thing.<a href="#fn43" class="footnote-ref" id="fnref43"><sup>43</sup></a></p>
<ol style="list-style-type: lower-alpha">
<li>Read the data into R, and display the data frame. Note that there are four columns:</li>
</ol>
<ul>
<li><p>a numerical <code>id</code> (numbered upwards from the first Heat
Alert in 2001; some of the numbers are missing)</p></li>
<li><p>the <code>date</code> of the heat alert, in year-month-day
format with 4-digit years.</p></li>
<li><p>a text <code>code</code> for the type of heat alert</p></li>
<li><p><code>text</code> describing the kind of heat alert. This can be quite long.</p></li>
</ul>
<p>Solution</p>
<p>A <code>.csv</code>, so:</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb363-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/heat.csv&quot;</span></a>
<a class="sourceLine" id="cb363-2" title="2">heat &lt;-<span class="st"> </span><span class="kw">read_csv</span>(my_url)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   id = col_double(),
##   date = col_date(format = &quot;&quot;),
##   code = col_character(),
##   text = col_character()
## )</code></pre>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb365-1" title="1">heat</a></code></pre></div>
<pre><code>## # A tibble: 200 x 4
##       id date       code  text                                                                                         
##    &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt; &lt;chr&gt;                                                                                        
##  1   232 2016-09-08 HAU   Toronto&#39;s Medical Officer of Health has upgraded the Heat Warning to an Extended Heat Warning
##  2   231 2016-09-07 HAE   Toronto&#39;s Medical Officer of Health has continued the Heat Warning for today                 
##  3   230 2016-09-06 HA    Toronto&#39;s Medical Officer of Health has issued a Heat Warning                                
##  4   228 2016-08-13 EHAE  Toronto&#39;s Medical Officer of Health has continued the Extended Heat Warning for today        
##  5   227 2016-08-12 EHAE  Toronto&#39;s Medical Officer of Health has continued the Extended Heat Warning for today        
##  6   226 2016-08-11 HAU   Toronto&#39;s Medical Officer of Health has upgraded the Heat Warning to an Extended Heat Warning
##  7   225 2016-08-10 HAE   Toronto&#39;s Medical Officer of Health has continued the Heat Warning for today                 
##  8   224 2016-08-09 HA    Toronto&#39;s Medical Officer of Health has issued a Heat Warning                                
##  9   222 2016-08-05 HAE   Toronto&#39;s Medical Officer of Health has continued the Heat Warning for today                 
## 10   221 2016-08-04 HA    Toronto&#39;s Medical Officer of Health has issued a Heat Warning                                
## # … with 190 more rows</code></pre>
<p>You might get a truncated <code>text</code> as I did, or you might have to
click to see more of it. In any case, we won’t be using the text, so
you can just forget about it from here on.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>In your data frame, are the dates stored as genuine dates or as text? How can you tell?</li>
</ol>
<p>Solution</p>
<p>Look at the top of the column on your display of the data frame. Under the date column it says <code>date</code> rather than <code>chr</code> (which means “text”), so these are genuine dates.
This happened because the data file contained the dates in
year-month-day order, so <code>read_csv</code> read them in as
dates. (If they had been in some other order, they would have
been read in as text and we would need to use
<code>lubridate</code> to make them into dates.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>Which different heat alert codes do you have, and how many of each?</li>
</ol>
<p>Solution</p>
<p><code>count</code>, most easily:</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb367-1" title="1">heat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(code)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 2
##   code      n
##   &lt;chr&gt; &lt;int&gt;
## 1 EHA      59
## 2 EHAD      1
## 3 EHAE     18
## 4 HA       93
## 5 HAE      16
## 6 HAU      13</code></pre>
<p>Alternatively, <code>group_by</code> and <code>summarize</code>:</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb369-1" title="1">heat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(code) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>())</a></code></pre></div>
<pre><code>## # A tibble: 6 x 2
##   code  count
##   &lt;chr&gt; &lt;int&gt;
## 1 EHA      59
## 2 EHAD      1
## 3 EHAE     18
## 4 HA       93
## 5 HAE      16
## 6 HAU      13</code></pre>
<p>(note that <code>n()</code> gives the number of rows, in each group if you have groups.)</p>
<p>There are six different codes, but EHAD only appears once.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>Use the <code>text</code> in your dataset (or look back
at the original data file) to describe briefly in your own
words what the various codes represent.</li>
</ol>
<p>Solution</p>
<p>You can check that each time a certain code appears, the
text next to it is identical.
The six codes and my brief descriptions are:</p>
<ul>
<li>EHA: (Start of) Extended Heat Alert</li>
<li>EHAD: Extreme Heat Alert downgraded to Heat Alert</li>
<li>EHAE: Extended Heat Alert continues</li>
<li>HA: (Start of) Heat Alert</li>
<li>HAE: Heat Alert continues</li>
<li>HAU: Heat Alert upgraded to Extended Heat Alert</li>
</ul>
<p>I thought there was such a thing as an Extreme Heat Alert,
but here the word is (usually) Extended, meaning a heat
alert that extends over several days, long in duration
rather than extremely hot. The only place Extreme occurs
is in EHAD, which only occurs once.
I want your answer to say or suggest something about
whether a code applies <em>only</em> to continuing heat
alerts (ie., that EHAD, EHAE, HAE and HAU are different
from the others).</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>How many (regular and extended) heat alert events
are there altogether? A heat alert event is a stretch of
consecutive days, on all of which there is a heat alert or
extended heat alert. Hints: (i) you can answer this from
output you already have; (ii) how can you tell when a heat
alert event <em>starts</em>?</li>
</ol>
<p>Solution</p>
<p>This turned out to be more messed-up than I
thought. There is a detailed discussion below.
The codes EHAD, EHAE, HAE, HAU all indicate that there
was a heat alert on the day before. Only the codes HA
and EHA can indicate the start of a heat alert
(event). The problem is that HA and EHA sometimes
indicate the start of a heat alert event and sometimes
one that is continuing. You can check by looking at the
data that HA and EHA days can (though they don’t always:
see below) have a non-heat-alert day before (below) them
in the data file: for example, August 4, 2012 is an HA
day, but August 3 of that year was not part of any kind
of heat alert.
I had intended the answer to be this:</p>
<blockquote>
<p>So we get the total number of heat alert events by
totalling up the number of HA and EHA days:
<span class="math inline">\(59+93=152\)</span>.</p>
</blockquote>
<p>This is not right because there are some
consecutive EHA days, eg. 5–8 July 2010, so that EHA
sometimes indicates the continuation of an extended heat
alert and sometimes the start of one. I was expecting
EHA to be used only for the start, and one of the other
codes to indicate a continuation. The same is
(sometimes) true of HA.
So reasonable answers to the question as set include:</p>
<ul>
<li><p>93, the number of HAs</p></li>
<li><p>59, the number of EHAs</p></li>
<li><p>152, the number of HAs and EHAs combined</p></li>
<li><p>“152 or less”, “between 93 and 152”, ``between
59 and 152’’ to reflect that not all of these mark the
start of a heat alert event.</p></li>
</ul>
<p>Any of these, or something similar <em>with an explanation of how you got your answer</em>, are
acceptable. In your career as a data scientist, you will
often run into this kind of thing, and it will be your
job to do something with the data and <em>explain</em>
what you did so that somebody else can decide whether
they believe you or not. A good explanation, even if it
is not correct, will help you get at the truth because
it will inspire someone to say “in fact, it goes <em>this</em> way”,
and then the two of you can jointly
figure out what’s actually going on.
Detailed discussion follows. If you have <em>any</em>
ambitions of working with data, you should try to follow
the paragraphs below, because they indicate how you
would get an <em>actual</em> answer to the question.</p>
<p>I think the key is the number of days between one heat
alert day and the next one. <code>dplyr</code> has a
function <code>diff</code> that works out exactly this. Building
a pipeline, just because:</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb371-1" title="1">heat <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb371-2" title="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>text) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb371-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">daycount =</span> <span class="kw">as.numeric</span>(date)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb371-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">daydiff =</span> <span class="kw">abs</span>(<span class="kw">c</span>(<span class="kw">diff</span>(daycount), <span class="dv">0</span>)))</a></code></pre></div>
<pre><code>## # A tibble: 200 x 5
##       id date       code  daycount daydiff
##    &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt;    &lt;dbl&gt;   &lt;dbl&gt;
##  1   232 2016-09-08 HAU      17052       1
##  2   231 2016-09-07 HAE      17051       1
##  3   230 2016-09-06 HA       17050      24
##  4   228 2016-08-13 EHAE     17026       1
##  5   227 2016-08-12 EHAE     17025       1
##  6   226 2016-08-11 HAU      17024       1
##  7   225 2016-08-10 HAE      17023       1
##  8   224 2016-08-09 HA       17022       4
##  9   222 2016-08-05 HAE      17018       1
## 10   221 2016-08-04 HA       17017      11
## # … with 190 more rows</code></pre>
<p>Oof. I have some things to keep track of here:</p>
<ul>
<li><p>Get rid of the <code>text</code>, since it serves no purpose here.</p></li>
<li><p>The <code>date</code> column is a proper <code>Date</code> (we checked).</p></li>
<li><p>Then I want the date as number of days; since it
is a number of days internally, I just make it a number with
<code>as.numeric</code>.</p></li>
<li><p>Then I use <code>diff</code> to get the difference
between each date and the previous one, remembering to glue a 0 onto
the end so that I have the right number of differences.</p></li>
<li><p>Since the dates are most recent first, I take the absolute value
so that the <code>daydiff</code> values are positive (except for the one
that is 0 on the end).</p></li>
</ul>
<p>Still with me? All right. You can check that the <code>daydiff</code>
values are the number of days between the date on that line and the
line below it. For example, there were 24 days between August 13 and
September 6.</p>
<p>Now, when <code>daydiff</code> is 1, there was also a heat alert on the
previous day (the line below in the file), but when <code>daydiff</code> is
<em>not</em> 1, that day must have been the <em>start</em> of a heat
alert event. So if I count the non-1’s, that will count the number of heat
alert events there were. (That includes the difference of 0 on the
first day, the one at the end of the file.)</p>
<p>Thus my pipeline continues like this:</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb373-1" title="1">heat <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb373-2" title="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>text) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb373-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">daycount =</span> <span class="kw">as.numeric</span>(date)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb373-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">daydiff =</span> <span class="kw">abs</span>(<span class="kw">c</span>(<span class="kw">diff</span>(daycount), <span class="dv">0</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb373-5" title="5"><span class="st">  </span><span class="kw">count</span>(daydiff <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   `daydiff != 1`     n
##   &lt;lgl&gt;          &lt;int&gt;
## 1 FALSE            121
## 2 TRUE              79</code></pre>
<p>And that’s how many actual heat alert events there were: 79, less even
than the number of HAs. So that tells me that a lot of my HAs and EHAs
were actually continuations of heat alert events rather than the start
of them. I think I need to have a word with the City of Toronto about
their data collection processes.</p>
<p><code>count</code> will count anything that is, or can be made into, a
categorical variable. It doesn’t have to be one of the columns of your
data frame; here it is something that is either <code>TRUE</code> or
<code>FALSE</code> about every row of the data frame.</p>
<p>One step further: what <em>is</em> the connection between the codes and
the start of heat alert events? We can figure that out now:</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb375-1" title="1">heat <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb375-2" title="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>text) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb375-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">daycount =</span> <span class="kw">as.numeric</span>(date)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb375-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">daydiff =</span> <span class="kw">abs</span>(<span class="kw">c</span>(<span class="kw">diff</span>(daycount), <span class="dv">0</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb375-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">start =</span> (daydiff <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb375-6" title="6"><span class="st">  </span><span class="kw">count</span>(code, start)</a></code></pre></div>
<pre><code>## # A tibble: 8 x 3
##   code  start     n
##   &lt;chr&gt; &lt;lgl&gt; &lt;int&gt;
## 1 EHA   FALSE    53
## 2 EHA   TRUE      6
## 3 EHAD  FALSE     1
## 4 EHAE  FALSE    18
## 5 HA    FALSE    20
## 6 HA    TRUE     73
## 7 HAE   FALSE    16
## 8 HAU   FALSE    13</code></pre>
<p>I made a column <code>start</code> that is <code>TRUE</code> at the start of a
heat alert event and <code>FALSE</code> otherwise, by comparing the days
from the previous heat alert day with 1. Then I can make a
<code>table</code>, or, as here, the <code>dplyr</code> equivalent with
<code>count</code>.<a href="#fn44" class="footnote-ref" id="fnref44"><sup>44</sup></a>
Or <code>group_by</code> and <code>summarize</code>. What this
shows is that EHAD, EHAE, HAE and HAU <em>never</em> go with the start
of a heat alert event (as they shouldn’t). But look at the HAs and
EHAs. For the HAs, 73 of them go with the start of an event, but 20 do
not. For the EHAs, just 6 of them go with the start, and 53 do
not. (Thus, counting just the HAs was very much a reasonable thing to
do.)</p>
<p>The 79 heat alert events that we found above had 73 of them starting
with an HA, and just 6 starting with an EHA.
I wasn’t quite sure how this would come out, but I knew it had
something to do with the number of days between one heat alert day and
the next, so I calculated those first and then figured out what to do
with them.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="6" style="list-style-type: lower-alpha">
<li>We are going to investigate how many heat alert
days
there were in each year. To do that, we have
to extract the year from each of our dates.</li>
</ol>
<p>Solution</p>
<p>This will need <code>lubridate</code>:</p>
<div class="sourceCode" id="cb377"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb377-1" title="1"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb377-2" title="2">heat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>text) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">year</span>(date)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sample_n</span>(<span class="dv">10</span>)</a></code></pre></div>
<pre><code>## # A tibble: 10 x 4
##       id date       code   year
##    &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt; &lt;dbl&gt;
##  1   102 2009-06-25 EHA    2009
##  2    40 2005-06-13 EHA    2005
##  3    59 2005-08-08 HA     2005
##  4    51 2005-07-14 EHA    2005
##  5   206 2016-06-20 HAE    2016
##  6    61 2006-05-30 HA     2006
##  7   111 2010-07-05 EHA    2010
##  8    82 2007-06-25 HA     2007
##  9    60 2006-05-29 HA     2006
## 10   146 2012-06-29 HAE    2012</code></pre>
<p>That seems to have worked. I listed a random sample of rows to
get back to previous years.
Having convinced myself that it worked, let me save it:</p>
<div class="sourceCode" id="cb379"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb379-1" title="1">heat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>text) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">year</span>(date)) -&gt;<span class="st"> </span>heat</a></code></pre></div>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="7" style="list-style-type: lower-alpha">
<li>Count the number of heat alert days for each
year, by tabulating the year variable.
Looking at this table, would you say that there
have been more heat alert days in recent years? Explain
(very) briefly.</li>
</ol>
<p>Solution</p>
<p>Count them again:</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb380-1" title="1">heat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(year)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 2
##     year     n
##    &lt;dbl&gt; &lt;int&gt;
##  1  2001     9
##  2  2002    16
##  3  2003     6
##  4  2004     2
##  5  2005    26
##  6  2006    17
##  7  2007    15
##  8  2008     9
##  9  2009     3
## 10  2010    16
## 11  2011    12
## 12  2012    21
## 13  2013    13
## 14  2014     1
## 15  2015    12
## 16  2016    22</code></pre>
<p>There are various things you could say, most of which are likely to be
good. My immediate reaction is that most of the years with a lot of
heat-alert days are in the last few years, and most of the years with
not many are near the start, so there is something of an upward
trend. Having said that, 2014 is unusually low (that was a cool
summer), and 2005 was unusually high. (Was that the
summer of the big power outage? I forget.<sup>[I looked it up. It was 2003, my first summer in Ontario.])</sup>[I realize as I write this that you may not be old enough to remember these years. Sometimes I forget how old I am.]</p>
<p>You could also reasonably say that there isn’t much pattern: the
number of heat-alert days goes up and down. In fact, anything that’s
not obviously nonsense will do.</p>
<p>I was thinking about making a graph of these frequencies against year,
and sticking some kind of smooth trend on it. This uses the output we just got, which is itself a data frame:</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb382-1" title="1">heat <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb382-2" title="2"><span class="st">  </span><span class="kw">count</span>(year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb382-3" title="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">se =</span> F)</a></code></pre></div>
<pre><code>## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="pasias_files/figure-html/unnamed-chunk-216-1.png" width="672" /></p>
<p>The pattern is very scattered, as is commonly the case with
environmental-science-type data, but there is a very small upward
trend. So it seems that either answer is justified, either ``there is no trend’’ or
“there is something of an upward trend”.</p>
<p>The other thing I notice on this plot is that if there are a lot of
heat-alert days one year, there will probably also be a lot in the next
year (and correspondingly if the number of heat-alert days is below
average: it tends to be below average again in the next year). This
pattern is known to time-series people as “autocorrelation” and
indicates that the number of heat-alert days in one year and the next
is not independent: if you know one year, you can predict the next
year. (Assessment of trend and autocorrelation are hard to untangle properly.)</p>
<p>Extra 1: I learn from Environmental Science grad students (of whom we have a
number at UTSC) that the approved measure of association is called the
Mann-Kendall correlation, which is the Kendall correlation of the data
values with time. In the same way that we use the sign test when we
doubt normality, and it uses the data more crudely but safely, the
regular (so-called Pearson) correlation assumes normality (of the
errors in the regression of one variable on the other), and when you
doubt that (as you typically do with this kind of data) you compute a
different kind of correlation with time. What the Kendall correlation
does is to take each pair of observations and ask whether the trend
with time is uphill or downhill. For example, there were 3 heat-alert
days in 2009, 16 in 2010 and 12 in 2011. Between 2009 and 2010, the
trend is uphill (increasing with time), and also between 2009 and 2011
(there were more heat-alert days in the later year), but between 2010
and 2011 the trend is downhill. The idea of the Kendall correlation is
you take <em>all</em> the pairs of points, of which there are typically
rather a lot, count up how many pairs are uphill and how many
downhill, and apply a formula to get a correlation between <span class="math inline">\(-1\)</span> and
1. (If there are about an equal number of uphills and downhills, the
correlation comes out near 0; if they are mostly uphill, the
correlation is near 1, and if they are mostly downhill, the
correlation is near <span class="math inline">\(-1\)</span>.) It doesn’t matter <em>how</em> uphill or
downhill the trends are, only the number of each, in the same way that
the sign test only counts the <em>number</em> of values above or below
the hypothesized median, not how far above or below they are.</p>
<p>This can be calculated, and even tested:</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb384-1" title="1">heat <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb384-2" title="2"><span class="st">  </span><span class="kw">count</span>(year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb384-3" title="3"><span class="st">  </span><span class="kw">with</span>(., <span class="kw">cor.test</span>(year, n, <span class="dt">method =</span> <span class="st">&quot;kendall&quot;</span>))</a></code></pre></div>
<pre><code>## Warning in cor.test.default(year, n, method = &quot;kendall&quot;): Cannot compute exact p-value with ties</code></pre>
<pre><code>## 
##  Kendall&#39;s rank correlation tau
## 
## data:  year and n
## z = 0.31612, p-value = 0.7519
## alternative hypothesis: true tau is not equal to 0
## sample estimates:
##        tau 
## 0.05907646</code></pre>
<p>The Mann-Kendall correlation is a thoroughly unremarkable 0.06, and
with only 16 data points, a null hypothesis that the correlation is
zero is far from being rejected, P-value 0.7519 as shown. So this is
no evidence of a time trend at all.</p>
<p>Extra 2: I’d like to say a word about how I got these data. They came from
<a href="http://app.toronto.ca/opendata/heat_alerts/heat_alerts_list.json">link</a>. If
you take a look there, there are no obvious rows and columns. This
format is called JSON. Look a bit more carefully and you’ll see stuff
like this, repeated:</p>
<pre><code>
{&quot;id&quot;:&quot;232&quot;,&quot;date&quot;:&quot;2016-09-08&quot;,&quot;code&quot;:&quot;HAU&quot;,
&quot;text&quot;:&quot;Toronto&#39;s Medical Officer of Health has upgraded the Heat Warning to an Extended Heat Warning&quot;}
</code></pre>
<p>one for each heat alert day. These are “keys” (on the left side of
the <code>:</code>) and “values” (on the right side).<a href="#fn45" class="footnote-ref" id="fnref45"><sup>45</sup></a> The keys
are column headers (if the data were in a data frame) and the values
are the data values that would be in that column. In JSON generally,
there’s no need for the keys to be the same in every row, but if they
are, as they are here, the data can be arranged in a data frame. How?
Read on.</p>
<p>I did this in R, using a package called <code>jsonlite</code>, with this code:</p>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb388-1" title="1"><span class="kw">library</span>(jsonlite)</a>
<a class="sourceLine" id="cb388-2" title="2">url &lt;-<span class="st"> &quot;http://app.toronto.ca/opendata/heat_alerts/heat_alerts_list.json&quot;</span></a>
<a class="sourceLine" id="cb388-3" title="3">heat &lt;-<span class="st"> </span><span class="kw">fromJSON</span>(url, <span class="dt">simplifyDataFrame =</span> T)</a>
<a class="sourceLine" id="cb388-4" title="4"><span class="kw">head</span>(heat)</a>
<a class="sourceLine" id="cb388-5" title="5"><span class="kw">write_csv</span>(heat, <span class="st">&quot;heat.csv&quot;</span>)</a></code></pre></div>
<p>After loading the package, I create a variable <code>url</code> that
contains the URL for the JSON file. The <code>fromJSON</code> line takes
something that is JSON (which could be text, a file or a URL) and
converts it to and saves it in a data frame. Finally, I save the data
frame in a <code>.csv</code> file. That’s the <code>.csv</code> file you used. If you run that code, you’ll get a <code>.csv</code> file of heat
alerts right up to the present, and you can update my analysis.</p>
<p>Why <code>.csv</code>? If I had used <code>write_delim</code>, the values
would have been separated by spaces. <em>But</em>, the <code>text</code> is
a sentence of several words, which are themselves separated by
spaces. I could have had you read in everything else and not the
text, and then separated-by-spaces would have been fine, but I wanted
you to see the text so that you could understand the <code>code</code>
values. So <code>.csv</code> is what it was.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="isoflavones-1" class="section level2">
<h2><span class="header-section-number">17.23</span> Isoflavones</h2>
<p>The plant called kudzu was imported to the US South from Japan. It is rich in isoflavones, which are believed to be beneficial for bones. In a study, rats were randomly assigned to one of three diets: one with a low dose of isoflavones from kudzu, one with a high dose, and a control diet with no extra isoflavones. At the end of the study, each rat’s bone density was measured, in milligrams per square centimetre. The data as recorded are shown in .<a href="#fn46" class="footnote-ref" id="fnref46"><sup>46</sup></a> There are 15 observations for each treatment, and hence 45 altogether.</p>
<p>Here are some code ideas you might need to use later, all part of the <code>tidyverse</code>. You may need to find out how they work.</p>
<ul>
<li><code>col_names</code> (in the <code>read_</code> functions)</li>
<li><code>convert</code> (in various <code>tidyverse</code> functions)</li>
<li><code>fill</code></li>
<li><code>na_if</code></li>
<li><code>rename</code></li>
<li><code>separate_rows</code></li>
<li><code>skip</code> (in the <code>read_</code> functions)</li>
<li><code>values_drop_na</code> (in the <code>pivot_</code> functions)</li>
</ul>
<p>If you use any of these, <em>cite</em> the webpage(s) or other source(s) where you learned about them.</p>
<ol style="list-style-type: lower-alpha">
<li>Take a look at the data file. Describe briefly what you see.</li>
</ol>
<p>Solution</p>
<p>The data values are (at least kind of) aligned in columns, suggesting <code>read_table</code>. There are up to six bone density values in each row, with a header that spans all of them (by the looks of it). The treatment column looks all right except that some of the rows are blank.
The blank treatments are the same as the ones in the row(s) above them, you can infer, because there are 15 observations for each treatment, six, six, and then three. (This is how a spreadsheet is often laid out: blank means the same as the previous line.)<a href="#fn47" class="footnote-ref" id="fnref47"><sup>47</sup></a></p>
<p>This, you might observe, will need some tidying.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Read in the data, using <code>read_table</code>, and get it into a tidy form, suitable for making a graph. This means finishing with (at least) a column of treatments with a suitable name (the treatments will be text) and a column of bone density values (numbers), one for each rat. You can have other columns as well; there is no obligation to get rid of them. Describe your process clearly enough that someone new to this data set would be able to understand what you have done and reproduce it on another similar dataset. Before you begin, think about whether or not you want to keep the column headers that are in the data file or not. (It can be done either way, but one way is easier than the other.)</li>
</ol>
<p>Solution</p>
<p>The tidying part is a fair bit easier to see if you <em>do not</em> read the column headers. A clue to this is that <code>bone_mineral_density</code> is not aligned with the values (of bone mineral density) below it. The next question is how to do that. You might remember <code>col_names=FALSE</code> from when the data file has no column headers at all, but here it <em>does</em> have headers; we just want to skip over them. Keep reading in the documentation for <code>read_table</code>, and you’ll find an option <code>skip</code> that does exactly that, leading to:</p>
<div class="sourceCode" id="cb389"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb389-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/isoflavones.txt&quot;</span></a>
<a class="sourceLine" id="cb389-2" title="2">bmd0a &lt;-<span class="st"> </span><span class="kw">read_table</span>(my_url, <span class="dt">col_names =</span> <span class="ot">FALSE</span>, <span class="dt">skip =</span> <span class="dv">1</span>)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   X1 = col_character(),
##   X2 = col_double(),
##   X3 = col_double(),
##   X4 = col_double(),
##   X5 = col_double(),
##   X6 = col_double(),
##   X7 = col_double()
## )</code></pre>
<div class="sourceCode" id="cb391"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb391-1" title="1">bmd0a</a></code></pre></div>
<pre><code>## # A tibble: 9 x 7
##   X1             X2    X3    X4    X5    X6    X7
##   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 &quot;control&quot;     228   207   234   220   217   228
## 2 &quot;&quot;            209   221   204   220   203   219
## 3 &quot;&quot;            218   245   210    NA    NA    NA
## 4 &quot;low_dose&quot;    211   220   211   233   219   233
## 5 &quot;&quot;            226   228   216   225   200   208
## 6 &quot;&quot;            198   208   203    NA    NA    NA
## 7 &quot;high_dose&quot;   250   237   217   206   247   228
## 8 &quot;&quot;            245   232   267   261   221   219
## 9 &quot;&quot;            232   209   255    NA    NA    NA</code></pre>
<p>If you miss the <code>skip</code>, the first row of “data” will be those column headers that were in the data file, and you really don’t want that. The link  talks about both <code>col_names</code> and <code>skip</code>.</p>
<p>This, however, is looking very promising. A pivot_longer will get those columns of numbers into one column, which we can call something like <code>bmd</code>, and but, not so fast. What about those blank treatments in <code>X1</code>? The first two blank ones are <code>control</code>, the next two are <code>low_dose</code> and the last two are <code>high_dose</code>. How do we fill them in? The word “fill” might inspire you to read up on <code>fill</code>. Except that this doesn’t quite work, because it replaces <em>missings</em> with the non-missing value above them, and we have blanks, not missings.</p>
<p>All right, can we replace the blanks with missings, and then <code>fill</code> those? This might inspire you to go back to the list of ideas in the question, and find out what <code>na_if</code> does: namely, exactly this! Hence:</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb393-1" title="1">bmd0a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">X1=</span><span class="kw">na_if</span>(X1, <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb393-2" title="2"><span class="kw">fill</span>(X1) </a></code></pre></div>
<pre><code>## # A tibble: 9 x 7
##   X1           X2    X3    X4    X5    X6    X7
##   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 control     228   207   234   220   217   228
## 2 control     209   221   204   220   203   219
## 3 control     218   245   210    NA    NA    NA
## 4 low_dose    211   220   211   233   219   233
## 5 low_dose    226   228   216   225   200   208
## 6 low_dose    198   208   203    NA    NA    NA
## 7 high_dose   250   237   217   206   247   228
## 8 high_dose   245   232   267   261   221   219
## 9 high_dose   232   209   255    NA    NA    NA</code></pre>
<p>Run this one line at a time to see how it works. <code>fill</code> takes a column with missing values to replace, namely <code>X1</code>, and <code>na_if</code> takes two things: a column containing some values to make <code>NA</code>, and the values that should be made <code>NA</code>, namely the blank ones.</p>
<p>So that straightens out the treatment column. It needs renaming; you can do that now, or wait until later. I’m going to wait on that.</p>
<p>You need to organize the treatment column first, before you do the <code>pivot_longer</code>, or else that won’t work.<a href="#fn48" class="footnote-ref" id="fnref48"><sup>48</sup></a></p>
<p>Now, we need to get one column of bone mass densities, instead of six. This you’ll recognize as a standard <code>pivot_longer</code>, with one tweak: those missing values in <code>X5</code> through <code>X7</code>, which we want to get rid of. You might remember that this is what <code>values_drop_na</code> does:</p>
<div class="sourceCode" id="cb395"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb395-1" title="1">bmd0a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">X1=</span><span class="kw">na_if</span>(X1, <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb395-2" title="2"><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb395-3" title="3"><span class="kw">pivot_longer</span>(X2<span class="op">:</span>X7, <span class="dt">names_to=</span><span class="st">&quot;old&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;bmd&quot;</span>, <span class="dt">values_drop_na=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## # A tibble: 45 x 3
##    X1      old     bmd
##    &lt;chr&gt;   &lt;chr&gt; &lt;dbl&gt;
##  1 control X2      228
##  2 control X3      207
##  3 control X4      234
##  4 control X5      220
##  5 control X6      217
##  6 control X7      228
##  7 control X2      209
##  8 control X3      221
##  9 control X4      204
## 10 control X5      220
## # … with 35 more rows</code></pre>
<p>If you didn’t think of <code>values_drop_na</code>, do the pivot without, and then check that you have too many rows because the missings are still there (there are 45 rats but you have 54 rows), so add a <code>drop_na()</code> to the end of your pipe. The only missing values are in the column I called <code>bmd</code>.</p>
<p>This is almost there. We have a numeric column of bone mass densities, a column called <code>old</code> that we can ignore, and a treatment column with a stupid name that we can fix. I find <code>rename</code> backwards: the syntax is new name equals old name, so you start with the name that doesn’t exist yet and finish with the one you want to get rid of:</p>
<div class="sourceCode" id="cb397"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb397-1" title="1">bmd0a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">X1=</span><span class="kw">na_if</span>(X1, <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb397-2" title="2"><span class="kw">fill</span>(X1) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb397-3" title="3"><span class="kw">pivot_longer</span>(X2<span class="op">:</span>X7, <span class="dt">names_to=</span><span class="st">&quot;old&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;bmd&quot;</span>, <span class="dt">values_drop_na=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb397-4" title="4"><span class="kw">rename</span>(<span class="dt">treatment=</span>X1) -&gt;<span class="st"> </span>bmd1b</a>
<a class="sourceLine" id="cb397-5" title="5">bmd1b</a></code></pre></div>
<pre><code>## # A tibble: 45 x 3
##    treatment old     bmd
##    &lt;chr&gt;     &lt;chr&gt; &lt;dbl&gt;
##  1 control   X2      228
##  2 control   X3      207
##  3 control   X4      234
##  4 control   X5      220
##  5 control   X6      217
##  6 control   X7      228
##  7 control   X2      209
##  8 control   X3      221
##  9 control   X4      204
## 10 control   X5      220
## # … with 35 more rows</code></pre>
<p>Done!</p>
<p>The best way to describe this kind of work is to run your pipeline up to a point that needs explanation, describe what comes next, and then run the <em>whole pipeline</em> again up to the next point needing explanation, rinse and repeat. (This avoids creating unnecessary temporary dataframes, since the purpose of the pipe is to avoid those.)</p>
<p>The guideline for description is that if <em>you</em> don’t know what’s going to happen next, your reader won’t know either. For me, that was these steps:</p>
<ul>
<li>read the data file without row names and see how it looks</li>
<li>fix up the treatment column (convincing myself and the reader that we were now ready to pivot-longer)</li>
<li>do the <code>pivot_longer</code> and make sure it worked</li>
<li>rename the treatment column</li>
</ul>
<p>So, I said there was another way. This happens to have a simple but clever solution. It starts from wondering "what happens if I read the data file <em>with</em> column headers, the normal way? Do it and find out:</p>
<div class="sourceCode" id="cb399"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb399-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/isoflavones.txt&quot;</span></a>
<a class="sourceLine" id="cb399-2" title="2">bmd0b &lt;-<span class="st"> </span><span class="kw">read_table</span>(my_url)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   treatment = col_character(),
##   bone_mineral_density = col_character()
## )</code></pre>
<div class="sourceCode" id="cb401"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb401-1" title="1">bmd0b</a></code></pre></div>
<pre><code>## # A tibble: 9 x 2
##   treatment   bone_mineral_density   
##   &lt;chr&gt;       &lt;chr&gt;                  
## 1 &quot;control&quot;   228 207 234 220 217 228
## 2 &quot;&quot;          209 221 204 220 203 219
## 3 &quot;&quot;          218 245 210            
## 4 &quot;low_dose&quot;  211 220 211 233 219 233
## 5 &quot;&quot;          226 228 216 225 200 208
## 6 &quot;&quot;          198 208 203            
## 7 &quot;high_dose&quot; 250 237 217 206 247 228
## 8 &quot;&quot;          245 232 267 261 221 219
## 9 &quot;&quot;          232 209 255</code></pre>
<p>This looks … strange. There are two column headers, and so there are two columns. It so happened that this worked because the text <code>bone_mineral_density</code> is long enough to span all the columns of numbers. That second column is actually <em>text</em>: six or three numbers as text with spaces between them.</p>
<p>The first thing is, as before, to fill in the missing treatments, which is as above, but changing some names:</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb403-1" title="1">bmd0b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">treatment=</span><span class="kw">na_if</span>(treatment, <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb403-2" title="2"><span class="kw">fill</span>(treatment) </a></code></pre></div>
<pre><code>## # A tibble: 9 x 2
##   treatment bone_mineral_density   
##   &lt;chr&gt;     &lt;chr&gt;                  
## 1 control   228 207 234 220 217 228
## 2 control   209 221 204 220 203 219
## 3 control   218 245 210            
## 4 low_dose  211 220 211 233 219 233
## 5 low_dose  226 228 216 225 200 208
## 6 low_dose  198 208 203            
## 7 high_dose 250 237 217 206 247 228
## 8 high_dose 245 232 267 261 221 219
## 9 high_dose 232 209 255</code></pre>
<p>The way we learned in class for dealing with this kind of thing is <code>separate</code>. It is rather unwieldy here since we have to split <code>bone_mineral_density</code> into six (temporary) things:</p>
<div class="sourceCode" id="cb405"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb405-1" title="1">bmd0b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">treatment=</span><span class="kw">na_if</span>(treatment, <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb405-2" title="2"><span class="kw">fill</span>(treatment) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb405-3" title="3"><span class="kw">separate</span>(bone_mineral_density, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;z1&quot;</span>, <span class="st">&quot;z2&quot;</span>, <span class="st">&quot;z3&quot;</span>, <span class="st">&quot;z4&quot;</span>, <span class="st">&quot;z5&quot;</span>, <span class="st">&quot;z6&quot;</span>))</a></code></pre></div>
<pre><code>## Warning: Expected 6 pieces. Missing pieces filled with `NA` in 3 rows [3, 6, 9].</code></pre>
<pre><code>## # A tibble: 9 x 7
##   treatment z1    z2    z3    z4    z5    z6   
##   &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 control   228   207   234   220   217   228  
## 2 control   209   221   204   220   203   219  
## 3 control   218   245   210   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 4 low_dose  211   220   211   233   219   233  
## 5 low_dose  226   228   216   225   200   208  
## 6 low_dose  198   208   203   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 7 high_dose 250   237   217   206   247   228  
## 8 high_dose 245   232   267   261   221   219  
## 9 high_dose 232   209   255   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;</code></pre>
<p>This works, though if you check, there’s a warning that some of the rows don’t have six values. However, these have been replaced by missings, which is just fine. From here, we do exactly what we did before: pivot-longer all the columns I called <code>z</code>-something, and get rid of the missings.</p>
<p>Having thought of <code>separate</code>, maybe you’re now wondering what <code>separate_rows</code> does. It turns out that it bypasses the business of creating extra columns and then pivoting them longer, thus:</p>
<div class="sourceCode" id="cb408"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb408-1" title="1">bmd0b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">treatment=</span><span class="kw">na_if</span>(treatment, <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb408-2" title="2"><span class="kw">fill</span>(treatment)  <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb408-3" title="3"><span class="kw">separate_rows</span>(bone_mineral_density, <span class="dt">convert =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>bmd1a</a>
<a class="sourceLine" id="cb408-4" title="4">bmd1a</a></code></pre></div>
<pre><code>## # A tibble: 45 x 2
##    treatment bone_mineral_density
##    &lt;chr&gt;                    &lt;int&gt;
##  1 control                    228
##  2 control                    207
##  3 control                    234
##  4 control                    220
##  5 control                    217
##  6 control                    228
##  7 control                    209
##  8 control                    221
##  9 control                    204
## 10 control                    220
## # … with 35 more rows</code></pre>
<p>Boom! This takes all the things in that mess in <code>bone_mineral_density</code>, splits them up into individual data values, and puts them one per row back into the same column. The <code>convert</code> is needed because otherwise the values in the second column would be text and you wouldn’t be able to plot them. (If you don’t see that, use a mutate to convert the column into the numerical version of itself.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>The statistician on this study is thinking about running an ordinary analysis of variance to compare the bone mineral density for the different treatments. Obtain a plot from your tidy dataframe that will help her decide whether that is a good idea.</li>
</ol>
<p>Solution</p>
<p>The key issues here are whether the values within each treatment group are close enough to normally distributed, and, if they are, whether the spreads are close enough to equal. The best plot is therefore a normal quantile plot of each of the three groups, in facets. You can do this <em>without</em> <code>scales="free"</code>:</p>
<div class="sourceCode" id="cb410"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb410-1" title="1"><span class="kw">ggplot</span>(bmd1b, <span class="kw">aes</span>(<span class="dt">sample=</span>bmd)) <span class="op">+</span><span class="st"> </span><span class="kw">stat_qq</span>() <span class="op">+</span><span class="st"> </span><span class="kw">stat_qq_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb410-2" title="2"><span class="kw">facet_wrap</span>(<span class="op">~</span>treatment)</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-227-1.png" width="672" /></p>
<p>The value of doing it this way is that you also get a sense of variability, from the slopes of the lines, or from how much of each box is filled vertically. (Here, the high-dose values are more spread-out than the other two groups, which are similar in spread.)</p>
<p>You could also do it <em>with</em> <code>scales = "free"</code>:</p>
<div class="sourceCode" id="cb411"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb411-1" title="1"><span class="kw">ggplot</span>(bmd1b, <span class="kw">aes</span>(<span class="dt">sample=</span>bmd)) <span class="op">+</span><span class="st"> </span><span class="kw">stat_qq</span>() <span class="op">+</span><span class="st"> </span><span class="kw">stat_qq_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb411-2" title="2"><span class="kw">facet_wrap</span>(<span class="op">~</span>treatment, <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>)</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-228-1.png" width="672" /></p>
<p>The value of doing it <em>this</em> way is that you fill the facets (what I called “not wasting real estate” on an earlier assignment), and so you get a better assessment of normality, but the downside is that you will need another plot, for example a boxplot (see below) to assess equality of spreads if you are happy with the normality.</p>
<p>I’m happy with either way of making the normal quantile plots, as long as you have a <em>reason</em> for your choice, coming from what you will be using the normal quantile plot for. You might not think of saying that here as you do it, but when you do the next part, you may realize that you need to assess equality of spreads, and in that case you should come back here and add a reason for using or not using <code>scales = "free"</code>.</p>
<p>The next-best graph here is boxplots:</p>
<div class="sourceCode" id="cb412"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb412-1" title="1"><span class="kw">ggplot</span>(bmd1b, <span class="kw">aes</span>(<span class="dt">x=</span>treatment, <span class="dt">y=</span>bmd)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-229-1.png" width="672" /></p>
<p>This is not so good because it doesn’t address normality as directly (just giving you a general sense of shape). On the other hand, you can assess spread directly with a boxplot; see discussion above.</p>
<p>The grader is now probably thoroughly confused, so let me summarize possible answers in order of quality:</p>
<ol style="list-style-type: decimal">
<li>A normal quantile plot of all three groups, using <code>scales = "free"</code> or not, with a good reason. (If with <code>scales = "free"</code>, and there needs to be a comparison of spread, there needs to be a boxplot or similar below as well. That’s what I meant by “any additional graphs” in the next part.)</li>
<li>A normal quantile plot of all three groups, using <code>scales = "free"</code> or not, <em>without</em> a good reason.</li>
<li>A side-by-side boxplot. Saying in addition that normality doesn’t matter so much because we have moderate-sized samples of 15 and therefore that boxplots are good enough moves this answer up a place.</li>
</ol>
<p>Note that getting the graph is (relatively) easy once you have the tidy data, but is impossible if you don’t! This is the way the world of applied statistics works; without being able to get your data into the right form, you won’t be able to do <em>anything</em> else. This question is consistent with that fact; I’m not going to give you a tidy version of the data so that you can make some graphs. The point of this question is to see whether you can get the data tidy enough, and if you can, you get the bonus of being able to do something straightforward with it.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>Based on your graph, and any additional graphs you wish to draw, what analysis would you recommend for this dataset? Explain briefly. (Don’t do the analysis.)</li>
</ol>
<p>Solution</p>
<p>Make a decision about normality first. You need <em>all three</em> groups to be sufficiently normal. I don’t think there’s any doubt about the high-dose and low-dose groups; these are if anything <em>short</em>-tailed, which is not a problem for the ANOVA. You might find that the control group is OK too; make a call. Or you might find it skewed to the right, something suggested rather more by the boxplot. My take, from looking at the normal quantile plot, is that the highest value in the control group is a little too high, but with a sample size of 15, the Central Limit Theorem will take care of that. For yourself, you can find a bootstrapped sampling distribution of the sample mean for the control group and see how normal it looks.</p>
<p>If you are not happy with the normality, recommend Mood’s median test.</p>
<p>If you are OK with the normality, you need to assess equal spreads. You can do this from a boxplot, where the high-dose group clearly has bigger spread. Or, if you drew normal quantile plots <em>without</em> <code>scales = "free"</code>, compare the slopes of the lines. This means that you need to recommend a Welch ANOVA.</p>
<p>If your normal quantile plots looked like this:</p>
<div class="sourceCode" id="cb413"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb413-1" title="1"><span class="kw">ggplot</span>(bmd1b, <span class="kw">aes</span>(<span class="dt">sample=</span>bmd)) <span class="op">+</span><span class="st"> </span><span class="kw">stat_qq</span>() <span class="op">+</span><span class="st"> </span><span class="kw">stat_qq_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb413-2" title="2"><span class="kw">facet_wrap</span>(<span class="op">~</span>treatment, <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>)</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-230-1.png" width="672" /></p>
<p>the only way to assess spread is to make another plot, and for this job, the boxplot is best.</p>
<p>Extra 1: the bootstrapped sampling distribution of the sample mean for the control group goes this way:</p>
<div class="sourceCode" id="cb414"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb414-1" title="1">bmd1b <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb414-2" title="2"><span class="kw">filter</span>(treatment <span class="op">==</span><span class="st"> &quot;control&quot;</span>) -&gt;<span class="st"> </span>d</a>
<a class="sourceLine" id="cb414-3" title="3"><span class="kw">tibble</span>(<span class="dt">sim =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb414-4" title="4"><span class="st">  </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb414-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">my_sample =</span> <span class="kw">list</span>(<span class="kw">sample</span>(d<span class="op">$</span>bmd, <span class="dt">replace =</span> <span class="ot">TRUE</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb414-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">my_mean =</span> <span class="kw">mean</span>(my_sample)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb414-7" title="7"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> my_mean)) <span class="op">+</span><span class="st"> </span><span class="kw">stat_qq</span>() <span class="op">+</span><span class="st"> </span><span class="kw">stat_qq_line</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-232-1.png" width="672" /></p>
<p>No problems there. The Welch ANOVA is fine.</p>
<p>Extra 2: You might be curious how the analysis comes out. Here is Welch:</p>
<div class="sourceCode" id="cb415"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb415-1" title="1"><span class="kw">oneway.test</span>(bmd<span class="op">~</span>treatment, <span class="dt">data=</span>bmd1b)</a></code></pre></div>
<pre><code>## 
##  One-way analysis of means (not assuming equal variances)
## 
## data:  bmd and treatment
## F = 5.6941, num df = 2.000, denom df = 27.075, p-value = 0.008627</code></pre>
<p>Not all the same means, so use Games-Howell to explore:</p>
<div class="sourceCode" id="cb417"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb417-1" title="1"><span class="kw">gamesHowellTest</span>(bmd<span class="op">~</span><span class="kw">factor</span>(treatment), <span class="dt">data =</span> bmd1b)</a></code></pre></div>
<pre><code>## 
##  Pairwise comparisons using Games-Howell test</code></pre>
<pre><code>## data: bmd by factor(treatment)</code></pre>
<pre><code>##           control high_dose
## high_dose 0.0238  -        
## low_dose  0.7680  0.0072</code></pre>
<pre><code>## 
## P value adjustment method: none</code></pre>
<pre><code>## alternative hypothesis: two.sided</code></pre>
<p>High dose is significantly different from both the other two, which are not significantly different from each other.</p>
<p>Mood’s median test, for comparison:</p>
<div class="sourceCode" id="cb423"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb423-1" title="1"><span class="kw">median_test</span>(bmd1b, bmd, treatment)</a></code></pre></div>
<pre><code>## $table
##            above
## group       above below
##   control       5     8
##   high_dose    11     4
##   low_dose      5     9
## 
## $test
##        what     value
## 1 statistic 5.1018315
## 2        df 2.0000000
## 3   P-value 0.0780102</code></pre>
<p>Not <em>any</em> significant differences, although it is a close thing.</p>
<p>The table of aboves and belows suggests the same thing as the Welch test: the high-dose values are mainly high, and the others are mostly low. But with these sample sizes it is not strong enough evidence. My guess is that the median test is lacking power compared to the Welch test; having seen that the Welch test is actually fine, it is better to use that here.<a href="#fn49" class="footnote-ref" id="fnref49"><sup>49</sup></a></p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="jockos-garage-1" class="section level2">
<h2><span class="header-section-number">17.24</span> Jocko’s Garage</h2>
<p>Insurance adjusters are concerned that Jocko’s Garage is giving estimates for repairing car damage that are too high. To see whether this is indeed the case, ten cars that had been in collisions were taken to both Jocko’s Garage and another garage, and the two estimates for repair were recorded. The data as recorded are <a href="http://ritsokiguess.site/datafiles/jocko.txt">here</a>.</p>
<ol style="list-style-type: lower-alpha">
<li>Take a look at the data file (eg. by using your web browser). How are the data laid out? Do there appear to be column headers?</li>
</ol>
<p>Solution</p>
<p>The data are laid out in aligned columns, so that we will need to use <code>read_table</code> to read it in. There are no column headers, since there is no line at the top of the file saying what each column represents. (The fact that I was asking about column headers is kind of a clue that something non-standard is happening there.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Read in and display the data file, bearing in mind what you just concluded about it. What names did the columns acquire?</li>
</ol>
<p>Solution</p>
<p>As mentioned above, you’ll need <code>read_table</code>, plus <code>col_names=FALSE</code> to <em>not</em> read the first row as column names:</p>
<div class="sourceCode" id="cb425"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb425-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/jocko.txt&quot;</span></a>
<a class="sourceLine" id="cb425-2" title="2">cars0 &lt;-<span class="st"> </span><span class="kw">read_table</span>(my_url, <span class="dt">col_names =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   X1 = col_character(),
##   X2 = col_character(),
##   X3 = col_double(),
##   X4 = col_double(),
##   X5 = col_double(),
##   X6 = col_double(),
##   X7 = col_double()
## )</code></pre>
<div class="sourceCode" id="cb427"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb427-1" title="1">cars0</a></code></pre></div>
<pre><code>## # A tibble: 6 x 7
##   X1    X2       X3    X4    X5    X6    X7
##   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 a     Car       1     2     3     4     5
## 2 a     Jocko  1375  1550  1250  1300   900
## 3 a     Other  1250  1300  1250  1200   950
## 4 b     Car       6     7     8     9    10
## 5 b     Jocko  1500  1750  3600  2250  2800
## 6 b     Other  1575  1600  3300  2125  2600</code></pre>
<p>The column names have become <code>X1</code> through <code>X7</code>. You’ll need to work with these in a minute, so it is good to be aware of that now.</p>
<p>I used a “temporary” name for my dataframe since we are going to be tidying it before we do anything with it, and I’m saving the “good” name <code>cars</code> for the tidy one.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>Make this data set tidy. That is, you need to end up with columns containing the repair cost estimates at each of the two garages and also identifying the cars, with each observation on one row. Describe your thought process. (It needs to be possible for the reader to follow your description and understand why it works.)
Save your tidy dataframe.</li>
</ol>
<p>Solution</p>
<p>This looks very far from tidy right now. The things in <code>X2</code> look like they will need to be variable names eventually, but there are two copies of them, and there are also five columns of data values that need eventually to become three. Having all the data values in <em>one</em> column might be a useful place to start:</p>
<div class="sourceCode" id="cb429"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb429-1" title="1">cars0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(X3<span class="op">:</span>X7, <span class="dt">names_to=</span><span class="st">&quot;old_cols&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;values&quot;</span>) </a></code></pre></div>
<pre><code>## # A tibble: 30 x 4
##    X1    X2    old_cols values
##    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1 a     Car   X3            1
##  2 a     Car   X4            2
##  3 a     Car   X5            3
##  4 a     Car   X6            4
##  5 a     Car   X7            5
##  6 a     Jocko X3         1375
##  7 a     Jocko X4         1550
##  8 a     Jocko X5         1250
##  9 a     Jocko X6         1300
## 10 a     Jocko X7          900
## # … with 20 more rows</code></pre>
<p>This is tidier, but it’s now <em>too long</em>: this has 30 rows but there are only 10 cars, or, depending on your point of view, there are 20 observations on 10 individual cars, so you could justify (in some way) having 20 rows, but not 30.</p>
<p>Now, therefore, we need to pivot <em>wider</em>. But to get to this point, we had to try pivoting longer to see what it did, and then go from there. I don’t think it’s at all obvious that this is what will happen, so I think you need to do a pivot-longer first, <em>talk about it</em>, and then move on.</p>
<p>From here, we want to make columns whose names are the things in <code>X2</code>, and whose values are the things in <code>values</code>. This is exactly what <code>pivot_wider</code> does, so add that to our pipe:</p>
<div class="sourceCode" id="cb431"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb431-1" title="1">cars0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(X3<span class="op">:</span>X7, <span class="dt">names_to=</span><span class="st">&quot;names&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;values&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb431-2" title="2"><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> values) -&gt;<span class="st"> </span>cars</a>
<a class="sourceLine" id="cb431-3" title="3">cars</a></code></pre></div>
<pre><code>## # A tibble: 10 x 5
##    X1    names   Car Jocko Other
##    &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 a     X3        1  1375  1250
##  2 a     X4        2  1550  1300
##  3 a     X5        3  1250  1250
##  4 a     X6        4  1300  1200
##  5 a     X7        5   900   950
##  6 b     X3        6  1500  1575
##  7 b     X4        7  1750  1600
##  8 b     X5        8  3600  3300
##  9 b     X6        9  2250  2125
## 10 b     X7       10  2800  2600</code></pre>
<p>This is now tidy: one row for each of the 10 cars, one column containing the repair estimates for each car at each of the two garages, and a column identifying the cars. I think this is best because this is a matched-pairs study, and so you want the two measurements for each individual car in columns next to each other (for <code>t.test</code> with <code>paired=TRUE</code>).</p>
<p>I think it is best to show the whole pipeline here, even though you are making R work a little harder, rather than having to make up a temporary variable name for the output from <code>pivot_longer</code> (that you are never going to look at again after this).</p>
<p>If you thought there were 20 observations, you have a bit more work to do (that you will have to undo later to get the right graph), namely:</p>
<div class="sourceCode" id="cb433"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb433-1" title="1">cars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="kw">c</span>(Jocko, Other), <span class="dt">names_to=</span><span class="st">&quot;garage&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;estimate&quot;</span>) -&gt;<span class="st"> </span>cars1</a>
<a class="sourceLine" id="cb433-2" title="2">cars1</a></code></pre></div>
<pre><code>## # A tibble: 20 x 5
##    X1    names   Car garage estimate
##    &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1 a     X3        1 Jocko      1375
##  2 a     X3        1 Other      1250
##  3 a     X4        2 Jocko      1550
##  4 a     X4        2 Other      1300
##  5 a     X5        3 Jocko      1250
##  6 a     X5        3 Other      1250
##  7 a     X6        4 Jocko      1300
##  8 a     X6        4 Other      1200
##  9 a     X7        5 Jocko       900
## 10 a     X7        5 Other       950
## 11 b     X3        6 Jocko      1500
## 12 b     X3        6 Other      1575
## 13 b     X4        7 Jocko      1750
## 14 b     X4        7 Other      1600
## 15 b     X5        8 Jocko      3600
## 16 b     X5        8 Other      3300
## 17 b     X6        9 Jocko      2250
## 18 b     X6        9 Other      2125
## 19 b     X7       10 Jocko      2800
## 20 b     X7       10 Other      2600</code></pre>
<p>This would be the right thing to do if you had independent observations (that is, <em>20 different</em> cars, and you randomly choose a garage to send each one to). But you can have a car assessed for repair without actually repairing it, so it makes more sense to send each car to both garages, and compare like with like. Compare the kids learning to read; once a child has learned to read, you can’t teach them to read again, so that study had to be done with two independent samples.</p>
<p>Extra: I thought about starting by making the dataframe even wider:</p>
<div class="sourceCode" id="cb435"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb435-1" title="1">cars0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> X3<span class="op">:</span>X7)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 16
##   X1    X3_Car X3_Jocko X3_Other X4_Car X4_Jocko X4_Other X5_Car X5_Jocko X5_Other X6_Car X6_Jocko X6_Other X7_Car X7_Jocko X7_Other
##   &lt;chr&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 a          1     1375     1250      2     1550     1300      3     1250     1250      4     1300     1200      5      900      950
## 2 b          6     1500     1575      7     1750     1600      8     3600     3300      9     2250     2125     10     2800     2600</code></pre>
<p>This is sort of the right thing, but there are repeat columns now, depending on where the data values came from in <code>cars0</code>. What we want to do now is <em>some</em> kind of <code>pivot_longer</code>, creating three columns called <code>Car</code>, <code>Jocko</code>, and <code>Other</code>. If we only had <em>one</em> kind of thing to make longer, this would be a standard <code>pivot_longer</code>. But we have three. There are two “extras” to <code>pivot_longer</code> that will get you to the right place. The first one is to give multiple inputs to <code>names_to</code>, because the column names encode two things: where in the original data frame the value came from (which is now junk to us), and what the value actually represents, which we definitely <em>do</em> want to keep. I don’t have a good name for it, though, so I’ll call it <code>z</code> for now. Note that we need a <code>names_sep</code> that says what the two things in the column names are separated by, the underscore that the <code>pivot_wider</code> put in there:</p>
<div class="sourceCode" id="cb437"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb437-1" title="1">cars0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> X3<span class="op">:</span>X7) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb437-2" title="2"><span class="kw">pivot_longer</span>(<span class="op">-</span>X1, <span class="dt">names_to =</span> <span class="kw">c</span>(<span class="st">&quot;junk&quot;</span>, <span class="st">&quot;z&quot;</span>), <span class="dt">names_sep=</span><span class="st">&quot;_&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 30 x 4
##    X1    junk  z     value
##    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
##  1 a     X3    Car       1
##  2 a     X3    Jocko  1375
##  3 a     X3    Other  1250
##  4 a     X4    Car       2
##  5 a     X4    Jocko  1550
##  6 a     X4    Other  1300
##  7 a     X5    Car       3
##  8 a     X5    Jocko  1250
##  9 a     X5    Other  1250
## 10 a     X6    Car       4
## # … with 20 more rows</code></pre>
<p>This is now exactly what I got by <em>starting</em> with <code>pivot_longer</code>, and so the same <code>pivot_wider</code> that I finished with before will tidy this up:</p>
<div class="sourceCode" id="cb439"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb439-1" title="1">cars0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> X3<span class="op">:</span>X7) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb439-2" title="2"><span class="kw">pivot_longer</span>(<span class="op">-</span>X1, <span class="dt">names_to =</span> <span class="kw">c</span>(<span class="st">&quot;junk&quot;</span>, <span class="st">&quot;z&quot;</span>), <span class="dt">names_sep=</span><span class="st">&quot;_&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb439-3" title="3"><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> z, <span class="dt">values_from =</span> value)</a></code></pre></div>
<pre><code>## # A tibble: 10 x 5
##    X1    junk    Car Jocko Other
##    &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 a     X3        1  1375  1250
##  2 a     X4        2  1550  1300
##  3 a     X5        3  1250  1250
##  4 a     X6        4  1300  1200
##  5 a     X7        5   900   950
##  6 b     X3        6  1500  1575
##  7 b     X4        7  1750  1600
##  8 b     X5        8  3600  3300
##  9 b     X6        9  2250  2125
## 10 b     X7       10  2800  2600</code></pre>
<p>This is now tidy, so you have achieved what you set out to do, but you have not done it the best way, so you should expect to lose a little something.</p>
<p>This kind of longer-then-wider happens often enough that there is an option in <code>pivot_longer</code> to do it in one step. Let’s remind ourselves of where we were:</p>
<div class="sourceCode" id="cb441"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb441-1" title="1">cars0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> X3<span class="op">:</span>X7) </a></code></pre></div>
<pre><code>## # A tibble: 2 x 16
##   X1    X3_Car X3_Jocko X3_Other X4_Car X4_Jocko X4_Other X5_Car X5_Jocko X5_Other X6_Car X6_Jocko X6_Other X7_Car X7_Jocko X7_Other
##   &lt;chr&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 a          1     1375     1250      2     1550     1300      3     1250     1250      4     1300     1200      5      900      950
## 2 b          6     1500     1575      7     1750     1600      8     3600     3300      9     2250     2125     10     2800     2600</code></pre>
<p>The second part of those funky column names needs to become <em>the names of our new columns</em>. To make that happen in one step, you put the special indicator <code>.value</code> in where we had <code>z</code> before:</p>
<div class="sourceCode" id="cb443"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb443-1" title="1">cars0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> X3<span class="op">:</span>X7) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb443-2" title="2"><span class="kw">pivot_longer</span>(<span class="op">-</span>X1, <span class="dt">names_to =</span> <span class="kw">c</span>(<span class="st">&quot;junk&quot;</span>, <span class="st">&quot;.value&quot;</span>), <span class="dt">names_sep=</span><span class="st">&quot;_&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 10 x 5
##    X1    junk    Car Jocko Other
##    &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 a     X3        1  1375  1250
##  2 a     X4        2  1550  1300
##  3 a     X5        3  1250  1250
##  4 a     X6        4  1300  1200
##  5 a     X7        5   900   950
##  6 b     X3        6  1500  1575
##  7 b     X4        7  1750  1600
##  8 b     X5        8  3600  3300
##  9 b     X6        9  2250  2125
## 10 b     X7       10  2800  2600</code></pre>
<p>and as if by magic, we have tidiness. It’s best to discover this and do it in two steps, though by starting with <code>pivot_wider</code> you have made it more difficult for yourself. By starting with <code>pivot_longer</code>, it is a very standard longer-then-wider, and there is nothing extra you have to learn. (The column <code>X1</code> I added to the data so that <code>pivot_wider</code> would work smoothly. See what happens if you remove it with <code>select(-X1)</code> before you start pivoting.)</p>
<p>There is usually a relatively simple way to do these, and if your way is complicated, that is an invitation to try it again a different way. I don’t think there’s a way to do it in <em>one</em> step, though, because those things in <code>X2</code> have to get to column names somehow, and they can only do so by being attached to which original column the values came from.</p>
<p>All of these ideas are <a href="https://tidyr.tidyverse.org/articles/pivot.html">here</a>, which is a dense read, but worth working through to see what is possible. This problem is of the type in “Longer, then wider”.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>Make a suitable graph to assess the comparison of interest, and say briefly what your graph tells you.</li>
</ol>
<p>Solution</p>
<p>You might be tempted to look at <code>cars</code>, see two quantitative variables, and think “scatterplot”:</p>
<div class="sourceCode" id="cb445"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb445-1" title="1"><span class="kw">ggplot</span>(cars, <span class="kw">aes</span>(<span class="dt">x=</span>Jocko, <span class="dt">y=</span>Other)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-245-1.png" width="672" />
This says that a repair that is more expensive at one garage is more expensive at the other as well, which is true, but it’s an answer to the <em>wrong question</em>. We care about whether Jocko’s Garage is more expensive than the other one <em>on the same car</em>. To rescue the scatterplot, you can add the line <span class="math inline">\(y=x\)</span> to the graph and see which side of the line the points are, which you might have to find out how to do:</p>
<div class="sourceCode" id="cb446"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb446-1" title="1"><span class="kw">ggplot</span>(cars, <span class="kw">aes</span>(<span class="dt">x=</span>Jocko, <span class="dt">y=</span>Other)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_abline</span>(<span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">intercept =</span> <span class="dv">0</span>)</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-246-1.png" width="672" /></p>
<p>More of the points are below and to the right of the line, indicating that Jocko’s Garage is typically more expensive (in the cases where the other garage is more expensive, there is not much in it).</p>
<p>There is a more direct approach here, based on the idea that a matched pairs test looks at the differences between the two estimates for each car: work out the differences, and make a <em>one</em>-sample plot of them:</p>
<div class="sourceCode" id="cb447"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb447-1" title="1">cars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">diff=</span>Jocko<span class="op">-</span>Other) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb447-2" title="2"><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>diff)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">4</span>)</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-247-1.png" width="672" />
Most of the differences, this way around, are positive, so the indication is that Jocko’s Garage is indeed more expensive. Don’t have too many bins.</p>
<p>A one-sample boxplot of the differences would also work:</p>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb448-1" title="1">cars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">diff=</span>Jocko<span class="op">-</span>Other) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb448-2" title="2"><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span><span class="dv">1</span>, <span class="dt">y=</span>diff)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-248-1.png" width="672" />
This tells you that at least 75% of the differences are positive.</p>
<p>If you ended up with my <code>cars1</code>:</p>
<div class="sourceCode" id="cb449"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb449-1" title="1">cars1</a></code></pre></div>
<pre><code>## # A tibble: 20 x 5
##    X1    names   Car garage estimate
##    &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1 a     X3        1 Jocko      1375
##  2 a     X3        1 Other      1250
##  3 a     X4        2 Jocko      1550
##  4 a     X4        2 Other      1300
##  5 a     X5        3 Jocko      1250
##  6 a     X5        3 Other      1250
##  7 a     X6        4 Jocko      1300
##  8 a     X6        4 Other      1200
##  9 a     X7        5 Jocko       900
## 10 a     X7        5 Other       950
## 11 b     X3        6 Jocko      1500
## 12 b     X3        6 Other      1575
## 13 b     X4        7 Jocko      1750
## 14 b     X4        7 Other      1600
## 15 b     X5        8 Jocko      3600
## 16 b     X5        8 Other      3300
## 17 b     X6        9 Jocko      2250
## 18 b     X6        9 Other      2125
## 19 b     X7       10 Jocko      2800
## 20 b     X7       10 Other      2600</code></pre>
<p>this is “obviously” a boxplot:</p>
<div class="sourceCode" id="cb451"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb451-1" title="1"><span class="kw">ggplot</span>(cars1, <span class="kw">aes</span>(<span class="dt">x=</span>garage, <span class="dt">y=</span>estimate)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-250-1.png" width="672" />
except that you have not used the fact that each group is measurements on the <em>same</em> 10 cars. Here is a way to rescue that:</p>
<div class="sourceCode" id="cb452"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb452-1" title="1"><span class="kw">ggplot</span>(cars1, <span class="kw">aes</span>(<span class="dt">x=</span>garage, <span class="dt">y=</span>estimate, <span class="dt">group=</span>Car)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-251-1.png" width="672" /></p>
<p>The majority of the lines go downhill, so Jocko’s Garage is more expensive most of the time. (The lines are really another way to look at the differences.) This last graph I would be good with, since it shows which pairs of measurements are related because of being on the same cars.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>Carry out a test to make an appropriate comparison of the mean estimates. What do you conclude, in the context of the data?</li>
</ol>
<p>Solution</p>
<p>Comparing means requires the right flavour of <span class="math inline">\(t\)</span>-test, in this case a matched-pairs one, with a one-sided alternative, since we were concerned that the Jocko estimates were bigger. In a matched pairs test, <code>alternative</code> says how the first column you name compares with the other one. If your columns are the opposite way to mine, your <code>alternative</code> needs to be “less”:</p>
<div class="sourceCode" id="cb453"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb453-1" title="1"><span class="kw">with</span>(cars, <span class="kw">t.test</span>(Jocko, Other, <span class="dt">paired =</span> <span class="ot">TRUE</span>, <span class="dt">alternative =</span> <span class="st">&quot;greater&quot;</span>))</a></code></pre></div>
<pre><code>## 
##  Paired t-test
## 
## data:  Jocko and Other
## t = 2.8749, df = 9, p-value = 0.009164
## alternative hypothesis: true difference in means is greater than 0
## 95 percent confidence interval:
##  40.76811      Inf
## sample estimates:
## mean of the differences 
##                   112.5</code></pre>
<p>Remember that this flavour of <span class="math inline">\(t\)</span>-test doesn’t take a <code>data=</code>, so you need to use <code>with</code> or dollar signs.</p>
<p>The P-value is actually just less than 0.01, so we can definitely conclude that the Jocko estimates are bigger on average.</p>
<p>If you calculated the differences earlier, feel free to use them here:</p>
<div class="sourceCode" id="cb455"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb455-1" title="1">cars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">diff=</span>Jocko<span class="op">-</span>Other) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb455-2" title="2"><span class="kw">with</span>(., <span class="kw">t.test</span>(diff, <span class="dt">mu=</span><span class="dv">0</span>, <span class="dt">alternative =</span> <span class="st">&quot;greater&quot;</span>))</a></code></pre></div>
<pre><code>## 
##  One Sample t-test
## 
## data:  diff
## t = 2.8749, df = 9, p-value = 0.009164
## alternative hypothesis: true mean is greater than 0
## 95 percent confidence interval:
##  40.76811      Inf
## sample estimates:
## mean of x 
##     112.5</code></pre>
<p>Saving the data frame with the differences in it is probably smart.</p>
<p>Again, if you got to <code>cars1</code>, you might think to do this:</p>
<div class="sourceCode" id="cb457"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb457-1" title="1"><span class="kw">t.test</span>(estimate<span class="op">~</span>garage, <span class="dt">data=</span>cars1, <span class="dt">alternative=</span><span class="st">&quot;greater&quot;</span>)</a></code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  estimate by garage
## t = 0.32056, df = 17.798, p-value = 0.3761
## alternative hypothesis: true difference in means is greater than 0
## 95 percent confidence interval:
##  -496.4343       Inf
## sample estimates:
## mean in group Jocko mean in group Other 
##              1827.5              1715.0</code></pre>
<p>but you would be <em>wrong</em>, because the two groups are not independent (they’re the same cars at each garage). You have also lost the significant result, because some of the repairs are more expensive than others (at both garages), and this introduces extra variability that this test does not account for.</p>
<p>I said to compare the means, so I don’t want a sign test here. If you think we should be doing one, you’ll need to make the case for it properly: first, calculate and plot the differences and make the case that they’re not normal enough. I see left-skewness in the histogram of differences, but personally I don’t find this bad enough to worry about. If you do, make that case (but, a sample of size 10 even from a normal distribution might look this skewed) and then run the right test:</p>
<div class="sourceCode" id="cb459"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb459-1" title="1">cars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">diff=</span>Jocko<span class="op">-</span>Other) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb459-2" title="2"><span class="kw">sign_test</span>(diff, <span class="dv">0</span>)</a></code></pre></div>
<pre><code>## $above_below
## below above 
##     2     7 
## 
## $p_values
##   alternative    p_value
## 1       lower 0.98046875
## 2       upper 0.08984375
## 3   two-sided 0.17968750</code></pre>
<p>The upper-tail P-value is the one you want (explain why), and this is not quite significant. This is different from the correct <span class="math inline">\(t\)</span>-test for a couple of reasons: there is probably not much power with this small sample, and the two estimates that are higher at the Other garage are not much higher, which the <span class="math inline">\(t\)</span>-test accounts for but the sign test does not.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="tidying-electricity-consumption-1" class="section level2">
<h2><span class="header-section-number">17.25</span> Tidying electricity consumption</h2>
<p>How does the consumption of electricity depend on temperature? To find out, a short-term study was carried out by a utility company based in a certain area. For a period of two years, the average monthly temperature was recorded (in degrees Fahrenheit), the mean daily demand for electricity per household (in kilowatt hours), and the cost per kilowatt hour of electricity for that year (8 cents for the first year and 10 cents for the second, which it will be easiest to treat as categorical).</p>
<p>The data were laid out in an odd way, as shown in , in aligned columns: the twelve months of temperature were laid out on <em>two</em> lines for the first year, then the twelve months of consumption for the first year on the next two lines, and then four more lines for the second year laid out the same way. Thus the temperature of 31 in the first line goes with the consumption of 55 in the <em>third</em> line, and the last measurements for that year are the 78 at the end of the second line (temperature) and 73 at the end of the fourth line (consumption). Lines 5 through 8 of the data file are the same thing for the second year (when electricity was more expensive).</p>
<p>The data seem to have been laid out in order of temperature, rather than in order of months, which I would have thought would make more sense. But this is what we have.</p>
<ol style="list-style-type: lower-alpha">
<li>Read in and display the data file, bearing in mind that it has <em>no column names</em>.</li>
</ol>
<p>Solution</p>
<p>That means <code>col_names = FALSE</code> when reading in. I gave this a “disposable” name, saving the good name <code>utils</code> for the tidy version:</p>
<div class="sourceCode" id="cb461"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb461-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/utils.txt&quot;</span></a>
<a class="sourceLine" id="cb461-2" title="2">utils0 &lt;-<span class="st"> </span><span class="kw">read_table</span>(my_url, <span class="dt">col_names =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   X1 = col_character(),
##   X2 = col_character(),
##   X3 = col_double(),
##   X4 = col_double(),
##   X5 = col_double(),
##   X6 = col_double(),
##   X7 = col_double(),
##   X8 = col_double()
## )</code></pre>
<div class="sourceCode" id="cb463"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb463-1" title="1">utils0</a></code></pre></div>
<pre><code>## # A tibble: 8 x 8
##   X1      X2             X3    X4    X5    X6    X7    X8
##   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 8cents  temperature    31    34    39    42    47    56
## 2 8cents  temperature    62    66    68    71    75    78
## 3 8cents  consumption    55    49    46    47    40    43
## 4 8cents  consumption    41    46    44    51    62    73
## 5 10cents temperature    32    36    39    42    48    56
## 6 10cents temperature    62    66    68    72    75    79
## 7 10cents consumption    50    44    42    42    36    40
## 8 10cents consumption    39    44    40    44    50    55</code></pre>
<p>The columns have acquired names <code>X1</code> through <code>X8</code>. It doesn’t really matter what these names <em>are</em>, but as we will see shortly, it matters that they <em>have</em> names.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Arrange these data tidily, so that there is a column of price (per kilowatt hour), a column of temperatures, and a column of consumptions. Describe your process, including why you got list-columns (if you did) and what you did about them (if necessary).</li>
</ol>
<p>Solution</p>
<p>This question is asking about your process as well as your answer, so I think it’s best to build a pipeline one step at a time (which corresponds in any case to how you would figure out what to do). The first step seems to be to make longer, for example getting all those numbers in one column. I’m not quite sure what to call the new columns, so I’ll make up some names and figure things out later:</p>
<div class="sourceCode" id="cb465"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb465-1" title="1">utils0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(X3<span class="op">:</span>X8, <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>) </a></code></pre></div>
<pre><code>## # A tibble: 48 x 4
##    X1     X2          col   value
##    &lt;chr&gt;  &lt;chr&gt;       &lt;chr&gt; &lt;dbl&gt;
##  1 8cents temperature X3       31
##  2 8cents temperature X4       34
##  3 8cents temperature X5       39
##  4 8cents temperature X6       42
##  5 8cents temperature X7       47
##  6 8cents temperature X8       56
##  7 8cents temperature X3       62
##  8 8cents temperature X4       66
##  9 8cents temperature X5       68
## 10 8cents temperature X6       71
## # … with 38 more rows</code></pre>
<p>If you scroll down, <code>X2</code> has consumptions as well as temperatures, so we need to get that straightened out.</p>
<p>This, so far, is actually a lot like the weather one in lecture (where we had a max and a min temperature), and the solution is the same: follow up with a <code>pivot_wider</code> to get the temperatures and consumptions in their own columns:</p>
<div class="sourceCode" id="cb467"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb467-1" title="1">utils0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(X3<span class="op">:</span>X8, <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb467-2" title="2"><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> value) </a></code></pre></div>
<pre><code>## Warning: Values are not uniquely identified; output will contain list-cols.
## * Use `values_fn = list` to suppress this warning.
## * Use `values_fn = length` to identify where the duplicates arise
## * Use `values_fn = {summary_fun}` to summarise duplicates</code></pre>
<pre><code>## # A tibble: 12 x 4
##    X1      col   temperature consumption
##    &lt;chr&gt;   &lt;chr&gt; &lt;list&gt;      &lt;list&gt;     
##  1 8cents  X3    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  2 8cents  X4    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  3 8cents  X5    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  4 8cents  X6    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  5 8cents  X7    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  6 8cents  X8    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  7 10cents X3    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  8 10cents X4    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  9 10cents X5    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
## 10 10cents X6    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
## 11 10cents X7    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
## 12 10cents X8    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;</code></pre>
<p>Except that it didn’t appear to work. Although it actually did. These are list-columns. I actually recorded lecture 14a to help you with this. (See also the discussion in Extra 3 of the last part of the writers question, and the word “list” at the top of <code>temperature</code> and <code>consumption</code>). Each cell holds <em>two</em> numbers instead of the one you were probably expecting.</p>
<p>Why did that happen? The warning above the output is a clue. Something is going to be “not uniquely identified”. Think about how <code>pivot_wider</code> works. It has to decide which <em>row</em> and <em>column</em> of the wider dataframe to put each value in. The column comes from the <code>names_from</code>: temperature or consumption. So that’s not a problem. The row comes from the combination of the other columns not named in the <code>pivot_wider</code>: that means the ones called <code>X1</code> and <code>col</code>. (Another way to see that is the columns in the result from the <code>pivot_wider</code> that <em>do not</em> have values in them: not <code>temperature</code> or <code>consumption</code>, the other two.)</p>
<p>If you look back at the things in <code>col</code>, they go from <code>X3</code> to <code>X8</code>, so there are six of them. There are two values in <code>X1</code>, so there are <span class="math inline">\(2 \times 6 = 12\)</span> combinations of the two, and so 12 rows in the wider dataframe. This has two columns, and thus <span class="math inline">\(12 \times 2 = 24\)</span> cells altogether. But there were 48 values in the longer dataframe (go back and look: it has 48 rows), so there isn’t enough room for all of them here.</p>
<p>If you go back and look at the longer dataframe, you’ll see, for example, that there are two <code>temperature</code> values that go with an <code>X1</code> of 8 cents and a col of <code>X3</code>, so that they will both have to be jammed into one cell of the wider dataframe.</p>
<p>The resolution of the list-columns here is the same as in the one about the writers: <code>unnest</code> them, and then you can ignore the warning:</p>
<div class="sourceCode" id="cb470"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb470-1" title="1">utils0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(X3<span class="op">:</span>X8, <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb470-2" title="2"><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb470-3" title="3"><span class="kw">unnest</span>(<span class="kw">c</span>(temperature, consumption)) -&gt;<span class="st"> </span>utils</a></code></pre></div>
<pre><code>## Warning: Values are not uniquely identified; output will contain list-cols.
## * Use `values_fn = list` to suppress this warning.
## * Use `values_fn = length` to identify where the duplicates arise
## * Use `values_fn = {summary_fun}` to summarise duplicates</code></pre>
<div class="sourceCode" id="cb472"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb472-1" title="1">utils</a></code></pre></div>
<pre><code>## # A tibble: 24 x 4
##    X1     col   temperature consumption
##    &lt;chr&gt;  &lt;chr&gt;       &lt;dbl&gt;       &lt;dbl&gt;
##  1 8cents X3             31          55
##  2 8cents X3             62          41
##  3 8cents X4             34          49
##  4 8cents X4             66          46
##  5 8cents X5             39          46
##  6 8cents X5             68          44
##  7 8cents X6             42          47
##  8 8cents X6             71          51
##  9 8cents X7             47          40
## 10 8cents X7             75          62
## # … with 14 more rows</code></pre>
<p>There were 24 months of data, and a temperature and consumption for each, so this is now tidy and I can give it a proper name.</p>
<p>Extra: if you got to here and got scared:</p>
<div class="sourceCode" id="cb474"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb474-1" title="1">utils0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(X3<span class="op">:</span>X8, <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb474-2" title="2"><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> value) </a></code></pre></div>
<pre><code>## Warning: Values are not uniquely identified; output will contain list-cols.
## * Use `values_fn = list` to suppress this warning.
## * Use `values_fn = length` to identify where the duplicates arise
## * Use `values_fn = {summary_fun}` to summarise duplicates</code></pre>
<pre><code>## # A tibble: 12 x 4
##    X1      col   temperature consumption
##    &lt;chr&gt;   &lt;chr&gt; &lt;list&gt;      &lt;list&gt;     
##  1 8cents  X3    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  2 8cents  X4    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  3 8cents  X5    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  4 8cents  X6    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  5 8cents  X7    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  6 8cents  X8    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  7 10cents X3    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  8 10cents X4    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
##  9 10cents X5    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
## 10 10cents X6    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
## 11 10cents X7    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;  
## 12 10cents X8    &lt;dbl [2]&gt;   &lt;dbl [2]&gt;</code></pre>
<p>which is an entirely reasonable reaction, you might have asked yourself how you could have prevented this from happening. The problem, as discussed earlier, is with the rows, and that the <code>X1</code>-<code>col</code> combinations repeat. Let’s go back to “longer”:</p>
<div class="sourceCode" id="cb477"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb477-1" title="1">utils0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(X3<span class="op">:</span>X8, <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>) </a></code></pre></div>
<pre><code>## # A tibble: 48 x 4
##    X1     X2          col   value
##    &lt;chr&gt;  &lt;chr&gt;       &lt;chr&gt; &lt;dbl&gt;
##  1 8cents temperature X3       31
##  2 8cents temperature X4       34
##  3 8cents temperature X5       39
##  4 8cents temperature X6       42
##  5 8cents temperature X7       47
##  6 8cents temperature X8       56
##  7 8cents temperature X3       62
##  8 8cents temperature X4       66
##  9 8cents temperature X5       68
## 10 8cents temperature X6       71
## # … with 38 more rows</code></pre>
<p>Rows 1 and 7, 2 and 8, etc, are “replicates” in that they have the same <code>X1</code> and <code>col</code> values but different temperatures. This is because they come from the same column in the original layout of the data (the 31 and the 62 are underneath each other). This means that the first six rows are “replicate 1” and the next six are “replicate 2”. Scrolling down, we then get to 8 cents and consumption, and we need to do the same again. So if we make a column that has 1s and 2s in the right places (six 1s, six 2s, repeat), we should then have unique rows for the <code>pivot_wider</code>.</p>
<div class="sourceCode" id="cb479"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb479-1" title="1">utils0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(X3<span class="op">:</span>X8, <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb479-2" title="2"><span class="kw">mutate</span>(<span class="dt">replicate =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">each =</span> <span class="dv">6</span>, <span class="dt">length.out =</span> <span class="dv">48</span>))</a></code></pre></div>
<pre><code>## # A tibble: 48 x 5
##    X1     X2          col   value replicate
##    &lt;chr&gt;  &lt;chr&gt;       &lt;chr&gt; &lt;dbl&gt;     &lt;int&gt;
##  1 8cents temperature X3       31         1
##  2 8cents temperature X4       34         1
##  3 8cents temperature X5       39         1
##  4 8cents temperature X6       42         1
##  5 8cents temperature X7       47         1
##  6 8cents temperature X8       56         1
##  7 8cents temperature X3       62         2
##  8 8cents temperature X4       66         2
##  9 8cents temperature X5       68         2
## 10 8cents temperature X6       71         2
## # … with 38 more rows</code></pre>
<p><code>rep</code> does repeats like this: something to repeat (the numbers 1 through 2), how many times to repeat each one (six times), and how long the final thing has to be (48, since there were 48 rows in the longer dataframe).</p>
<p>Then, this time, if we do the <code>pivot_wider</code>, it should give us something tidy:</p>
<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb481-1" title="1">utils0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(X3<span class="op">:</span>X8, <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb481-2" title="2"><span class="kw">mutate</span>(<span class="dt">replicate =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">each =</span> <span class="dv">6</span>, <span class="dt">length.out =</span> <span class="dv">48</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb481-3" title="3"><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> value) </a></code></pre></div>
<pre><code>## # A tibble: 24 x 5
##    X1     col   replicate temperature consumption
##    &lt;chr&gt;  &lt;chr&gt;     &lt;int&gt;       &lt;dbl&gt;       &lt;dbl&gt;
##  1 8cents X3            1          31          55
##  2 8cents X4            1          34          49
##  3 8cents X5            1          39          46
##  4 8cents X6            1          42          47
##  5 8cents X7            1          47          40
##  6 8cents X8            1          56          43
##  7 8cents X3            2          62          41
##  8 8cents X4            2          66          46
##  9 8cents X5            2          68          44
## 10 8cents X6            2          71          51
## # … with 14 more rows</code></pre>
<p>and so it does, with 24 rows for the 24 months.</p>
<p>Another, perhaps easier, way to think about this (you might find it easier, anyway) is to go back to the original dataframe and make the <code>replicate</code> there:</p>
<div class="sourceCode" id="cb483"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb483-1" title="1">utils0</a></code></pre></div>
<pre><code>## # A tibble: 8 x 8
##   X1      X2             X3    X4    X5    X6    X7    X8
##   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 8cents  temperature    31    34    39    42    47    56
## 2 8cents  temperature    62    66    68    71    75    78
## 3 8cents  consumption    55    49    46    47    40    43
## 4 8cents  consumption    41    46    44    51    62    73
## 5 10cents temperature    32    36    39    42    48    56
## 6 10cents temperature    62    66    68    72    75    79
## 7 10cents consumption    50    44    42    42    36    40
## 8 10cents consumption    39    44    40    44    50    55</code></pre>
<p>The first two rows are replicates (both 8 cents and temperature), then the third and fourth, and so on. So setting a <code>replicate</code> column as 1, 2, 1, 2 etc should do it, and this is short enough to type directly. Do this <em>first</em>, then the <code>pivot_longer</code>, then the <code>pivot_wider</code> as we did before, and we should end up with something tidy:</p>
<div class="sourceCode" id="cb485"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb485-1" title="1">utils0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">replicate =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb485-2" title="2"><span class="kw">pivot_longer</span>(X3<span class="op">:</span>X8, <span class="dt">names_to =</span> <span class="st">&quot;col&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb485-3" title="3"><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> X2, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb485-4" title="4"><span class="kw">unnest</span>(<span class="kw">c</span>(temperature, consumption)) </a></code></pre></div>
<pre><code>## # A tibble: 24 x 5
##    X1     replicate col   temperature consumption
##    &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;       &lt;dbl&gt;
##  1 8cents         1 X3             31          55
##  2 8cents         1 X4             34          49
##  3 8cents         1 X5             39          46
##  4 8cents         1 X6             42          47
##  5 8cents         1 X7             47          40
##  6 8cents         1 X8             56          43
##  7 8cents         2 X3             62          41
##  8 8cents         2 X4             66          46
##  9 8cents         2 X5             68          44
## 10 8cents         2 X6             71          51
## # … with 14 more rows</code></pre>
<p>If you check this, you’ll see that <code>replicate</code> gets turned into the same thing in the longer dataframe that we had earlier, so you can do it either way.</p>
<p>The moral of the story is that when you are planning to do a pivot-wider, you ought to devote some attention to which <em>rows</em> things are going into. Sometimes you can get away with just doing it and it works, but thinking about rows is how to diagnose it when it doesn’t. (The ideas below also appear in Lecture 14a.) Here’s another mini-example where the observations are matched pairs but they come to us long, like two-sample data:</p>
<div class="sourceCode" id="cb487"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb487-1" title="1">d &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb487-2" title="2"><span class="op">~</span>obs, <span class="op">~</span>y, <span class="op">~</span>time,</a>
<a class="sourceLine" id="cb487-3" title="3"><span class="dv">1</span>, <span class="dv">10</span>, <span class="st">&quot;pre&quot;</span>,</a>
<a class="sourceLine" id="cb487-4" title="4"><span class="dv">2</span>, <span class="dv">13</span>, <span class="st">&quot;post&quot;</span>,</a>
<a class="sourceLine" id="cb487-5" title="5"><span class="dv">3</span>, <span class="dv">12</span>, <span class="st">&quot;pre&quot;</span>,</a>
<a class="sourceLine" id="cb487-6" title="6"><span class="dv">4</span>, <span class="dv">14</span>, <span class="st">&quot;post&quot;</span>,</a>
<a class="sourceLine" id="cb487-7" title="7"><span class="dv">5</span>, <span class="dv">13</span>, <span class="st">&quot;pre&quot;</span>,</a>
<a class="sourceLine" id="cb487-8" title="8"><span class="dv">6</span>, <span class="dv">15</span>, <span class="st">&quot;post&quot;</span></a>
<a class="sourceLine" id="cb487-9" title="9">)</a>
<a class="sourceLine" id="cb487-10" title="10">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> time, <span class="dt">values_from =</span> y)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##     obs   pre  post
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1    10    NA
## 2     2    NA    13
## 3     3    12    NA
## 4     4    NA    14
## 5     5    13    NA
## 6     6    NA    15</code></pre>
<p>Oh. The columns are all right, but the rows certainly are not.</p>
<p>The problem is that the only thing left after <code>y</code> and <code>time</code> have been used in the <code>pivot_wider</code> is the column <code>obs</code>, and there are six values there, so there are six rows. This is, in a way, the opposite of the problem we had before; now, there is <em>not enough</em> data to fill the twelve cells of the wider dataframe. For example, there is no <code>pre</code> measurement in the row where <code>obs</code> is 2, so this cell of the wider dataframe is empty: it has a missing value in it.</p>
<p>The problem is that the <code>obs</code> column numbered the six observations 1 through 6, but really they are three groups of two observations on three people, so instead of <code>obs</code> we need a column called <code>person</code> that shows which observations are the matched pairs, like this:</p>
<div class="sourceCode" id="cb489"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb489-1" title="1">d &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb489-2" title="2"><span class="op">~</span>person, <span class="op">~</span>y, <span class="op">~</span>time,</a>
<a class="sourceLine" id="cb489-3" title="3"><span class="dv">1</span>, <span class="dv">10</span>, <span class="st">&quot;pre&quot;</span>,</a>
<a class="sourceLine" id="cb489-4" title="4"><span class="dv">1</span>, <span class="dv">13</span>, <span class="st">&quot;post&quot;</span>,</a>
<a class="sourceLine" id="cb489-5" title="5"><span class="dv">2</span>, <span class="dv">12</span>, <span class="st">&quot;pre&quot;</span>,</a>
<a class="sourceLine" id="cb489-6" title="6"><span class="dv">2</span>, <span class="dv">14</span>, <span class="st">&quot;post&quot;</span>,</a>
<a class="sourceLine" id="cb489-7" title="7"><span class="dv">3</span>, <span class="dv">13</span>, <span class="st">&quot;pre&quot;</span>,</a>
<a class="sourceLine" id="cb489-8" title="8"><span class="dv">3</span>, <span class="dv">15</span>, <span class="st">&quot;post&quot;</span></a>
<a class="sourceLine" id="cb489-9" title="9">)</a></code></pre></div>
<p>Now there are going to be three rows with a pre and a post in each:</p>
<div class="sourceCode" id="cb490"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb490-1" title="1">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> time, <span class="dt">values_from =</span> y)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   person   pre  post
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1      1    10    13
## 2      2    12    14
## 3      3    13    15</code></pre>
<p><code>pivot_wider</code> requires more thinking than <code>pivot_longer</code>, and when it does something mysterious, that’s when you need to have some understanding of how it works, so that you can fix things up.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>Make a suitable graph of temperature, consumption and price in your tidy dataframe. Add smooth trends if appropriate. If you were unable to get the data tidy, use my tidy version <a href="http://ritsokiguess.site/datafiles/utils_tidy.csv">here</a>. (If you need the other file, right-click on “here” and Copy Link Address.)</li>
</ol>
<p>Solution</p>
<p>I said earlier to treat price (rather badly labelled as <code>X1</code>) as categorical, so we have two quantitative variables and one categorical. This suggests a scatterplot with the two prices distinguished by colours. (We don’t have a mechanism for making three-dimensional plots, and in any case if you have a quantitative variable with not that many distinct different values, you can often treat that as categorical, such as price here.)</p>
<p>Before we make a graph, though, we should rename <code>X1</code>. The way you might think of is to create a new column with the same values as <code>X1</code>, but a new name.<a href="#fn50" class="footnote-ref" id="fnref50"><sup>50</sup></a> Like this. Consumption is the outcome, so it goes on the <span class="math inline">\(y\)</span>-axis:</p>
<div class="sourceCode" id="cb492"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb492-1" title="1">utils <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb492-2" title="2"><span class="kw">mutate</span>(<span class="dt">price =</span> X1) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb492-3" title="3"><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> temperature, <span class="dt">y =</span> consumption, <span class="dt">colour =</span> price)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb492-4" title="4"><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>()</a></code></pre></div>
<pre><code>## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="pasias_files/figure-html/unnamed-chunk-269-1.png" width="672" /></p>
<p>I said smooth trends rather than lines, because you don’t know until you draw the graph whether the trends <em>are</em> lines. If they’re not, there’s not much point in drawing lines through them. These ones are rather clearly curves, which we take up in the next part.</p>
<p>If you fail to rename <code>X1</code>, that’s what will appear on the legend, and the first thing your reader would ask is “what is <code>X1</code>?” When writing, you need to think of your reader, since they are (in the real world) paying you for your work.</p>
<p>Extra: there is an official <code>rename</code> also. I haven’t used that in class, so if you discover this, make sure to say where you found out about it from:</p>
<div class="sourceCode" id="cb494"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb494-1" title="1">utils <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb494-2" title="2"><span class="kw">rename</span>(<span class="dt">price =</span> X1)</a></code></pre></div>
<pre><code>## # A tibble: 24 x 4
##    price  col   temperature consumption
##    &lt;chr&gt;  &lt;chr&gt;       &lt;dbl&gt;       &lt;dbl&gt;
##  1 8cents X3             31          55
##  2 8cents X3             62          41
##  3 8cents X4             34          49
##  4 8cents X4             66          46
##  5 8cents X5             39          46
##  6 8cents X5             68          44
##  7 8cents X6             42          47
##  8 8cents X6             71          51
##  9 8cents X7             47          40
## 10 8cents X7             75          62
## # … with 14 more rows</code></pre>
<p>The syntax is “new name equals old one”. I used to think it was something like “take the column called <code>X1</code> and rename it to <code>price</code>”, but as you see, that’s exactly backwards. The English-language version is “create a new column called <code>price</code> from the column previously called <code>X1</code>”.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>What patterns or trends do you see on your graph? Do they make practical sense? There are two things I would like you to comment on.</li>
</ol>
<p>Solution</p>
<p>The two things are:</p>
<ul>
<li>the relationships are both curves, going down and then up again.</li>
<li>the blue curve is above the red one.</li>
</ul>
<p>If the temperature is low (30 degrees F is just below freezing), people will need to heat their houses, and the electricity consumption to do this is reflected in the curves being higher at the left. (Not all people have electric heating, but at least some people do, and electric heating uses a lot of electricity.) When the temperature is high, people will turn on the air-conditioning (which is usually electric), and that explains the sharp increase in consumption at high temperatures. In between is the zone where the house stays a good temperature without heating or cooling.</p>
<p>So why is the blue curve above the red one? This is saying that when electricity is cheaper, people will use more of it. (This seems to be particularly true when the temperature is high; people might “crank” the air-conditioning if it doesn’t cost too much to run.) Conversely, if electricity is more expensive, people might be more thoughtful about what temperature to turn on the heating or AC. (For example, in summer you might keep the drapes closed so that it stays cooler inside without needing to use the AC so much.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</div>
<div id="tidy-blood-pressure-1" class="section level2">
<h2><span class="header-section-number">17.26</span> Tidy blood pressure</h2>
<p>Going to the dentist is scary for a lot of people. One way in which this might show up is that people might have higher blood pressure on average before their dentist’s appointment than an hour after the appointment is done. Ten randomly-chosen individuals have their (systolic<a href="#fn51" class="footnote-ref" id="fnref51"><sup>51</sup></a>) blood pressure measured while they are in a dentist’s waiting room, and then again one hour after their appointment is finished.</p>
<p>You might have seen a tidy version of this data set before.</p>
<p>The data as I originally received it is in <a href="http://ritsokiguess.site/datafiles/blood_pressure2.csv">http://ritsokiguess.site/datafiles/blood_pressure2.csv</a>.</p>
<ol style="list-style-type: lower-alpha">
<li>Read in and display the data as originally received.</li>
</ol>
<p>Solution</p>
<p>You ought to be suspicious that something is going to be up with the layout. With that in mind, I’m using a “disposable” name for this dataframe:</p>
<div class="sourceCode" id="cb496"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb496-1" title="1">my_url &lt;-<span class="st"> &quot;http://ritsokiguess.site/datafiles/blood_pressure2.csv&quot;</span></a>
<a class="sourceLine" id="cb496-2" title="2">bp0 &lt;-<span class="st"> </span><span class="kw">read_csv</span>(my_url)</a></code></pre></div>
<pre><code>## 
## ── Column specification ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## cols(
##   time = col_character(),
##   p1 = col_double(),
##   p2 = col_double(),
##   p3 = col_double(),
##   p4 = col_double(),
##   p5 = col_double(),
##   p6 = col_double(),
##   p7 = col_double(),
##   p8 = col_double(),
##   p9 = col_double(),
##   p10 = col_double()
## )</code></pre>
<div class="sourceCode" id="cb498"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb498-1" title="1">bp0</a></code></pre></div>
<pre><code>## # A tibble: 2 x 11
##   time      p1    p2    p3    p4    p5    p6    p7    p8    p9   p10
##   &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 before   132   135   149   133   119   121   128   132   119   110
## 2 after    118   137   140   139   107   116   122   124   115   103</code></pre>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Describe briefly how the data you read in is not tidy, bearing in mind how the data were collected and how they would be analysed.</li>
</ol>
<p>Solution</p>
<p>In short, the things that are rows should be columns, and the things that are columns should be rows. Or, the individuals (people, here) should be in rows but they are in columns. Or, the variables (time points) should be in columns but they are in rows. One of those.</p>
<p>Another way to go at it is to note that the numbers are all blood pressure measurements, and so should be all in one column, labelled by which time and individual they belong to. This is, however, not quite right, for reasons of how the data were collected. They are pairs of measurements on the same individual, and so there should be (for something like a matched pairs <span class="math inline">\(t\)</span>-test) a column of before measurements and a column of after measurements. This will mean some extra work in the next part to get it tidy.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" style="list-style-type: lower-alpha">
<li>Produce a tidy dataframe from the one you read in from the file. (How many rows should you have?)</li>
</ol>
<p>Solution</p>
<p>The usual starting point for these is to get all the measurements into one column and see what to do after that.
This is <code>pivot_longer</code>:</p>
<div class="sourceCode" id="cb500"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb500-1" title="1">bp0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>time, <span class="dt">names_to=</span><span class="st">&quot;person&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;bp&quot;</span>) </a></code></pre></div>
<pre><code>## # A tibble: 20 x 3
##    time   person    bp
##    &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt;
##  1 before p1       132
##  2 before p2       135
##  3 before p3       149
##  4 before p4       133
##  5 before p5       119
##  6 before p6       121
##  7 before p7       128
##  8 before p8       132
##  9 before p9       119
## 10 before p10      110
## 11 after  p1       118
## 12 after  p2       137
## 13 after  p3       140
## 14 after  p4       139
## 15 after  p5       107
## 16 after  p6       116
## 17 after  p7       122
## 18 after  p8       124
## 19 after  p9       115
## 20 after  p10      103</code></pre>
<p>This would be tidy if we had 20 independent observations from 20 different people. But we don’t. We only have 10 people, with two measurements on each, so we should only have 10 rows. Having made things longer, they are now <em>too</em> long, and we have to make it wider again.</p>
<p>We want to have a column of before and a column of after, so the names of the new columns are coming from what I called <code>time</code>. The values are coming from what I called <code>bp</code>, so, gluing the <code>pivot_wider</code> on the end of the pipe:</p>
<div class="sourceCode" id="cb502"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb502-1" title="1">bp0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>time, <span class="dt">names_to=</span><span class="st">&quot;person&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;bp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb502-2" title="2"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> time, <span class="dt">values_from =</span> bp) -&gt;<span class="st"> </span>blood_pressure</a>
<a class="sourceLine" id="cb502-3" title="3">blood_pressure</a></code></pre></div>
<pre><code>## # A tibble: 10 x 3
##    person before after
##    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;
##  1 p1        132   118
##  2 p2        135   137
##  3 p3        149   140
##  4 p4        133   139
##  5 p5        119   107
##  6 p6        121   116
##  7 p7        128   122
##  8 p8        132   124
##  9 p9        119   115
## 10 p10       110   103</code></pre>
<p>This is now tidy, so I gave it a “permanent” name.</p>
<p>I laid out the steps of my thinking, so you could follow my logic. I’m expecting your <em>thinking</em> to be about the same as mine, but the work you hand in can certainly be the finished pipe I had just above, as if you thought of it right away.</p>
<p>Extra: <code>pivot_wider</code> is smarter than you think, but it can be helpful to know what it does, in order to help diagnose when things go wrong. Let’s go back and look at the too-long dataframe again:</p>
<div class="sourceCode" id="cb504"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb504-1" title="1">bp0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>time, <span class="dt">names_to=</span><span class="st">&quot;person&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;bp&quot;</span>) </a></code></pre></div>
<pre><code>## # A tibble: 20 x 3
##    time   person    bp
##    &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt;
##  1 before p1       132
##  2 before p2       135
##  3 before p3       149
##  4 before p4       133
##  5 before p5       119
##  6 before p6       121
##  7 before p7       128
##  8 before p8       132
##  9 before p9       119
## 10 before p10      110
## 11 after  p1       118
## 12 after  p2       137
## 13 after  p3       140
## 14 after  p4       139
## 15 after  p5       107
## 16 after  p6       116
## 17 after  p7       122
## 18 after  p8       124
## 19 after  p9       115
## 20 after  p10      103</code></pre>
<p>Each one of those values in <code>bp</code> has to go somewhere in the wider dataframe. In particular, it needs to go in a particular row and column. The column is pretty obvious: the column whose name is in the <code>time</code> column. But the row is much less obvious. How does <code>pivot_wider</code> figure it out? Well, it looks for all combinations of values in the <em>other</em> columns, the ones not mentioned in the <code>pivot_wider</code>, and makes a row for each of those. In this case, the only other column is <code>person</code>, so it makes one row for each person. Since there is one before and one after measurement for each person, everything works smoothly.</p>
<p>This enables us to try a couple of what-ifs to see what can go wrong.</p>
<p>First, what if there’s no person column at all, so there is nothing to say what row an observation should go in?</p>
<div class="sourceCode" id="cb506"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb506-1" title="1">bp0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>time, <span class="dt">names_to=</span><span class="st">&quot;person&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;bp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb506-2" title="2"><span class="kw">select</span>(<span class="op">-</span>person) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb506-3" title="3"><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> time, <span class="dt">values_from =</span> bp)</a></code></pre></div>
<pre><code>## Warning: Values are not uniquely identified; output will contain list-cols.
## * Use `values_fn = list` to suppress this warning.
## * Use `values_fn = length` to identify where the duplicates arise
## * Use `values_fn = {summary_fun}` to summarise duplicates</code></pre>
<pre><code>## # A tibble: 1 x 2
##   before     after     
##   &lt;list&gt;     &lt;list&gt;    
## 1 &lt;dbl [10]&gt; &lt;dbl [10]&gt;</code></pre>
<p>It kinda works, but with a warning. The warning says “values are not uniquely identified”, which is a posh way to say that it doesn’t know where to put them (because there is no longer a way to say which row each observation should go in).</p>
<p>Here’s another one, similar:</p>
<div class="sourceCode" id="cb509"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb509-1" title="1">d &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb509-2" title="2"><span class="op">~</span>g, <span class="op">~</span>id, <span class="op">~</span>y,</a>
<a class="sourceLine" id="cb509-3" title="3"><span class="st">&quot;a&quot;</span>, <span class="st">&quot;p1&quot;</span>, <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb509-4" title="4"><span class="st">&quot;a&quot;</span>, <span class="st">&quot;p2&quot;</span>, <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb509-5" title="5"><span class="st">&quot;b&quot;</span>, <span class="st">&quot;p1&quot;</span>, <span class="dv">12</span>,</a>
<a class="sourceLine" id="cb509-6" title="6"><span class="st">&quot;b&quot;</span>, <span class="st">&quot;p2&quot;</span>, <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb509-7" title="7"><span class="st">&quot;a&quot;</span>, <span class="st">&quot;p3&quot;</span>, <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb509-8" title="8"><span class="st">&quot;a&quot;</span>, <span class="st">&quot;p1&quot;</span>, <span class="dv">15</span></a>
<a class="sourceLine" id="cb509-9" title="9">)</a>
<a class="sourceLine" id="cb509-10" title="10">d</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   g     id        y
##   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
## 1 a     p1       10
## 2 a     p2       11
## 3 b     p1       12
## 4 b     p2       13
## 5 a     p3       14
## 6 a     p1       15</code></pre>
<p>When we do this:</p>
<div class="sourceCode" id="cb511"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb511-1" title="1">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> g, <span class="dt">values_from =</span> y)</a></code></pre></div>
<pre><code>## Warning: Values are not uniquely identified; output will contain list-cols.
## * Use `values_fn = list` to suppress this warning.
## * Use `values_fn = length` to identify where the duplicates arise
## * Use `values_fn = {summary_fun}` to summarise duplicates</code></pre>
<pre><code>## # A tibble: 3 x 3
##   id    a         b        
##   &lt;chr&gt; &lt;list&gt;    &lt;list&gt;   
## 1 p1    &lt;dbl [2]&gt; &lt;dbl [1]&gt;
## 2 p2    &lt;dbl [1]&gt; &lt;dbl [1]&gt;
## 3 p3    &lt;dbl [1]&gt; &lt;NULL&gt;</code></pre>
<p>we get list-columns again (and the same warning). What this output is telling you is that mostly there is one number per id-group combination (the <code>dbl[1]</code>) but there are two observations labelled id <code>p1</code> and group <code>a</code>, and no observations at all labelled id <code>p3</code> and group <code>b</code>. It turns out^[I know because I made these data up. that the last row of the tribble contains errors. Fix them, and all is good:</p>
<div class="sourceCode" id="cb514"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb514-1" title="1">d &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb514-2" title="2"><span class="op">~</span>g, <span class="op">~</span>id, <span class="op">~</span>y,</a>
<a class="sourceLine" id="cb514-3" title="3"><span class="st">&quot;a&quot;</span>, <span class="st">&quot;p1&quot;</span>, <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb514-4" title="4"><span class="st">&quot;a&quot;</span>, <span class="st">&quot;p2&quot;</span>, <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb514-5" title="5"><span class="st">&quot;b&quot;</span>, <span class="st">&quot;p1&quot;</span>, <span class="dv">12</span>,</a>
<a class="sourceLine" id="cb514-6" title="6"><span class="st">&quot;b&quot;</span>, <span class="st">&quot;p2&quot;</span>, <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb514-7" title="7"><span class="st">&quot;a&quot;</span>, <span class="st">&quot;p3&quot;</span>, <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb514-8" title="8"><span class="st">&quot;b&quot;</span>, <span class="st">&quot;p3&quot;</span>, <span class="dv">15</span></a>
<a class="sourceLine" id="cb514-9" title="9">)</a>
<a class="sourceLine" id="cb514-10" title="10">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> g, <span class="dt">values_from =</span> y)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   id        a     b
##   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 p1       10    12
## 2 p2       11    13
## 3 p3       14    15</code></pre>
<p>One last one:</p>
<div class="sourceCode" id="cb516"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb516-1" title="1">d &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb516-2" title="2"><span class="op">~</span>id, <span class="op">~</span>g, <span class="op">~</span>y,</a>
<a class="sourceLine" id="cb516-3" title="3"><span class="dv">1</span>, <span class="st">&quot;a&quot;</span>, <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb516-4" title="4"><span class="dv">2</span>, <span class="st">&quot;a&quot;</span>, <span class="dv">11</span>,</a>
<a class="sourceLine" id="cb516-5" title="5"><span class="dv">3</span>, <span class="st">&quot;a&quot;</span>, <span class="dv">12</span>,</a>
<a class="sourceLine" id="cb516-6" title="6"><span class="dv">4</span>, <span class="st">&quot;b&quot;</span>, <span class="dv">13</span>,</a>
<a class="sourceLine" id="cb516-7" title="7"><span class="dv">5</span>, <span class="st">&quot;b&quot;</span>, <span class="dv">14</span>,</a>
<a class="sourceLine" id="cb516-8" title="8"><span class="dv">6</span>, <span class="st">&quot;b&quot;</span>, <span class="dv">15</span></a>
<a class="sourceLine" id="cb516-9" title="9">)</a>
<a class="sourceLine" id="cb516-10" title="10">d</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##      id g         y
##   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;
## 1     1 a        10
## 2     2 a        11
## 3     3 a        12
## 4     4 b        13
## 5     5 b        14
## 6     6 b        15</code></pre>
<p>and then</p>
<div class="sourceCode" id="cb518"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb518-1" title="1">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> g, <span class="dt">values_from =</span> y)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##      id     a     b
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1    10    NA
## 2     2    11    NA
## 3     3    12    NA
## 4     4    NA    13
## 5     5    NA    14
## 6     6    NA    15</code></pre>
<p>Where did those missing values come from? If you go back and look at this <code>d</code>, you’ll see that each person has only <em>one</em> measurement, <em>either</em> an <code>a</code> or a <code>b</code>, not both. There is, for example, nothing to go in the <code>a</code> column for person number 4, because their only measurement was in group <code>b</code>. This kind of thing happens with two independent samples, and is a warning that you don’t <em>need</em> to pivot wider; it’s already tidy:</p>
<div class="sourceCode" id="cb520"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb520-1" title="1">d</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##      id g         y
##   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;
## 1     1 a        10
## 2     2 a        11
## 3     3 a        12
## 4     4 b        13
## 5     5 b        14
## 6     6 b        15</code></pre>
<p>Think about the kind of layout you need for a two-sample <span class="math inline">\(t\)</span>-test.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" style="list-style-type: lower-alpha">
<li>What kind of test might you run on these data? Explain briefly.</li>
</ol>
<p>Solution</p>
<p>This is a matched-pairs experiment, so it needs a matched-pairs analysis. This could be a matched-pairs <span class="math inline">\(t\)</span>-test, or a sign test on the differences (testing that the population median difference is zero). You can suggest either, since we haven’t drawn any graphs yet, but “sign test” is not enough; you need to say something about what kind of sign test. (It’s actually quicker to answer “matched-pairs <span class="math inline">\(t\)</span>-test” since you don’t need any more detail than that.)</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" style="list-style-type: lower-alpha">
<li>Draw a suitable graph of these data.</li>
</ol>
<p>Solution</p>
<p>Given that we are going to do a matched-pairs analysis of some kind, the best graph looks at the <em>differences</em> between the two measurements. So calculate them first, and then make a one-sample plot of them, such as a histogram:</p>
<div class="sourceCode" id="cb522"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb522-1" title="1">blood_pressure <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">diff =</span> before <span class="op">-</span><span class="st"> </span>after) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb522-2" title="2"><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>diff)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">bins=</span><span class="dv">5</span>)</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-282-1.png" width="672" />
You will need a suitably small number of bins, since we only have ten observations. You can take the differences the other way around if you prefer; they will then be mostly negative.</p>
<p>You might have looked at the two quantitative columns and thought “scatterplot”:</p>
<div class="sourceCode" id="cb523"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb523-1" title="1"><span class="kw">ggplot</span>(blood_pressure, <span class="kw">aes</span>(<span class="dt">x=</span>before, <span class="dt">y=</span>after)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-283-1.png" width="672" />
This says that if the blood pressure before was large, the blood pressure afterwards is as well. This is fair enough, but it is the answer to a question <em>we don’t care about</em>. What we <em>do</em> care about is whether the after measurement is bigger than the before one <em>for the same person</em>, which this graph does not show. So this is not the best.</p>
<p>To rescue this graph, you can add the line <span class="math inline">\(y=x\)</span> to it. The value of this is that a point above this line has the after measurement bigger than the corresponding before one, and a point below the line has the after measurement smaller. You will need to find out how to add a line with a given intercept and slope to the plot, since I haven’t shown you how to do it. It’s called <code>geom_abline</code>, thus:</p>
<div class="sourceCode" id="cb524"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb524-1" title="1"><span class="kw">ggplot</span>(blood_pressure, <span class="kw">aes</span>(<span class="dt">x=</span>before, <span class="dt">y=</span>after)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb524-2" title="2"><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-284-1.png" width="672" />
This is insightful, because most of the points are below the line, so that most of the before measurements were bigger than the corresponding after ones.</p>
<p>Note that if you put a <em>regression line</em> on your plot, you will need to offer a convincing explanation of why that offers insight, which I think you will find difficult.</p>
<p>Finally, if you thought the long data frame was tidy, this one:</p>
<div class="sourceCode" id="cb525"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb525-1" title="1">bp0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>time, <span class="dt">names_to=</span><span class="st">&quot;person&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;bp&quot;</span>) </a></code></pre></div>
<pre><code>## # A tibble: 20 x 3
##    time   person    bp
##    &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt;
##  1 before p1       132
##  2 before p2       135
##  3 before p3       149
##  4 before p4       133
##  5 before p5       119
##  6 before p6       121
##  7 before p7       128
##  8 before p8       132
##  9 before p9       119
## 10 before p10      110
## 11 after  p1       118
## 12 after  p2       137
## 13 after  p3       140
## 14 after  p4       139
## 15 after  p5       107
## 16 after  p6       116
## 17 after  p7       122
## 18 after  p8       124
## 19 after  p9       115
## 20 after  p10      103</code></pre>
<p>then you can rescue some points here by making a suitable plot of that. A boxplot is not enough:</p>
<div class="sourceCode" id="cb527"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb527-1" title="1">bp0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>time, <span class="dt">names_to=</span><span class="st">&quot;person&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;bp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb527-2" title="2"><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>time, <span class="dt">y=</span>bp)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-286-1.png" width="672" /></p>
<p>because you have <em>lost</em> the connection between the two measurements for each person. To keep that connection, start with the same plot but as points rather than boxes:</p>
<div class="sourceCode" id="cb528"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb528-1" title="1">bp0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>time, <span class="dt">names_to=</span><span class="st">&quot;person&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;bp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb528-2" title="2"><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>time, <span class="dt">y=</span>bp)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-287-1.png" width="672" />
and then join the two points that belong to the same person. This is done with <code>geom_line</code> as usual, only you have to say which points are going to be joined, namely the two for each person, and to do that, you specify <code>person</code> in <code>group</code>:</p>
<div class="sourceCode" id="cb529"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb529-1" title="1">bp0 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>time, <span class="dt">names_to=</span><span class="st">&quot;person&quot;</span>, <span class="dt">values_to=</span><span class="st">&quot;bp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb529-2" title="2"><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>time, <span class="dt">y=</span>bp, <span class="dt">group=</span>person)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="pasias_files/figure-html/unnamed-chunk-288-1.png" width="672" />
Most of the lines are going uphill, so most of the <code>after</code> measurements are less than the corresponding <code>before</code> ones.<a href="#fn52" class="footnote-ref" id="fnref52"><sup>52</sup></a></p>
<p><span class="math inline">\(\blacksquare\)</span></p>

</div>
</div>
<div class="footnotes">
<hr />
<ol start="22">
<li id="fn22"><p>You can try it without. See below.<a href="tidying-data.html#fnref22" class="footnote-back">↩</a></p></li>
<li id="fn23"><p>You could just as well make the point that the text 20.8 contains the number 20.8 and nothing else, so that parsing it as text in search of a number will pull out 20.8 as a number. If that logic works for you, go with it.<a href="tidying-data.html#fnref23" class="footnote-back">↩</a></p></li>
<li id="fn24"><p>Oh, what a giveaway.<a href="tidying-data.html#fnref24" class="footnote-back">↩</a></p></li>
<li id="fn25"><p>Unlike <em>thunderstorm watch</em> and <em>thunderstorm warning</em>, which mean different things.<a href="tidying-data.html#fnref25" class="footnote-back">↩</a></p></li>
<li id="fn26"><p>Evidently the units were chosen for ease of recording; had the values been in grams instead, the person recording the data would have had to put a 0 and a decimal point on the front of each value. This is the old meaning of the word coding; making the data values be whole numbers and/or small deviations from something makes them easier to record, and in pre-computer days easier to calculate with. You will also see the same word used for classifying survey responses into categories, which is similar but not quite the same thing.<a href="tidying-data.html#fnref26" class="footnote-back">↩</a></p></li>
<li id="fn27"><p>A blood pressure is usually given as two numbers, like “120 over 80”. The first number, which is the one shown in our data, is called the systolic blood pressure. It is the pressure in the arteries when the heart is pumping. The second is called the diastolic blood pressure, and it is the pressure in the arteries when the heart is resting.<a href="tidying-data.html#fnref27" class="footnote-back">↩</a></p></li>
<li id="fn28"><p>You can try it without. See below.<a href="tidying-data.html#fnref28" class="footnote-back">↩</a></p></li>
<li id="fn29"><p>Sometimes the column playing the role of <code>rep</code> <em>is</em> interesting to us, but not here.<a href="tidying-data.html#fnref29" class="footnote-back">↩</a></p></li>
<li id="fn30"><p>To allow for the fact that measurements on the same subject are not independent but correlated.<a href="tidying-data.html#fnref30" class="footnote-back">↩</a></p></li>
<li id="fn31"><p>And then thrown away.<a href="tidying-data.html#fnref31" class="footnote-back">↩</a></p></li>
<li id="fn32"><p>It needs <code>print</code> around it to display it, as you need <code>print</code> to display something within a loop or a function.<a href="tidying-data.html#fnref32" class="footnote-back">↩</a></p></li>
<li id="fn33"><p>This talks about <em>means</em> rather than individual observations; in individual cases, sometimes even drug <em>A</em> will come out best. But we’re interested in population means, since we want to do the greatest good for the greatest number. “Greatest good for the greatest number” is from Jeremy Bentham, 1748–1832, British philosopher and advocate of utilitarianism.<a href="tidying-data.html#fnref33" class="footnote-back">↩</a></p></li>
<li id="fn34"><p>As <code>str_c</code> or <code>paste</code> do, actually, but the advantage of <code>unite</code> is that it gets rid of the other columns, which you probably no longer need.<a href="tidying-data.html#fnref34" class="footnote-back">↩</a></p></li>
<li id="fn35"><p>You could just as well make the point that the text 20.8 contains the number 20.8 and nothing else, so that parsing it as text in search of a number will pull out 20.8 as a number. If that logic works for you, go with it.<a href="tidying-data.html#fnref35" class="footnote-back">↩</a></p></li>
<li id="fn36"><p>You might think that missing is just missing, but R distinguishes between types of missing.<a href="tidying-data.html#fnref36" class="footnote-back">↩</a></p></li>
<li id="fn37"><p>Which was the title of a song by Prince.<a href="tidying-data.html#fnref37" class="footnote-back">↩</a></p></li>
<li id="fn38"><p>As, for example, when Prince died.<a href="tidying-data.html#fnref38" class="footnote-back">↩</a></p></li>
<li id="fn39"><p>Oh, what a giveaway.<a href="tidying-data.html#fnref39" class="footnote-back">↩</a></p></li>
<li id="fn40"><p>In some languages it is called <code>switch</code>. Python appears not to have it. What you do there instead is to use a Python dictionary to pick out the value you want.<a href="tidying-data.html#fnref40" class="footnote-back">↩</a></p></li>
<li id="fn41"><p>If I was helping you, and you were struggling with <em>ifelse</em> but finally mastered it, it seemed easier to suggest that you used it again for the others.<a href="tidying-data.html#fnref41" class="footnote-back">↩</a></p></li>
<li id="fn42"><p>But I didn’t want to complicate this question any farther.<a href="tidying-data.html#fnref42" class="footnote-back">↩</a></p></li>
<li id="fn43"><p>Unlike <em>thunderstorm watch</em> and <em>thunderstorm warning</em>, which mean different things.<a href="tidying-data.html#fnref43" class="footnote-back">↩</a></p></li>
<li id="fn44"><p>I did not know until just now that you could put two variables in a count and you get counts of all the combinations of them. Just goes to show the value of “try it and see”.<a href="tidying-data.html#fnref44" class="footnote-back">↩</a></p></li>
<li id="fn45"><p>This is the same kind of thing as a “dictionary” in Python.<a href="tidying-data.html#fnref45" class="footnote-back">↩</a></p></li>
<li id="fn46"><p>Evidently the units were chosen for ease of recording; had the values been in grams instead, the person recording the data would have had to put a 0 and a decimal point on the front of each value. This is the old meaning of the word coding; making the data values be whole numbers and/or small deviations from something makes them easier to record, and in pre-computer days easier to calculate with. You will also see the same word used for classifying survey responses into categories, which is similar but not quite the same thing.<a href="tidying-data.html#fnref46" class="footnote-back">↩</a></p></li>
<li id="fn47"><p>It shouldn’t be, but it often is.<a href="tidying-data.html#fnref47" class="footnote-back">↩</a></p></li>
<li id="fn48"><p>Data tidying has a lot of this kind of thing: try something, see that it doesn’t work, figure out what went wrong, fix that, repeat. The work you hand in, or show to your boss, won’t necessarily look very much like your actual process.<a href="tidying-data.html#fnref48" class="footnote-back">↩</a></p></li>
<li id="fn49"><p>This is the opposite way to the usual: when two tests disagree, it is usually the one with fewer assumptions that is preferred, but in this case, the Welch ANOVA is fine, and the median test fails to give significance because it is not using the data as efficiently.<a href="tidying-data.html#fnref49" class="footnote-back">↩</a></p></li>
<li id="fn50"><p>This actually creates a copy of the original column, so if you look you now have two columns with the same thing in them, one with a bad name and one with a good one.<a href="tidying-data.html#fnref50" class="footnote-back">↩</a></p></li>
<li id="fn51"><p>A blood pressure is usually given as two numbers, like “120 over 80”. The first number, which is the one shown in our data, is called the systolic blood pressure. It is the pressure in the arteries when the heart is pumping. The second is called the diastolic blood pressure, and it is the pressure in the arteries when the heart is resting.<a href="tidying-data.html#fnref51" class="footnote-back">↩</a></p></li>
<li id="fn52"><p>This is known in the trade as a <em>spaghetti plot</em> because the lines resemble strands of spaghetti.<a href="tidying-data.html#fnref52" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="a-comparison-of-four-shampoos-in-treating-dandruff.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="simple-regression.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["pasias.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
